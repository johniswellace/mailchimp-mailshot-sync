"use strict";var pluginFactory=function(r){return{v2Client:r,context:null,defaultState:"loading_screen",resources:{pvt_APP_LOCATION_TICKET:"ticket_sidebar",pvt_APP_LOCATION_USER:"user_sidebar",FIELD_TYPE_TEXT:"text",FIELD_TYPE_IMAGE:"image",FIELD_TYPE_CHECKBOX:"checkbox",USER_FIELD_NAME_CUSTOMER_TYPE:"mailshot_customer_type",USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_NOT_SET:null,USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_EXCLUDE:"mailshot_exclude_from_mailshot",USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_DEFAULT:"mailshot_use_default_values",USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_ORGANIZATION:"mailshot_use_organisation_values",TEMPLATE_NAME_MAIN:"./templates/main.hdbs",TEMPLATE_NAME_MAIN_MODAL_MODE:"./templates/sync-modal.hdbs",TEMPLATE_ID_LOADING:"loading-screen-template",TEMPLATE_NAME_SHOWERROR:"./templates/show_error.hdbs",SETTINGS_HELPER_SPREADSHEET_DOWNLOAD_URL:"https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/raw/master/extras/ZenchimpSettingsGenerator.xlsx"},events:{"ticket.requester.id.changed":"resetAppIfPageFullyLoaded","user.email.changed":"resetAppIfPageFullyLoaded","user.id.changed":"resetAppIfPageFullyLoaded","user.name.changed":"resetAppIfPageFullyLoaded","user.organizations.changed":"resetAppIfPageFullyLoaded","createOrUpadateMailChimpListMember.done":"createOrUpadateMailChimpListMember_Done","createOrUpadateMailChimpListMember.fail":"get_or_createOrUpadateMailChimpListMember_OnFail","user.mailshot_customer_type.changed":"userScreenCustomerTypeFieldChanged","*.changed":"formFieldChanged"},requests:{parentPlugin:null,getZendeskUser:function(e){return{url:"https://upnrunning.zendesk.com/api/v2/users/"+encodeURIComponent(e)+".json",type:"GET",dataType:"json"}},updateZendeskUser:function(e){return{url:"/api/v2/users/create_or_update.json",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({user:{id:e.id,email:e.email,user_fields:{mailshot_customer_type:e.customer_type}}})}},getZendeskOrganizations:function(e,i){return{url:null!=i?"/api/v2/organizations/"+encodeURIComponent(i)+".json":"/api/v2/users/"+encodeURIComponent(e)+".organizations.json",type:"GET",dataType:"json"}},getMailChimpListMember:function(e){if(null==e)return console.error("ERROR CONDITION: getMailChimpListMember called with null email address");var i=md5(e.toLowerCase());return{url:"https://"+encodeURIComponent(this.parentPlugin.mailchimp_datacentre_prefix)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.parentPlugin.mailchimp_list_id)+"/members/"+encodeURIComponent(i),type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.parentPlugin.mailchimp_api_key)}}},createOrUpadateMailChimpListMember:function(e,i){if(null===e||null==e.email_address)return console.warn("ERROR CONDITION: createOrUpadateMailChimpListMember called with either null user or user with no email address");var s=md5(e.email_address.toLowerCase()),t={id:s,email_address:e.email_address,email_type:"html",status:e.status,status_if_new:"subscribed",merge_fields:{},vip:e.customer_type===this.parentPlugin.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_ORGANIZATION};t.merge_fields[this.parentPlugin.mailchimp_merge_field_forename]=e.forename,t.merge_fields[this.parentPlugin.mailchimp_merge_field_surname]=e.surname,t.merge_fields[this.parentPlugin.mailchimp_list_field_customer_type_name]=e.customer_type;for(var r=0;r<e.extra_merge_fields.length;r++)t.merge_fields[e.extra_merge_fields[r].field_def.mailchimp_field]=e.extra_merge_fields[r].value;return{url:"https://"+encodeURIComponent(this.parentPlugin.mailchimp_datacentre_prefix)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.parentPlugin.mailchimp_list_id)+"/members/"+encodeURIComponent(i?s:""),type:i?"PUT":"POST",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.parentPlugin.mailchimp_api_key)},data:JSON.stringify(t)}},deleteMailChimpListMember:function(e){if(null===e||null===e.email_address)return console.error("ERROR CONDITION: deleteMailChimpListMember called with either null user or user with no email address");var i=md5(e.email_address.toLowerCase());return{url:"https://"+encodeURIComponent(this.parentPlugin.mailchimp_datacentre_prefix)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.parentPlugin.mailchimp_list_id)+"/members/"+encodeURIComponent(i),type:"DELETE",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.parentPlugin.mailchimp_api_key)}}}},syncButtonFromModalOnClick:function(){return this.syncExistingUserToMailchimp(this.zendesk_user,!0),!1},init:function(e,i){var s=this;(this.requests.parentPlugin=this).modalMode=null!=e&&e,this.zendeskObjectsModule={ZendeskOrganization:ZendeskOrganization,ZendeskUser:ZendeskUser},this.parseNamesModule=NameParse,this.mailshot_sync_user=null,this.zendesk_user=null,this.context=void 0===i?null:i,this.settings_fetched=!1,this.zendesk_user=null,this.isFullyInitialized=!1,null===this.context&&this.v2Client.context().then(function(e){s.context=e,s.hideFieldsIfInUserLocation(),s.resetAppIfPageFullyLoaded()},function(e){s.switchToErrorMessage(e,"Could not get app context, please check your internet connection and try again")}),this.v2Client.metadata().then(function(e){s.mailchimp_api_key=e.settings.mailchimp_api_key,s.mailchimp_datacentre_prefix=e.settings.mailchimp_datacentre_prefix,s.mailchimp_list_id=e.settings.mailchimp_list_id,s.mailchimp_merge_field_forename=e.settings.mailchimp_merge_field_forename,s.mailchimp_merge_field_surname=e.settings.mailchimp_merge_field_surname,s.mailchimp_list_field_customer_type_name=e.settings.mailchimp_merge_field_customer_type,s.mailchimp_list_field_customer_type_default_value=e.settings.mailchimp_merge_field_customer_type_default_val,s.mailchimp_organisation_button_label=e.settings.mailchimp_organisation_button_label,s.mailchimp_standard_button_label=e.settings.mailchimp_standard_button_label,s.customer_type_field_mapping={zendesk_field:"mailshot_customer_display_name",mailchimp_field:s.mailchimp_list_field_customer_type_name,type:s.resources.FIELD_TYPE_TEXT,default_value:s.mailchimp_list_field_customer_type_default_value},s.organization_field_mappings=s.validateFieldMappingsJSON(e.settings.mailchimp_organization_field_mappings,"Organisation Field Mapping",!1),s.user_field_mappings=s.validateFieldMappingsJSON(e.settings.mailchimp_user_field_mappings,"User Field Mapping",!1),s.mailshot_only_field_mappings=s.validateFieldMappingsJSON(e.settings.mailchimp_mailshot_only_field_mappings,"Mailchimp Only Field Mapping",!0),null!==s.organization_field_mappings&&null!==s.user_field_mappings&&null!==s.mailshot_only_field_mappings&&(s.settings_fetched=!0,s.resetAppIfPageFullyLoaded())},function(e){s.switchToErrorMessage(e,"Could not get your app settings, please check your internet connection and try again")})},resetAppIfPageFullyLoaded:function(){var i=this;!this.isFullyInitialized&&null===this.context||!this.isFullyInitialized&&!this.settings_fetched||(this.isFullyInitialized||this.context.location!==this.resources.pvt_APP_LOCATION_TICKET||null!==this.zendesk_user?(this.isFullyInitialized||this.context.location!==this.resources.pvt_APP_LOCATION_USER||null!==this.user().id()&&null!==this.user().email()&&null!==this.user().name())&&(this.mailshot_sync_user=null,this.context.location===this.resources.pvt_APP_LOCATION_TICKET?(this.switchToLoadingScreen("Loading Ticket Requester..."),makeAjaxCall(this,this.requests.getZendeskUser(this.zendesk_user.id),this.getZendeskUser_Done,this.switchToErrorMessage)):this.context.location===this.resources.pvt_APP_LOCATION_USER&&(this.switchToLoadingScreen("Loading Zendesk User..."),this.getUserFromFrameworkInUserSidebarLocation()),this.isFullyInitialized=!0):this.v2Client.get("ticket.requester").then(function(e){i.zendesk_user=e["ticket.requester"],i.resetAppIfPageFullyLoaded()},function(e){i.switchToErrorMessage(e,"Could not get the ticket info, please check your internet connection and try again")}))},hideFieldsIfInUserLocation:function(){this.context.location===this.resources.pvt_APP_LOCATION_USER&&_.each([this.resources.USER_FIELD_NAME_CUSTOMER_TYPE],function(e){var i=this.userFields(e);i&&i.isVisible()&&i.hide()},this)},formFieldChanged:function(e){var i=null;if(this.context.location===this.resources.pvt_APP_LOCATION_USER)for(var s=e.propertyName,t=0;t<this.user_field_mappings.length;t++)if(s==="user."+this.user_field_mappings[t].zendesk_field){i=this.user_field_mappings[t].zendesk_field;break}null!==i&&void 0!==this.zendesk_user&&null!==this.zendesk_user&&(this.zendesk_user.findExtraFieldByName(i,!0).value=e.newValue,this.switchToMainTemplate())},userScreenCustomerTypeFieldChanged:function(){var e=this.zendesk_user.customer_type,i=this.user().customField(this.resources.USER_FIELD_NAME_CUSTOMER_TYPE);this.changeCustomerType(e,i)},mailchimpOnlyField_OnClick:function(e){for(var i=null,s=0;s<this.mailshot_sync_user.extra_merge_fields.length;s++)void 0===(i=this.mailshot_sync_user.extra_merge_fields[s]).field_def.zendesk_field&&"MC_ONLY_"+i.field_def.mailchimp_field===e.target.id&&(i.field_def.type===this.resources.FIELD_TYPE_CHECKBOX?i.value=null===i.value||!1===i.value||"0"===i.value||0===i.value||""===i.value||"NO"===i.value.toString().toUpperCase()||"FALSE"===i.value.toString().toUpperCase()?"1":"0":console.error("Unsupported field type '%s' (only 'checkbox' supported) on mailchimp extra merge field: %o"+i.type,i));this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.requests.createOrUpadateMailChimpListMember(this.mailshot_sync_user,!0),this.createOrUpadateMailChimpListMember_Done,this.get_or_createOrUpadateMailChimpListMember_OnFail)},excludeButtonOnClick:function(){var e;return this.context.location===this.resources.pvt_APP_LOCATION_USER?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.resources.USER_FIELD_NAME_CUSTOMER_TYPE,this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_EXCLUDE)):((e=this.zendesk_user.clone()).customer_type=this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_EXCLUDE,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.requests.updateZendeskUser(e),this.updateZendeskUser_Done,this.switchToErrorMessage)),!1},organizationButtonOnClick:function(){var e;return this.context.location===this.resources.pvt_APP_LOCATION_USER?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.resources.USER_FIELD_NAME_CUSTOMER_TYPE,this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_ORGANIZATION)):((e=this.zendesk_user.clone()).customer_type=this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_ORGANIZATION,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.requests.updateZendeskUser(e),this.updateZendeskUser_Done,this.switchToErrorMessage)),!1},standardButtonOnClick:function(){var e;return this.context.location===this.resources.pvt_APP_LOCATION_USER?(this.switchToLoadingScreen("Updating Zendesk User..."),this.user().customField(this.resources.USER_FIELD_NAME_CUSTOMER_TYPE,this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_DEFAULT)):((e=this.zendesk_user.clone()).customer_type=this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_DEFAULT,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.requests.updateZendeskUser(e),this.updateZendeskUser_Done,this.switchToErrorMessage)),!1},getZendeskUser_Done:function(e){this.zendesk_user=this.createZendeskUserFromAPIReturnData(e),this.zendesk_user.isOrganization()&&this.zendesk_user.belongsToOrganization()?(this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.requests.getZendeskOrganizations(this.zendesk_user.id,this.zendesk_user.organization_id),this.getZendeskOrganizations_Done,this.switchToErrorMessage)):this.fetchMailchimpObjectIfNecessary(),this.zendesk_user=this.createZendeskUserFromAPIReturnData(e)},createZendeskUserFromAPIReturnData:function(e){var i=null;return null!==e?(i=new this.zendeskObjectsModule.ZendeskUser(this,e.user.id,e.user.name,e.user.email,e.user.user_fields.mailshot_customer_type,void 0!==e.user.organization_id&&null!==e.user.organization_id?e.user.organization_id:null)).populateExtraFieldsFromUserAPIData(e.user):console.error("createZendeskUserFromAPIReturnData called but userObjectFromDataAPI = null - this should never happen!"),i},getUserFromFrameworkInUserSidebarLocation:function(){var e=void 0!==this.user().organizations()[0]&&null!==this.user().organizations()[0]?this.user().organizations()[0]:null;this.zendesk_user=new this.zendeskObjectsModule.ZendeskUser(this,this.user().id(),this.user().name(),this.user().email(),this.user().customField(this.resources.USER_FIELD_NAME_CUSTOMER_TYPE),null===e?null:e.id()),this.zendesk_user.populateExtraFieldsFromFrameworkUserObject(this.user()),null!==e&&(this.zendesk_user.orgObject=new this.zendeskObjectsModule.ZendeskOrganization(this,e.id(),e.name(),e.customField(this.customer_type_field_mapping.zendesk_field)),this.zendesk_user.orgObject.populateExtraFieldsFromFrameworkOrgObject(e)),this.fetchMailchimpObjectIfNecessary()},updateZendeskUser_Done:function(e){var i=this.createZendeskUserFromAPIReturnData(e);i.orgObject=this.zendesk_user.orgObject;var s=this.zendesk_user.customer_type;this.zendesk_user=i,this.zendesk_user.isOrganization()&&this.zendesk_user.belongsToOrganization()&&!this.zendesk_user.orgObjectIsPopulated()?(this.zendesk_user.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null===s?"NOTSET":s,this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.requests.getZendeskOrganizations(this.zendesk_user.id,this.zendesk_user.organization_id),this.getZendeskOrganizations_Done,this.switchToErrorMessage)):this.changeCustomerType(s,this.zendesk_user.customer_type)},getZendeskOrganizations_Done:function(e){var i;this.zendesk_user.orgObject=this.createZendeskOrganizationFromAPIReturnData(e),void 0!==this.zendesk_user.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs&&null!==this.zendesk_user.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?(i="NOTSET"===this.zendesk_user.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?null:this.zendesk_user.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs,this.zendesk_user.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null,this.changeCustomerType(i,this.zendesk_user.customer_type)):this.fetchMailchimpObjectIfNecessary()},createZendeskOrganizationFromAPIReturnData:function(e){var i=null;return null!=e&&void 0!==e.organization&&null!==e.organization?(i=new this.zendeskObjectsModule.ZendeskOrganization(this,e.organization.id,e.organization.name,e.organization.organization_fields[this.customer_type_field_mapping.zendesk_field])).populateExtraFieldsFromOrganizationAPIData(e.organization):console.warn("createZendeskOrganizationFromAPIReturnData called but organizationObjectFromDataAPI = null or doesnt contain a organization property - this should never happen!"),i},fetchMailchimpObjectIfNecessary:function(){this.zendesk_user.isIncluded()&&null===this.mailshot_sync_user?(this.switchToLoadingScreen("Loading user from Mailchimp..."),makeAjaxCall(this,this.requests.getMailChimpListMember(this.zendesk_user.email,this),this.retrievedMailchimpSubscriber,this.get_or_createOrUpadateMailChimpListMember_OnFail)):this.switchToMainTemplate()},changeCustomerType:function(e,i){(this.zendesk_user.customer_type=i)!==this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_NOT_SET&&i!==this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_EXCLUDE||(e!==this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_DEFAULT&&e!==this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_ORGANIZATION||this.deleteExistingUserFromMailchimp(this.mailshot_sync_user),this.switchToMainTemplate()),i!==this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_ORGANIZATION&&i!==this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_USE_DEFAULT||(e===this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_EXCLUDE||e===this.resources.USER_FIELD_NAME_CUSTOMER_TYPE_VALUE_NOT_SET?this.syncNewUserToMailchimp(this.zendesk_user):e!==i?this.syncExistingUserToMailchimp(this.zendesk_user,!0):this.switchToMainTemplate())},retrievedMailchimpSubscriber:function(e){this.mailshot_sync_user={email_address:e.email_address,status:"subscribed",forename:e.merge_fields[this.mailchimp_merge_field_forename],surname:e.merge_fields[this.mailchimp_merge_field_surname],customer_type:e.merge_fields[this.customer_type_field_mapping.mailchimp_field],extra_merge_fields:[]};for(var i=0,s=0;s<this.user_field_mappings.length;s++)this.mailshot_sync_user.extra_merge_fields[i]={field_def:this.user_field_mappings[s],value:e.merge_fields[this.user_field_mappings[s].mailchimp_field]},i++;for(var t=0;t<this.organization_field_mappings.length;t++)this.mailshot_sync_user.extra_merge_fields[i]={field_def:this.organization_field_mappings[t],value:e.merge_fields[this.organization_field_mappings[t].mailchimp_field]},i++;for(var r=0;r<this.mailshot_only_field_mappings.length;r++)this.mailshot_sync_user.extra_merge_fields[i]={field_def:this.mailshot_only_field_mappings[r],value:e.merge_fields[this.mailshot_only_field_mappings[r].mailchimp_field]},i++;this.switchToMainTemplate()},syncNewUserToMailchimp:function(e){var i=this.createNewMailchimpSyncUserObject(e);this.switchToLoadingScreen("Adding Mailchimp Member..."),makeAjaxCall(this,this.requests.createOrUpadateMailChimpListMember(i,!1),this.createOrUpadateMailChimpListMember_Done,this.get_or_createOrUpadateMailChimpListMember_OnFail)},syncExistingUserToMailchimp:function(e,i){var s=this.createNewMailchimpSyncUserObject(e);if(void 0!==i&&!0===i&&null!==this.mailshot_sync_user&&e.email===this.mailshot_sync_user.email_address)for(var t=0;t<this.mailshot_sync_user.extra_merge_fields.length;t++)void 0===this.mailshot_sync_user.extra_merge_fields[t].field_def.zendesk_field&&(s.extra_merge_fields[t].value=this.mailshot_sync_user.extra_merge_fields[t].value);this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.requests.createOrUpadateMailChimpListMember(s,!0),this.createOrUpadateMailChimpListMember_Done,this.get_or_createOrUpadateMailChimpListMember_OnFail)},deleteExistingUserFromMailchimp:function(e){this.switchToLoadingScreen("Deleting Mailchimp Member..."),makeAjaxCall(this,this.requests.deleteMailChimpListMember(e),null,null,!0)},get_or_createOrUpadateMailChimpListMember_OnFail:function(i){var e=!1;try{var s=JSON.parse(i.responseText);400===i.status&&"Member Exists"===s.title&&(this.switchToErrorMessage(i,this.zendesk_user.email+" already exists in mailchimp.<br /><br/>Do you want to override his/her details?","Override","error_override_mailchimp","createOrUpadateMailChimpListMember_Override_OnClick()"),e=!0),404===i.status&&(this.switchToErrorMessage(i,this.zendesk_user.email+" doesn't exist in mailchimp.<br /><br/>Do you want to create a new record for him/her?","Create New","error_create_new_mailchimp","createOrUpadateMailChimpListMember_Add_New_OnClick()"),e=!0)}catch(e){console.warn("Could not JSON Parse errorResponse.responseText from get_or_createOrUpadateMailChimpListMember. errorResponse = %o\n\nparse exception: %o",i,e)}e||this.switchToErrorMessage(i)},createOrUpadateMailChimpListMember_Override_OnClick:function(){return this.syncExistingUserToMailchimp(this.zendesk_user),!1},createOrUpadateMailChimpListMember_Add_New_OnClick:function(){return this.syncNewUserToMailchimp(this.zendesk_user),!1},createOrUpadateMailChimpListMember_Done:function(e){this.retrievedMailchimpSubscriber(e)},createNewMailchimpSyncUserObject:function(e){var i=e.isDefault();if(null===e)return console.warn("createNewMailchimpSyncUserObject called with null zendeskSyncUserObject"),null;if(!i&&null===e.orgObject)return console.warn("createNewMailchimpSyncUserObject called with customer type "+e.customer_type+" and  null zendeskSyncUserObject.orgObject"),null;for(var s={email_address:e.email,status:"subscribed",forename:e.getForeName(),surname:e.getSurname(),customer_type:e.getMailchimpCustomerType(),extra_merge_fields:[]},t=0,r=0;r<e.extra_user_fields.length;r++)s.extra_merge_fields[t]={field_def:e.extra_user_fields[r].field_def,value:null===e.extra_user_fields[r].value?"":e.extra_user_fields[r].value},t++;for(var n=0;n<this.organization_field_mappings.length;n++)s.extra_merge_fields[t]={field_def:this.organization_field_mappings[n],value:i?this.organization_field_mappings[n].default_value:e.orgObject.extra_org_fields[n].value},t++;for(var a=0;a<this.mailshot_only_field_mappings.length;a++)s.extra_merge_fields[t]={field_def:this.mailshot_only_field_mappings[a],value:this.mailshot_only_field_mappings[a].default_value},t++;return s},switchToLoadingScreen:function(e){switchToInlineTemplate(this.resources.TEMPLATE_ID_LOADING,{optional_message:e})},switchToMainTemplate:function(){var e=this.zendesk_user.getFieldSyncInfo(this.mailshot_sync_user),i=this.zendesk_user.isInSync(e),s=" "+(i||this.zendesk_user.isExcluded()?"btn-primary":"btn-danger"),t={zendesk_user:this.zendesk_user,mailchimp_user:this.mailshot_sync_user,sync_fields:e,monkey_URL:this.zendesk_user.isExcluded()?"./img/exclude_monkey.png":i?"./img/insync_monkey.png":"./img/outofsync_monkey.png",buttons:{exclude:{show:!0,classNameInsert:this.zendesk_user.isExcluded()?" active":"",label:"Exclude",onclick:"excludeButtonOnClick()"},organization:{show:this.zendesk_user.belongsToOrganization(),classNameInsert:s+(this.zendesk_user.isOrganization()?" active":""),label:this.mailchimp_organisation_button_label,onclick:"organizationButtonOnClick()"},standard:{show:!0,classNameInsert:s+(this.zendesk_user.isDefault()?" active":""),label:this.mailchimp_standard_button_label,onclick:"standardButtonOnClick()"}},display_params:{customer_type_not_set:this.zendesk_user.isNotset(),customer_type_exclude:this.zendesk_user.isExcluded(),customer_type_included:this.zendesk_user.isIncluded(),customer_type_organization:this.zendesk_user.isOrganization(),customer_type_standard:this.zendesk_user.isDefault(),user_in_sync:i,DEBUG:debug_mode}};r.main_template_form_data=t,switchToHdbsFileTemplate(this.modalMode?this.resources.TEMPLATE_NAME_MAIN_MODAL_MODE:this.resources.TEMPLATE_NAME_MAIN,t)},switchToErrorMessage:function(e,i,s,t,r){try{(0===e.status&&void 0===i||null===i||"error"===i)&&(i="Could not connect to API, Please check your internet connection")}catch(e){}var n={errorResponse:e,overrideMessage:void 0===i||"error"===i?null:i,additionalButtonText:void 0===s?null:s,additionalButtonHandle:void 0===t?null:t,additionalButtonOnclick:void 0===r?null:r};switchToHdbsFileTemplate(this.resources.TEMPLATE_NAME_SHOWERROR,n)},debugButtonOnClick:function(){return console.log("Starting debugButtonOnClick"),console.dir(this),!1},validateFieldMappingsJSON:function(i,s,e){var t=null,r=null,n=null;try{t=JSON.parse(i)}catch(e){var a="unknown";a=e instanceof SyntaxError?e.name+" "+e.message:e.message,console.error("JSON Validation for settings '%s' Falied with exception e = %o ",s,e),console.error("JSON TEXT WAS: %o ",i),r=e,n="The JSON Settings text you entered for the "+s+" setting was formatted incorrectly, it must be valid JSON.<br /><br />The failure reason was: "+a+'<br /><br />For help with these settings fields use our <a target="_blank" href="'+this.resources.SETTINGS_HELPER_SPREADSHEET_DOWNLOAD_URL+'">Zenchimp App Settings Generator</a> in Microsoft Excel'}if(null!==t){for(var l=null,o=e?["checkbox"]:["image","text","checkbox"],_=[],d=0;d<t.length;d++)if((l=t[d]).field_label||_.push("Missing Field/Value: field_label"),l.mailchimp_field||_.push("Missing Field/Value: mailchimp_field"),l.type?o.includes(l.type)||_.push("Invalid type: '"+l.type+"'. Valid types are: "+o.toString()+" (all lower case)"):_.push("Missing Field/Value: type"),void 0!==l.default_value&&null!==l.default_value||_.push("Missing Field: default_value"),e&&void 0!==l.zendesk_field&&_.push("Field: zendesk_field is not allowed on mailchimp-only field lists"),e||l.zendesk_field||_.push("Missing Field/Value: zendesk_field"),0<_.length){n="Field Definition "+(d+1)+" for the '"+s+"' setting has errors:<br /><br />"+_.join("<br />");break}if(null===n)return t}this.switchToErrorMessage(r,n)}}};