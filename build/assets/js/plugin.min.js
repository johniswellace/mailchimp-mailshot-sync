"use strict";var pluginFactory=function(n){return{e:n,t:null,i:{s:"ticket_sidebar",n:"user_sidebar",a:"text",r:"image",l:"checkbox",h:"mailshot_customer_type",o:"mailshot_customer_display_name",_:null,c:"mailshot_exclude_from_mailshot",u:"mailshot_use_default_values",d:"mailshot_use_organisation_values",m:"./templates/main.hdbs",p:"./templates/sync-modal.hdbs",f:"loading-screen-template",g:"./templates/show_error.hdbs",O:"https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/raw/master/extras/ZenchimpSettingsGenerator.xlsx"},T:{"ticket.requester.id.changed":"resetAppIfPageFullyLoaded","user.email.changed":"resetAppIfPageFullyLoaded","user.id.changed":"resetAppIfPageFullyLoaded","user.name.changed":"resetAppIfPageFullyLoaded","user.organizations.changed":"resetAppIfPageFullyLoaded","user.mailshot_customer_type.changed":"__userScreenCustomerTypeFieldChanged","*.changed":"__formFieldChanged"},y:{v:null,C:function(e){return{url:"https://upnrunning.zendesk.com/api/v2/users/"+encodeURIComponent(e)+".json",type:"GET",dataType:"json"}},b:function(e){return{url:"/api/v2/users/create_or_update.json",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({user:{id:e.id,email:e.email,user_fields:{mailshot_customer_type:e.customer_type}}})}},M:function(e,t){return{url:null!=t?"/api/v2/organizations/"+encodeURIComponent(t)+".json":"/api/v2/users/"+encodeURIComponent(e)+".organizations.json",type:"GET",dataType:"json"}},U:function(e){if(null==e)return console.error("ERROR CONDITION: __getMailChimpListMember called with null email address");var t=md5(e.toLowerCase());return{url:"https://"+encodeURIComponent(this.v.A.k)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.v.A.I)+"/members/"+encodeURIComponent(t),type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.v.A.S)}}},R:function(e,t){if(null===e||null===e.email_address)return console.warn("ERROR CONDITION: __createOrUpadateMailChimpListMember called with either null user or user with no email address");var i=md5(e.email_address.toLowerCase()),s={};s[this.v.A.L]=e.forename,s[this.v.A.N]=e.surname,s[this.v.A.F]=e.customer_type;for(var n=0;n<e.extra_merge_fields.length;n++)s[e.extra_merge_fields[n].field_def.mailchimp_field]=e.extra_merge_fields[n].value;var a={id:i,email_address:e.email_address,email_type:"html",status:e.P,status_if_new:"subscribed",merge_fields:s,vip:e.customer_type===this.v.i.d};return{url:"https://"+encodeURIComponent(this.v.A.k)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.v.A.I)+"/members/"+encodeURIComponent(t?i:""),type:t?"PUT":"POST",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.v.A.S)},data:JSON.stringify(a)}},x:function(e){if(null===e||null===e.email_address)return console.error("ERROR CONDITION: __deleteMailChimpListMember called with either null user or user with no email address");var t=md5(e.email_address.toLowerCase());return{url:"https://"+encodeURIComponent(this.v.A.k)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.v.A.I)+"/members/"+encodeURIComponent(t),type:"DELETE",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.v.A.S)}}}},init:function(e,t){var i=this,s=this.i;this.resources={TYPE_TEXT:s.a,TYPE_IMAGE:s.r,TYPE_CHECKBOX:s.l,CUSTOMER_TYPE_NOT_SET:s._,CUSTOMER_TYPE_EXCLUDE:s.c,CUSTOMER_TYPE_USE_DEFAULT:s.u,CUSTOMER_TYPE_USE_ORGANIZATION:s.d},(this.y.v=this).w=null!=e&&e,this.zendeskObjectsModule={ZendeskOrganization:ZendeskOrganization,ZendeskUser:ZendeskUser},this.parseNamesModule=NameParse,this.j=null,this.D=null,this.z=!1,this.t=void 0===t?null:t,null===this.t&&this.e.context().then(function(e){i.t=e,i.Z(),i.resetAppIfPageFullyLoaded()},function(e){i.B(e,"Could not get app __context, please check your internet connection and try again")}),this.Y=!1,this.A={},this.G={},this.e.metadata().then(function(e){var t=e.settings;i.A={S:t.mailchimp_api_key,k:t.mailchimp_datacentre_prefix,I:t.mailchimp_list_id,L:t.mailchimp_merge_field_forename,N:t.mailchimp_merge_field_surname,F:t.mailchimp_merge_field_customer_type,H:t.mailchimp_merge_field_customer_type_default_val,J:t.mailchimp_organisation_button_label,X:t.mailchimp_standard_button_label},i.G={V:{zendesk_field:i.i.o,mailchimp_field:i.A.F,type:i.i.q,default_value:i.A.H},K:i.W(t.mailchimp_organization_field_mappings,"Organisation Field Mapping",!1),Q:i.W(t.mailchimp_user_field_mappings,"User Field Mapping",!1),$:i.W(t.mailchimp_mailshot_only_field_mappings,"Mailchimp Only Field Mapping",!0)},i.field_maps={cust_type:i.G.V,organisation:i.G.K,user:i.G.Q,mc_only:i.G.$},null!==i.G.K&&null!==i.G.Q&&null!==i.G.$&&(i.Y=!0,i.resetAppIfPageFullyLoaded())},function(e){i.B(e,"Could not get your app settings, please check your internet connection and try again")})},resetAppIfPageFullyLoaded:function(){var t=this;!this.z&&null===this.t||!this.z&&!this.Y||(this.z||this.t.location!==this.i.s||null!==this.D?(this.z||this.t.location!==this.i.n||null!==this.user().id()&&null!==this.user().email()&&null!==this.user().name())&&(this.j=null,this.t.location===this.i.s?(this.switchToLoadingScreen("Loading Ticket Requester..."),makeAjaxCall(this,this.y.C(this.D.id),this.ee,this.B)):this.t.location===this.i.n&&(this.switchToLoadingScreen("Loading Zendesk User..."),this.getUserFromFrameworkInUserSidebarLocation()),this.z=!0):this.e.get("ticket.requester").then(function(e){t.D=e["ticket.requester"],t.resetAppIfPageFullyLoaded()},function(e){t.B(e,"Could not get the ticket info, please check your internet connection and try again")}))},Z:function(){this.t.location===this.i.n&&_.each([this.i.h],function(e){var t=this.userFields(e);t&&t.isVisible()&&t.hide()},this)},te:function(e){var t=null;if(this.t.location===this.i.n)for(var i=e.propertyName,s=0;s<this.G.Q.length;s++)if(i==="user."+this.G.Q[s].zendesk_field){t=this.G.Q[s].zendesk_field;break}null!==t&&void 0!==this.D&&null!==this.D&&(this.D.findExtraFieldByName(t,!0).value=e.newValue,this.switchToMainTemplate())},ie:function(){var e=this.D.customer_type,t=this.user().customField(this.i.h);this.se(e,t)},syncButtonFromModalOnClick:function(){return this.ne(this.D,!0),!1},mailchimpOnlyField_OnClick:function(e){for(var t=null,i=0;i<this.j.extra_merge_fields.length;i++)void 0===(t=this.j.extra_merge_fields[i]).field_def.zendesk_field&&"MC_ONLY_"+t.field_def.mailchimp_field===e.target.id&&(t.field_def.type===this.i.l?t.value=null===t.value||!1===t.value||"0"===t.value||0===t.value||""===t.value||"NO"===t.value.toString().toUpperCase()||"FALSE"===t.value.toString().toUpperCase()?"1":"0":console.error("Unsupported field type '%s' (only 'checkbox' supported) on mailchimp extra merge field: %o"+t.type,t));this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.y.R(this.j,!0),this.ae,this.re)},excludeButtonOnClick:function(){var e;return this.t.location===this.i.n?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.i.h,this.i.c)):((e=this.D.clone()).customer_type=this.i.c,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.y.b(e),this.le,this.B)),!1},organizationButtonOnClick:function(){var e;return this.t.location===this.i.n?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.i.h,this.i.d)):((e=this.D.clone()).customer_type=this.i.d,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.y.b(e),this.le,this.B)),!1},standardButtonOnClick:function(){var e;return this.t.location===this.i.n?(this.switchToLoadingScreen("Updating Zendesk User..."),this.user().customField(this.i.h,this.i.u)):((e=this.D.clone()).customer_type=this.i.u,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.y.b(e),this.le,this.B)),!1},ee:function(e){this.D=this.he(e),this.D.isOrganization()&&this.D.belongsToOrganization()?(this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.y.M(this.D.id,this.D.organization_id),this.oe,this.B)):this.fetchMailchimpObjectIfNecessary(),this.D=this.he(e)},he:function(e){var t=null;return null!==e?(t=new this.zendeskObjectsModule.ZendeskUser(this,e.user.id,e.user.name,e.user.email,e.user.user_fields.mailshot_customer_type,void 0!==e.user.organization_id&&null!==e.user.organization_id?e.user.organization_id:null)).populateExtraFieldsFromUserAPIData(e.user):console.error("__createZendeskUserFromAPIReturnData called but userObjectFromDataAPI = null - this should never happen!"),t},le:function(e){var t=this.he(e);t.orgObject=this.D.orgObject;var i=this.D.customer_type;this.D=t,this.D.isOrganization()&&this.D.belongsToOrganization()&&!this.D.orgObjectIsPopulated()?(this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null===i?"NOTSET":i,this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.y.M(this.D.id,this.D.organization_id),this.oe,this.B)):this.se(i,this.D.customer_type)},oe:function(e){var t;this.D.orgObject=this.createZendeskOrganizationFromAPIReturnData(e),void 0!==this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs&&null!==this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?(t="NOTSET"===this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?null:this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs,this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null,this.se(t,this.D.customer_type)):this.fetchMailchimpObjectIfNecessary()},createZendeskOrganizationFromAPIReturnData:function(e){var t=null;return null!=e&&void 0!==e.organization&&null!==e.organization?(t=new this.zendeskObjectsModule.ZendeskOrganization(this,e.organization.id,e.organization.name,e.organization.organization_fields[this.G.V.zendesk_field])).populateExtraFieldsFromOrganizationAPIData(e.organization):console.warn("createZendeskOrganizationFromAPIReturnData called but organizationObjectFromDataAPI = null or doesnt contain a organization property - this should never happen!"),t},getUserFromFrameworkInUserSidebarLocation:function(){var e=void 0!==this.user().organizations()[0]&&null!==this.user().organizations()[0]?this.user().organizations()[0]:null;this.D=new this.zendeskObjectsModule.ZendeskUser(this,this.user().id(),this.user().name(),this.user().email(),this.user().customField(this.i.h),null===e?null:e.id()),this.D.populateExtraFieldsFromFrameworkUserObject(this.user()),null!==e&&(this.D.orgObject=new this.zendeskObjectsModule.ZendeskOrganization(this,e.id(),e.name(),e.customField(this.G.V.zendesk_field)),this.D.orgObject.populateExtraFieldsFromFrameworkOrgObject(e)),this.fetchMailchimpObjectIfNecessary()},fetchMailchimpObjectIfNecessary:function(){this.D.isIncluded()&&null===this.j?(this.switchToLoadingScreen("Loading user from Mailchimp..."),makeAjaxCall(this,this.y.U(this.D.email,this),this.retrievedMailchimpSubscriber,this.re)):this.switchToMainTemplate()},se:function(e,t){(this.D.customer_type=t)!==this.i._&&t!==this.i.c||(e!==this.i.u&&e!==this.i.d||this.deleteExistingUserFromMailchimp(this.j),this.switchToMainTemplate()),t!==this.i.d&&t!==this.i.u||(e===this.i.c||e===this.i._?this.syncNewUserToMailchimp(this.D):e!==t?this.ne(this.D,!0):this.switchToMainTemplate())},retrievedMailchimpSubscriber:function(e){this.j={email_address:e.email_address,status:"subscribed",forename:e.merge_fields[this.A.L],surname:e.merge_fields[this.A.N],customer_type:e.merge_fields[this.G.V.mailchimp_field],extra_merge_fields:[]};for(var t=0,i=0;i<this.G.Q.length;i++)this.j.extra_merge_fields[t]={field_def:this.G.Q[i],value:e.merge_fields[this.G.Q[i].mailchimp_field]},t++;for(var s=0;s<this.G.K.length;s++)this.j.extra_merge_fields[t]={field_def:this.G.K[s],value:e.merge_fields[this.G.K[s].mailchimp_field]},t++;for(var n=0;n<this.G.$.length;n++)this.j.extra_merge_fields[t]={field_def:this.G.$[n],value:e.merge_fields[this.G.$[n].mailchimp_field]},t++;this.switchToMainTemplate()},syncNewUserToMailchimp:function(e){var t=this.createNewMailchimpSyncUserObject(e);this.switchToLoadingScreen("Adding Mailchimp Member..."),makeAjaxCall(this,this.y.R(t,!1),this.ae,this.re)},ne:function(e,t){var i=this.createNewMailchimpSyncUserObject(e);if(void 0!==t&&!0===t&&null!==this.j&&e.email===this.j.email_address)for(var s=0;s<this.j.extra_merge_fields.length;s++)void 0===this.j.extra_merge_fields[s].field_def.zendesk_field&&(i.extra_merge_fields[s].value=this.j.extra_merge_fields[s].value);this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.y.R(i,!0),this.ae,this.re)},deleteExistingUserFromMailchimp:function(e){this.switchToLoadingScreen("Deleting Mailchimp Member..."),makeAjaxCall(this,this.y.x(e),null,null,!0)},re:function(t){var e=!1;try{var i=JSON.parse(t.responseText);400===t.status&&"Member Exists"===i.title&&(this.B(t,this.D.email+" already exists in mailchimp.<br /><br/>Do you want to override his/her details?","Override","error_override_mailchimp","__createOrUpadateMailChimpListMember_Override_OnClick()"),e=!0),404===t.status&&(this.B(t,this.D.email+" doesn't exist in mailchimp.<br /><br/>Do you want to create a new record for him/her?","Create New","error_create_new_mailchimp","__createOrUpadateMailChimpListMember_Add_New_OnClick()"),e=!0)}catch(e){console.warn("Could not JSON Parse errorResponse.responseText from get_or___createOrUpadateMailChimpListMember. errorResponse = %o\n\nparse exception: %o",t,e)}e||this.B(t)},_e:function(){return this.ne(this.D),!1},ce:function(){return this.syncNewUserToMailchimp(this.D),!1},ae:function(e){this.retrievedMailchimpSubscriber(e)},createNewMailchimpSyncUserObject:function(e){var t=e.isDefault();if(null===e)return console.warn("createNewMailchimpSyncUserObject called with null zendeskSyncUserObject"),null;if(!t&&null===e.orgObject)return console.warn("createNewMailchimpSyncUserObject called with customer type "+e.customer_type+" and  null zendeskSyncUserObject.orgObject"),null;for(var i={email_address:e.email,P:"subscribed",forename:e.getForeName(),surname:e.getSurname(),customer_type:e.getMailchimpCustomerType(),extra_merge_fields:[]},s=0,n=0;n<e.extra_user_fields.length;n++)i.extra_merge_fields[s]={field_def:e.extra_user_fields[n].field_def,value:null===e.extra_user_fields[n].value?"":e.extra_user_fields[n].value},s++;for(var a=0;a<this.G.K.length;a++)i.extra_merge_fields[s]={field_def:this.G.K[a],value:t?this.G.K[a].default_value:e.orgObject.extra_org_fields[a].value},s++;for(var r=0;r<this.G.$.length;r++)i.extra_merge_fields[s]={field_def:this.G.$[r],value:this.G.$[r].default_value},s++;return i},switchToLoadingScreen:function(e){switchToInlineTemplate(this.i.f,{optional_message:e})},switchToMainTemplate:function(){var e=this.D.getFieldSyncInfo(this.j),t=this.D.isInSync(e),i=" "+(t||this.D.isExcluded()?"btn-primary":"btn-danger"),s={zendesk_user:this.D,mailchimp_user:this.j,sync_fields:e,monkey_URL:this.D.isExcluded()?"./img/exclude_monkey.png":t?"./img/insync_monkey.png":"./img/outofsync_monkey.png",buttons:{exclude:{show:!0,classNameInsert:this.D.isExcluded()?" active":"",label:"Exclude",onclick:"excludeButtonOnClick()"},organization:{show:this.D.belongsToOrganization(),classNameInsert:i+(this.D.isOrganization()?" active":""),label:this.A.J,onclick:"organizationButtonOnClick()"},standard:{show:!0,classNameInsert:i+(this.D.isDefault()?" active":""),label:this.A.X,onclick:"standardButtonOnClick()"}},display_params:{customer_type_not_set:this.D.isNotset(),customer_type_exclude:this.D.isExcluded(),customer_type_included:this.D.isIncluded(),customer_type_organization:this.D.isOrganization(),customer_type_standard:this.D.isDefault(),user_in_sync:t,DEBUG:debug_mode}};n.main_template_form_data=s,switchToHdbsFileTemplate(this.w?this.i.p:this.i.m,s)},B:function(e,t,i,s,n){try{(0===e.status&&void 0===t||null===t||"error"===t)&&(t="Could not connect to API, Please check your internet connection")}catch(e){}var a={errorResponse:e,overrideMessage:void 0===t||"error"===t?null:t,additionalButtonText:void 0===i?null:i,additionalButtonHandle:void 0===s?null:s,additionalButtonOnclick:void 0===n?null:n};switchToHdbsFileTemplate(this.i.g,a)},debugButtonOnClick:function(){return console.log("Starting debugButtonOnClick"),console.dir(this),!1},W:function(t,i,e){var s=null,n=null,a=null;try{s=JSON.parse(t)}catch(e){var r="unknown";r=e instanceof SyntaxError?e.name+" "+e.message:e.message,console.error("JSON Validation for settings '%s' Falied with exception e = %o ",i,e),console.error("JSON TEXT WAS: %o ",t),n=e,a="The JSON Settings text you entered for the "+i+" setting was formatted incorrectly, it must be valid JSON.<br /><br />The failure reason was: "+r+'<br /><br />For help with these settings fields use our <a target="_blank" href="'+this.i.O+'">Zenchimp App Settings Generator</a> in Microsoft Excel'}if(null!==s){for(var l=null,h=e?["checkbox"]:["image","text","checkbox"],o=[],_=0;_<s.length;_++)if((l=s[_]).field_label||o.push("Missing Field/Value: field_label"),l.mailchimp_field||o.push("Missing Field/Value: mailchimp_field"),l.type?h.includes(l.type)||o.push("Invalid type: '"+l.type+"'. Valid types are: "+h.toString()+" (all lower case)"):o.push("Missing Field/Value: type"),void 0!==l.default_value&&null!==l.default_value||o.push("Missing Field: default_value"),e&&void 0!==l.zendesk_field&&o.push("Field: zendesk_field is not allowed on mailchimp-only field lists"),e||l.zendesk_field||o.push("Missing Field/Value: zendesk_field"),0<o.length){a="Field Definition "+(_+1)+" for the '"+i+"' setting has errors:<br /><br />"+o.join("<br />");break}if(null===a)return s}this.B(n,a)}}};