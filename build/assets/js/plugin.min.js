"use strict";var pluginFactory=function(n){return{e:n,t:null,i:{s:"ticket_sidebar",n:"user_sidebar",a:"text",r:"image",l:"checkbox",h:"mailshot_customer_type",o:"mailshot_customer_display_name",c:null,u:"mailshot_exclude_from_mailshot",d:"mailshot_use_default_values",p:"mailshot_use_organisation_values",_:"./templates/main.hdbs",m:"./templates/sync-modal.hdbs",v:"loading-screen-template",f:"./templates/show_error.hdbs",g:"https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/raw/master/extras/ZenchimpSettingsGenerator.xlsx"},O:{"ticket.requester.id.changed":"resetAppIfPageFullyLoaded","user.email.changed":"resetAppIfPageFullyLoaded","user.id.changed":"resetAppIfPageFullyLoaded","user.name.changed":"resetAppIfPageFullyLoaded","user.organizations.changed":"resetAppIfPageFullyLoaded",T:"private_createOrUpadateMailChimpListMember_Done",C:"private_get_or_createOrUpadateMailChimpListMember_OnFail","user.mailshot_customer_type.changed":"private_userScreenCustomerTypeFieldChanged","*.changed":"private_formFieldChanged"},M:{y:null,U:function(e){return{url:"https://upnrunning.zendesk.com/api/v2/users/"+encodeURIComponent(e)+".json",type:"GET",dataType:"json"}},b:function(e){return{url:"/api/v2/users/create_or_update.json",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({user:{id:e.id,email:e.email,user_fields:{mailshot_customer_type:e.customer_type}}})}},k:function(e,t){return{url:null!=t?"/api/v2/organizations/"+encodeURIComponent(t)+".json":"/api/v2/users/"+encodeURIComponent(e)+".organizations.json",type:"GET",dataType:"json"}},A:function(e){if(null==e)return console.error("ERROR CONDITION: private_getMailChimpListMember called with null email address");var t=md5(e.toLowerCase());return{url:"https://"+encodeURIComponent(this.y.S.I)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.y.S.L)+"/members/"+encodeURIComponent(t),type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.y.S.R)}}},N:function(e,t){if(null===e||null===e.email_address)return console.warn("ERROR CONDITION: private_createOrUpadateMailChimpListMember called with either null user or user with no email address");var i=md5(e.email_address.toLowerCase()),s={};s[this.y.S.F]=e.forename,s[this.y.S.P]=e.surname,s[this.y.S.x]=e.customer_type;for(var n=0;n<e.extra_merge_fields.length;n++)s[e.extra_merge_fields[n].field_def.mailchimp_field]=e.extra_merge_fields[n].value;var a={id:i,email_address:e.email_address,email_type:"html",status:e.w,status_if_new:"subscribed",merge_fields:s,vip:e.customer_type===this.y.i.p};return{url:"https://"+encodeURIComponent(this.y.S.I)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.y.S.L)+"/members/"+encodeURIComponent(t?i:""),type:t?"PUT":"POST",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.y.S.R)},data:JSON.stringify(a)}},D:function(e){if(null===e||null===e.email_address)return console.error("ERROR CONDITION: private_deleteMailChimpListMember called with either null user or user with no email address");var t=md5(e.email_address.toLowerCase());return{url:"https://"+encodeURIComponent(this.y.S.I)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.y.S.L)+"/members/"+encodeURIComponent(t),type:"DELETE",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.y.S.R)}}}},init:function(e,t){var i=this,s=this.i;this.resources={TYPE_TEXT:s.a,TYPE_IMAGE:s.r,TYPE_CHECKBOX:s.l,CUSTOMER_TYPE_NOT_SET:s.c,CUSTOMER_TYPE_EXCLUDE:s.u,CUSTOMER_TYPE_USE_DEFAULT:s.d,CUSTOMER_TYPE_USE_ORGANIZATION:s.p},(this.M.y=this).modalMode=null!=e&&e,this.zendeskObjectsModule={ZendeskOrganization:ZendeskOrganization,ZendeskUser:ZendeskUser},this.parseNamesModule=NameParse,this.j=null,this.z=null,this.Z=!1,this.t=void 0===t?null:t,null===this.t&&this.e.context().then(function(e){i.t=e,i.B(),i.resetAppIfPageFullyLoaded()},function(e){i.switchToErrorMessage(e,"Could not get app private_context, please check your internet connection and try again")}),this.Y=!1,this.S={},this.G={},this.e.metadata().then(function(e){var t=e.settings;i.S.R=t.mailchimp_api_key,i.S.I=t.mailchimp_datacentre_prefix,i.S.L=t.mailchimp_list_id,i.S.F=t.mailchimp_merge_field_forename,i.S.P=t.mailchimp_merge_field_surname,i.S.x=t.mailchimp_merge_field_customer_type,i.S.H=t.mailchimp_merge_field_customer_type_default_val,i.S.J=t.mailchimp_organisation_button_label,i.S.X=t.mailchimp_standard_button_label,i.G={V:{zendesk_field:i.i.o,mailchimp_field:i.S.x,type:i.i.q,default_value:i.S.H},K:i.W(t.mailchimp_organization_field_mappings,"Organisation Field Mapping",!1),Q:i.W(t.mailchimp_user_field_mappings,"User Field Mapping",!1),$:i.W(t.mailchimp_mailshot_only_field_mappings,"Mailchimp Only Field Mapping",!0)},i.field_maps={cust_type:i.G.V,organisation:i.G.K,user:i.G.Q,mc_only:i.G.$},null!==i.G.K&&null!==i.G.Q&&null!==i.G.$&&(i.Y=!0,i.resetAppIfPageFullyLoaded())},function(e){i.switchToErrorMessage(e,"Could not get your app settings, please check your internet connection and try again")})},resetAppIfPageFullyLoaded:function(){var t=this;!this.Z&&null===this.t||!this.Z&&!this.Y||(this.Z||this.t.location!==this.i.s||null!==this.z?(this.Z||this.t.location!==this.i.n||null!==this.user().id()&&null!==this.user().email()&&null!==this.user().name())&&(this.j=null,this.t.location===this.i.s?(this.switchToLoadingScreen("Loading Ticket Requester..."),makeAjaxCall(this,this.M.U(this.z.id),this.ee,this.switchToErrorMessage)):this.t.location===this.i.n&&(this.switchToLoadingScreen("Loading Zendesk User..."),this.getUserFromFrameworkInUserSidebarLocation()),this.Z=!0):this.e.get("ticket.requester").then(function(e){t.z=e["ticket.requester"],t.resetAppIfPageFullyLoaded()},function(e){t.switchToErrorMessage(e,"Could not get the ticket info, please check your internet connection and try again")}))},B:function(){this.t.location===this.i.n&&_.each([this.i.h],function(e){var t=this.userFields(e);t&&t.isVisible()&&t.hide()},this)},te:function(e){var t=null;if(this.t.location===this.i.n)for(var i=e.propertyName,s=0;s<this.G.Q.length;s++)if(i==="user."+this.G.Q[s].zendesk_field){t=this.G.Q[s].zendesk_field;break}null!==t&&void 0!==this.z&&null!==this.z&&(this.z.findExtraFieldByName(t,!0).value=e.newValue,this.switchToMainTemplate())},ie:function(){var e=this.z.customer_type,t=this.user().customField(this.i.h);this.se(e,t)},syncButtonFromModalOnClick:function(){return this.ne(this.z,!0),!1},mailchimpOnlyField_OnClick:function(e){for(var t=null,i=0;i<this.j.extra_merge_fields.length;i++)void 0===(t=this.j.extra_merge_fields[i]).field_def.zendesk_field&&"MC_ONLY_"+t.field_def.mailchimp_field===e.target.id&&(t.field_def.type===this.i.l?t.value=null===t.value||!1===t.value||"0"===t.value||0===t.value||""===t.value||"NO"===t.value.toString().toUpperCase()||"FALSE"===t.value.toString().toUpperCase()?"1":"0":console.error("Unsupported field type '%s' (only 'checkbox' supported) on mailchimp extra merge field: %o"+t.type,t));this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.M.N(this.j,!0),this.ae,this.re)},excludeButtonOnClick:function(){var e;return this.t.location===this.i.n?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.i.h,this.i.u)):((e=this.z.clone()).customer_type=this.i.u,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.M.b(e),this.le,this.switchToErrorMessage)),!1},organizationButtonOnClick:function(){var e;return this.t.location===this.i.n?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.i.h,this.i.p)):((e=this.z.clone()).customer_type=this.i.p,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.M.b(e),this.le,this.switchToErrorMessage)),!1},standardButtonOnClick:function(){var e;return this.t.location===this.i.n?(this.switchToLoadingScreen("Updating Zendesk User..."),this.user().customField(this.i.h,this.i.d)):((e=this.z.clone()).customer_type=this.i.d,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.M.b(e),this.le,this.switchToErrorMessage)),!1},ee:function(e){this.z=this.he(e),this.z.isOrganization()&&this.z.belongsToOrganization()?(this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.M.k(this.z.id,this.z.organization_id),this.oe,this.switchToErrorMessage)):this.fetchMailchimpObjectIfNecessary(),this.z=this.he(e)},he:function(e){var t=null;return null!==e?(t=new this.zendeskObjectsModule.ZendeskUser(this,e.user.id,e.user.name,e.user.email,e.user.user_fields.mailshot_customer_type,void 0!==e.user.organization_id&&null!==e.user.organization_id?e.user.organization_id:null)).populateExtraFieldsFromUserAPIData(e.user):console.error("private_createZendeskUserFromAPIReturnData called but userObjectFromDataAPI = null - this should never happen!"),t},le:function(e){var t=this.he(e);t.orgObject=this.z.orgObject;var i=this.z.customer_type;this.z=t,this.z.isOrganization()&&this.z.belongsToOrganization()&&!this.z.orgObjectIsPopulated()?(this.z.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null===i?"NOTSET":i,this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.M.k(this.z.id,this.z.organization_id),this.oe,this.switchToErrorMessage)):this.se(i,this.z.customer_type)},oe:function(e){var t;this.z.orgObject=this.createZendeskOrganizationFromAPIReturnData(e),void 0!==this.z.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs&&null!==this.z.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?(t="NOTSET"===this.z.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?null:this.z.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs,this.z.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null,this.se(t,this.z.customer_type)):this.fetchMailchimpObjectIfNecessary()},createZendeskOrganizationFromAPIReturnData:function(e){var t=null;return null!=e&&void 0!==e.organization&&null!==e.organization?(t=new this.zendeskObjectsModule.ZendeskOrganization(this,e.organization.id,e.organization.name,e.organization.organization_fields[this.G.V.zendesk_field])).populateExtraFieldsFromOrganizationAPIData(e.organization):console.warn("createZendeskOrganizationFromAPIReturnData called but organizationObjectFromDataAPI = null or doesnt contain a organization property - this should never happen!"),t},getUserFromFrameworkInUserSidebarLocation:function(){var e=void 0!==this.user().organizations()[0]&&null!==this.user().organizations()[0]?this.user().organizations()[0]:null;this.z=new this.zendeskObjectsModule.ZendeskUser(this,this.user().id(),this.user().name(),this.user().email(),this.user().customField(this.i.h),null===e?null:e.id()),this.z.populateExtraFieldsFromFrameworkUserObject(this.user()),null!==e&&(this.z.orgObject=new this.zendeskObjectsModule.ZendeskOrganization(this,e.id(),e.name(),e.customField(this.G.V.zendesk_field)),this.z.orgObject.populateExtraFieldsFromFrameworkOrgObject(e)),this.fetchMailchimpObjectIfNecessary()},fetchMailchimpObjectIfNecessary:function(){this.z.isIncluded()&&null===this.j?(this.switchToLoadingScreen("Loading user from Mailchimp..."),makeAjaxCall(this,this.M.A(this.z.email,this),this.retrievedMailchimpSubscriber,this.re)):this.switchToMainTemplate()},se:function(e,t){(this.z.customer_type=t)!==this.i.c&&t!==this.i.u||(e!==this.i.d&&e!==this.i.p||this.deleteExistingUserFromMailchimp(this.j),this.switchToMainTemplate()),t!==this.i.p&&t!==this.i.d||(e===this.i.u||e===this.i.c?this.syncNewUserToMailchimp(this.z):e!==t?this.ne(this.z,!0):this.switchToMainTemplate())},retrievedMailchimpSubscriber:function(e){this.j={email_address:e.email_address,status:"subscribed",forename:e.merge_fields[this.S.F],surname:e.merge_fields[this.S.P],customer_type:e.merge_fields[this.G.V.mailchimp_field],extra_merge_fields:[]};for(var t=0,i=0;i<this.G.Q.length;i++)this.j.extra_merge_fields[t]={field_def:this.G.Q[i],value:e.merge_fields[this.G.Q[i].mailchimp_field]},t++;for(var s=0;s<this.G.K.length;s++)this.j.extra_merge_fields[t]={field_def:this.G.K[s],value:e.merge_fields[this.G.K[s].mailchimp_field]},t++;for(var n=0;n<this.G.$.length;n++)this.j.extra_merge_fields[t]={field_def:this.G.$[n],value:e.merge_fields[this.G.$[n].mailchimp_field]},t++;this.switchToMainTemplate()},syncNewUserToMailchimp:function(e){var t=this.createNewMailchimpSyncUserObject(e);this.switchToLoadingScreen("Adding Mailchimp Member..."),makeAjaxCall(this,this.M.N(t,!1),this.ae,this.re)},ne:function(e,t){var i=this.createNewMailchimpSyncUserObject(e);if(void 0!==t&&!0===t&&null!==this.j&&e.email===this.j.email_address)for(var s=0;s<this.j.extra_merge_fields.length;s++)void 0===this.j.extra_merge_fields[s].field_def.zendesk_field&&(i.extra_merge_fields[s].value=this.j.extra_merge_fields[s].value);this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.M.N(i,!0),this.ae,this.re)},deleteExistingUserFromMailchimp:function(e){this.switchToLoadingScreen("Deleting Mailchimp Member..."),makeAjaxCall(this,this.M.D(e),null,null,!0)},re:function(t){var e=!1;try{var i=JSON.parse(t.responseText);400===t.status&&"Member Exists"===i.title&&(this.switchToErrorMessage(t,this.z.email+" already exists in mailchimp.<br /><br/>Do you want to override his/her details?","Override","error_override_mailchimp","private_createOrUpadateMailChimpListMember_Override_OnClick()"),e=!0),404===t.status&&(this.switchToErrorMessage(t,this.z.email+" doesn't exist in mailchimp.<br /><br/>Do you want to create a new record for him/her?","Create New","error_create_new_mailchimp","private_createOrUpadateMailChimpListMember_Add_New_OnClick()"),e=!0)}catch(e){console.warn("Could not JSON Parse errorResponse.responseText from get_or_private_createOrUpadateMailChimpListMember. errorResponse = %o\n\nparse exception: %o",t,e)}e||this.switchToErrorMessage(t)},ce:function(){return this.ne(this.z),!1},ue:function(){return this.syncNewUserToMailchimp(this.z),!1},ae:function(e){this.retrievedMailchimpSubscriber(e)},createNewMailchimpSyncUserObject:function(e){var t=e.isDefault();if(null===e)return console.warn("createNewMailchimpSyncUserObject called with null zendeskSyncUserObject"),null;if(!t&&null===e.orgObject)return console.warn("createNewMailchimpSyncUserObject called with customer type "+e.customer_type+" and  null zendeskSyncUserObject.orgObject"),null;for(var i={email_address:e.email,w:"subscribed",forename:e.getForeName(),surname:e.getSurname(),customer_type:e.getMailchimpCustomerType(),extra_merge_fields:[]},s=0,n=0;n<e.extra_user_fields.length;n++)i.extra_merge_fields[s]={field_def:e.extra_user_fields[n].field_def,value:null===e.extra_user_fields[n].value?"":e.extra_user_fields[n].value},s++;for(var a=0;a<this.G.K.length;a++)i.extra_merge_fields[s]={field_def:this.G.K[a],value:t?this.G.K[a].default_value:e.orgObject.extra_org_fields[a].value},s++;for(var r=0;r<this.G.$.length;r++)i.extra_merge_fields[s]={field_def:this.G.$[r],value:this.G.$[r].default_value},s++;return i},switchToLoadingScreen:function(e){switchToInlineTemplate(this.i.v,{optional_message:e})},switchToMainTemplate:function(){var e=this.z.getFieldSyncInfo(this.j),t=this.z.isInSync(e),i=" "+(t||this.z.isExcluded()?"btn-primary":"btn-danger"),s={zendesk_user:this.z,mailchimp_user:this.j,sync_fields:e,monkey_URL:this.z.isExcluded()?"./img/exclude_monkey.png":t?"./img/insync_monkey.png":"./img/outofsync_monkey.png",buttons:{exclude:{show:!0,classNameInsert:this.z.isExcluded()?" active":"",label:"Exclude",onclick:"excludeButtonOnClick()"},organization:{show:this.z.belongsToOrganization(),classNameInsert:i+(this.z.isOrganization()?" active":""),label:this.S.J,onclick:"organizationButtonOnClick()"},standard:{show:!0,classNameInsert:i+(this.z.isDefault()?" active":""),label:this.S.X,onclick:"standardButtonOnClick()"}},display_params:{customer_type_not_set:this.z.isNotset(),customer_type_exclude:this.z.isExcluded(),customer_type_included:this.z.isIncluded(),customer_type_organization:this.z.isOrganization(),customer_type_standard:this.z.isDefault(),user_in_sync:t,DEBUG:debug_mode}};n.main_template_form_data=s,switchToHdbsFileTemplate(this.modalMode?this.i.m:this.i._,s)},switchToErrorMessage:function(e,t,i,s,n){try{(0===e.status&&void 0===t||null===t||"error"===t)&&(t="Could not connect to API, Please check your internet connection")}catch(e){}var a={errorResponse:e,overrideMessage:void 0===t||"error"===t?null:t,additionalButtonText:void 0===i?null:i,additionalButtonHandle:void 0===s?null:s,additionalButtonOnclick:void 0===n?null:n};switchToHdbsFileTemplate(this.i.f,a)},debugButtonOnClick:function(){return console.log("Starting debugButtonOnClick"),console.dir(this),!1},W:function(t,i,e){var s=null,n=null,a=null;try{s=JSON.parse(t)}catch(e){var r="unknown";r=e instanceof SyntaxError?e.name+" "+e.message:e.message,console.error("JSON Validation for settings '%s' Falied with exception e = %o ",i,e),console.error("JSON TEXT WAS: %o ",t),n=e,a="The JSON Settings text you entered for the "+i+" setting was formatted incorrectly, it must be valid JSON.<br /><br />The failure reason was: "+r+'<br /><br />For help with these settings fields use our <a target="_blank" href="'+this.i.g+'">Zenchimp App Settings Generator</a> in Microsoft Excel'}if(null!==s){for(var l=null,h=e?["checkbox"]:["image","text","checkbox"],o=[],c=0;c<s.length;c++)if((l=s[c]).field_label||o.push("Missing Field/Value: field_label"),l.mailchimp_field||o.push("Missing Field/Value: mailchimp_field"),l.type?h.includes(l.type)||o.push("Invalid type: '"+l.type+"'. Valid types are: "+h.toString()+" (all lower case)"):o.push("Missing Field/Value: type"),void 0!==l.default_value&&null!==l.default_value||o.push("Missing Field: default_value"),e&&void 0!==l.zendesk_field&&o.push("Field: zendesk_field is not allowed on mailchimp-only field lists"),e||l.zendesk_field||o.push("Missing Field/Value: zendesk_field"),0<o.length){a="Field Definition "+(c+1)+" for the '"+i+"' setting has errors:<br /><br />"+o.join("<br />");break}if(null===a)return s}this.switchToErrorMessage(n,a)}}};