"use strict";var md5=null;!function(){function c(e,i){var t=(65535&e)+(65535&i);return(e>>16)+(i>>16)+(t>>16)<<16|65535&t}function l(e,i,t,n,s,r){return c((o=c(c(i,e),c(n,r)))<<(l=s)|o>>>32-l,t);var o,l}function d(e,i,t,n,s,r,o){return l(i&t|~i&n,e,i,s,r,o)}function _(e,i,t,n,s,r,o){return l(i&n|t&~n,e,i,s,r,o)}function f(e,i,t,n,s,r,o){return l(i^t^n,e,i,s,r,o)}function m(e,i,t,n,s,r,o){return l(t^(i|~n),e,i,s,r,o)}function a(e,i){var t,n,s,r;e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;for(var o=1732584193,l=-271733879,a=-1732584194,h=271733878,u=0;u<e.length;u+=16)o=d(t=o,n=l,s=a,r=h,e[u],7,-680876936),h=d(h,o,l,a,e[u+1],12,-389564586),a=d(a,h,o,l,e[u+2],17,606105819),l=d(l,a,h,o,e[u+3],22,-1044525330),o=d(o,l,a,h,e[u+4],7,-176418897),h=d(h,o,l,a,e[u+5],12,1200080426),a=d(a,h,o,l,e[u+6],17,-1473231341),l=d(l,a,h,o,e[u+7],22,-45705983),o=d(o,l,a,h,e[u+8],7,1770035416),h=d(h,o,l,a,e[u+9],12,-1958414417),a=d(a,h,o,l,e[u+10],17,-42063),l=d(l,a,h,o,e[u+11],22,-1990404162),o=d(o,l,a,h,e[u+12],7,1804603682),h=d(h,o,l,a,e[u+13],12,-40341101),a=d(a,h,o,l,e[u+14],17,-1502002290),o=_(o,l=d(l,a,h,o,e[u+15],22,1236535329),a,h,e[u+1],5,-165796510),h=_(h,o,l,a,e[u+6],9,-1069501632),a=_(a,h,o,l,e[u+11],14,643717713),l=_(l,a,h,o,e[u],20,-373897302),o=_(o,l,a,h,e[u+5],5,-701558691),h=_(h,o,l,a,e[u+10],9,38016083),a=_(a,h,o,l,e[u+15],14,-660478335),l=_(l,a,h,o,e[u+4],20,-405537848),o=_(o,l,a,h,e[u+9],5,568446438),h=_(h,o,l,a,e[u+14],9,-1019803690),a=_(a,h,o,l,e[u+3],14,-187363961),l=_(l,a,h,o,e[u+8],20,1163531501),o=_(o,l,a,h,e[u+13],5,-1444681467),h=_(h,o,l,a,e[u+2],9,-51403784),a=_(a,h,o,l,e[u+7],14,1735328473),o=f(o,l=_(l,a,h,o,e[u+12],20,-1926607734),a,h,e[u+5],4,-378558),h=f(h,o,l,a,e[u+8],11,-2022574463),a=f(a,h,o,l,e[u+11],16,1839030562),l=f(l,a,h,o,e[u+14],23,-35309556),o=f(o,l,a,h,e[u+1],4,-1530992060),h=f(h,o,l,a,e[u+4],11,1272893353),a=f(a,h,o,l,e[u+7],16,-155497632),l=f(l,a,h,o,e[u+10],23,-1094730640),o=f(o,l,a,h,e[u+13],4,681279174),h=f(h,o,l,a,e[u],11,-358537222),a=f(a,h,o,l,e[u+3],16,-722521979),l=f(l,a,h,o,e[u+6],23,76029189),o=f(o,l,a,h,e[u+9],4,-640364487),h=f(h,o,l,a,e[u+12],11,-421815835),a=f(a,h,o,l,e[u+15],16,530742520),o=m(o,l=f(l,a,h,o,e[u+2],23,-995338651),a,h,e[u],6,-198630844),h=m(h,o,l,a,e[u+7],10,1126891415),a=m(a,h,o,l,e[u+14],15,-1416354905),l=m(l,a,h,o,e[u+5],21,-57434055),o=m(o,l,a,h,e[u+12],6,1700485571),h=m(h,o,l,a,e[u+3],10,-1894986606),a=m(a,h,o,l,e[u+10],15,-1051523),l=m(l,a,h,o,e[u+1],21,-2054922799),o=m(o,l,a,h,e[u+8],6,1873313359),h=m(h,o,l,a,e[u+15],10,-30611744),a=m(a,h,o,l,e[u+6],15,-1560198380),l=m(l,a,h,o,e[u+13],21,1309151649),o=m(o,l,a,h,e[u+4],6,-145523070),h=m(h,o,l,a,e[u+11],10,-1120210379),a=m(a,h,o,l,e[u+2],15,718787259),l=m(l,a,h,o,e[u+9],21,-343485551),o=c(o,t),l=c(l,n),a=c(a,s),h=c(h,r);return[o,l,a,h]}function h(e){for(var i="",t=0;t<32*e.length;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function u(e){var i,t=[];for(t[(e.length>>2)-1]=void 0,i=0;i<t.length;i+=1)t[i]=0;for(i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t}function n(e){for(var i,t="0123456789abcdef",n="",s=0;s<e.length;s+=1)i=e.charCodeAt(s),n+=t.charAt(i>>>4&15)+t.charAt(15&i);return n}function t(e){return unescape(encodeURIComponent(e))}function s(e){return h(a(u(i=t(e)),8*i.length));var i}function r(e,i){return function(e,i){var t,n,s=u(e),r=[],o=[];for(r[15]=o[15]=void 0,16<s.length&&(s=a(s,8*e.length)),t=0;t<16;t+=1)r[t]=909522486^s[t],o[t]=1549556828^s[t];return n=a(r.concat(u(i)),512+8*i.length),h(a(o.concat(n),640))}(t(e),t(i))}md5=function(e,i,t){return i?t?r(i,e):n(r(i,e)):t?s(e):n(s(e))}}();var NameParse=function(){function e(){return e}return e.parse=function(e){var i,t="",n="",s="",r=null,o=0,l=0,a=(i=(e=e.trim()).split(" ").filter(function(e){return-1===e.indexOf("(")})).length,h=this.is_salutation(i[0]),u=this.is_suffix(i[a-1]),c=h?1:0,d=u?a-1:a,r=i[c];for(this.is_initial(r)?this.is_initial(i[1+c])?n+=" "+r.toUpperCase():s+=" "+r.toUpperCase():n+=" "+this.fix_case(r),l=1+c;l<d-1&&(r=i[l],!this.is_compound_lastName(r));l++)this.is_initial(r)?s+=" "+r.toUpperCase():n+=" "+this.fix_case(r);if(1<d-c)for(o=l;o<d;o++)t+=" "+this.fix_case(i[o]);return{salutation:h||"",firstName:n.trim(),initials:s.trim(),lastName:t.trim(),suffix:u||""}},e.removeIgnoredChars=function(e){return e.replace(".","")},e.is_salutation=function(e){return"mr"===(e=this.removeIgnoredChars(e).toLowerCase())||"master"===e||"mister"===e?"Mr.":"mrs"===e?"Mrs.":"miss"===e||"ms"===e?"Ms.":"dr"===e?"Dr.":"rev"===e?"Rev.":"fr"===e&&"Fr."},e.is_suffix=function(e){e=this.removeIgnoredChars(e).toLowerCase();var i=["I","II","III","IV","V","Senior","Junior","Jr","Sr","PhD","APR","RPh","PE","MD","MA","DMD","CME","BVM","CFRE","CLU","CPA","CSC","CSJ","DC","DD","DDS","DO","DVM","EdD","Esq","JD","LLD","OD","OSB","PC","Ret","RGS","RN","RNC","SHCJ","SJ","SNJM","SSMO","USA","USAF","USAFR","USAR","USCG","USMC","USMCR","USN","USNR"],t=i.map(function(e){return e.toLowerCase()}).indexOf(e);return 0<=t&&i[t]},e.is_compound_lastName=function(e){e=e.toLowerCase();return 0<=["vere","von","van","de","del","della","di","da","pietro","vanden","du","st.","st","la","lo","ter"].indexOf(e)},e.is_initial=function(e){return 1===(e=this.removeIgnoredChars(e)).length},e.is_camel_case=function(e){return/[A-Z]+/.exec(e)&&/[a-z]+/.exec(e)},e.fix_case=function(e){return e=this.safe_ucfirst("-",e),e=this.safe_ucfirst(".",e)},e.safe_ucfirst=function(e,i){return i.split(e).map(function(e){return this.is_camel_case(e)?e:e.substr(0,1).toUpperCase()+e.substr(1).toLowerCase()},this).join(e)},e}();function ZendeskOrganization(e,i,t,n){this.e=e,this.id=i,this.name=t,this.i=n,this.t=[];for(var s=0;s<e.s.n.length;s++)this.t[s]={r:e.s.n[s],o:null}}function ZendeskUser(e,i,t){if(null===i&&t){this.e=e,this.id=t.id,this.name=t.name,this.l=null,this.email=t.email,this.customer_type=t.customer_type,this.a=t.a,this.h=null===t.h?null:t.h.clone(),this.u=[];for(var n=0;n<t.u.length;n++)this.u[n]={field_def:t.u[n].field_def,value:t.u[n].value}}else{if(!i||!i.user)throw new TypeError("The Zendesk API used to get the user details returned no user information.");if(void 0===i.user.user_fields.mailshot_customer_type)throw new ReferenceError("The required Zendesk field with key mailshot_customer_type is missing. This should have been created during installation. Please reinstall or raise a bug using the link below");this.e=e,this.id=i.user.id,this.name=i.user.name,this.l=null,this.email=i.user.email,this.customer_type=i.user.user_fields.mailshot_customer_type,this.a=void 0!==i.user.organization_id&&null!==i.user.organization_id?i.user.organization_id:null,this.h=null,this.u=[],this.c=null;for(n=0;n<e.s.d.length;n++)this.u[n]={field_def:e.s.d[n],value:null};this.populateExtraFieldsFromUserAPIData(i.user),this._()}}ZendeskOrganization.prototype.populateExtraFieldsFromOrganizationAPIData=function(e){for(var i=0;i<this.t.length;i++){if(void 0===e.organization_fields[this.t[i].r.zendesk_field])throw new ReferenceError("The Zendesk 'Organisation Field' with key '"+this.t[i].r.zendesk_field+'\' which you specified in your Field Mapping settings doesnt seem to exist in Zendesk yet.<br /><br />For help with your field mappings use our <a target="_blank" href="'+this.e.m.f+'">Zenchimp App Settings Generator</a> spreadsheet.');this.t[i].o=e.organization_fields[this.t[i].r.zendesk_field]}},ZendeskOrganization.prototype.populateExtraFieldsFromFrameworkOrgObject=function(e){for(var i=0;i<this.t.length;i++)this.t[i].o=e.customField(this.t[i].r.zendesk_field)},ZendeskOrganization.prototype.clone=function(){for(var e=new ZendeskOrganization(this.e,this.id,this.name,this.i),i=0;i<this.t.length;i++)e.t[i]={r:this.t[i].r,o:this.t[i].o};return e},ZendeskUser.prototype.populateExtraFieldsFromUserAPIData=function(e){for(var i=0;i<this.u.length;i++){if(void 0===e.user_fields[this.u[i].field_def.zendesk_field])throw new ReferenceError("The Zendesk 'User Field' with key '"+this.u[i].field_def.zendesk_field+'\' which you specified in your Field Mapping settings doesnt seem to exist in Zendesk yet.<br /><br />For help with your field mappings use our <a target="_blank" href="'+this.e.m.f+'">Zenchimp App Settings Generator</a> spreadsheet.');this.u[i].value=e.user_fields[this.u[i].field_def.zendesk_field]}},ZendeskUser.prototype._=function(){this.customer_type===this.e.m.p&&null===this.a&&(this.c={g:"ORG_MISSING",v:new ReferenceError(this.name+" is set to sync his/her organisation fields, however they no longer belong to an organisation, do you want to switch customer type so that only thier user fields are synced?")})},ZendeskUser.prototype.getSalutation=function(){return this.populateNamePartsIfNecessary(),null===this.l.salutation?"":this.l.salutation.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.getForeName=function(){return this.populateNamePartsIfNecessary(),null===this.l.firstName?"":this.l.firstName.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.getSurname=function(){return this.populateNamePartsIfNecessary(),null===this.l.lastName?"":this.l.lastName.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.populateNamePartsIfNecessary=function(){null===this.l&&null!==this.name&&(this.l=this.e.parseNamesModule.parse(this.name.replace("/"," ").replace("."," ").split(",").reverse().map(Function.prototype.call,String.prototype.trim).join(" ")))},ZendeskUser.prototype.populateExtraFieldsFromFrameworkUserObject=function(e){for(var i=0;i<this.u.length;i++)this.u[i].value=e.customField(this.u[i].field_def.zendesk_field)},ZendeskUser.prototype.clone=function(){return new ZendeskUser(this.e,null,this)},ZendeskUser.prototype.isNotset=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_NOT_SET},ZendeskUser.prototype.isExcluded=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_EXCLUDE},ZendeskUser.prototype.isIncluded=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_ORGANIZATION||this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.isOrganization=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_ORGANIZATION},ZendeskUser.prototype.isDefault=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.belongsToOrganization=function(){return null!==this.a},ZendeskUser.prototype.y=function(){return null!==this.h},ZendeskUser.prototype.getMailchimpCustomerType=function(){return void 0===this.customer_type||null===this.customer_type?(console.warn("ZendeskUser.getMailchimpCustomerType() called with invalid customer_type, this = "),console.dir(this),null):this.customer_type===this.e.m.p?this.h.i:this.e.s.k.default_value};var debug_mode=!(ZendeskUser.prototype.findExtraFieldByName=function(e,i){for(var t=0;t<this.u.length;t++)if(i&&this.u[t].field_def.zendesk_field===e||!i&&this.u[t].field_def.mailchimp_field===e)return this.u[t]}),thisV2Client=null;function switchToHdbsFileTemplate(e,t){var n=$("#page_content");$(n).empty().html('<div class="alert alert-info">Loading...</div><div class="text-center"><div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div></div>'),$.ajax(e).done(function(e){var i=Handlebars.compile(e)(t);$(n).empty().html(i)})}function switchToInlineTemplate(e,i){var t=$("#"+e).html(),n=Handlebars.compile(t)(i),s=$("#page_content");$(s).empty().html(n)}function modal_createChildFromParent(e){var i={location:"modal",size:{width:"700px",height:"450px"},url:"assets/modal-iframe.html#parent_guid="+encodeURIComponent(e.instanceGuid)+"&parent_location="+encodeURIComponent(e.location)};thisV2Client.invoke("instances.create",i).then(function(e){console.log("SUCCESS CREATING MODAL, success = %o",e)},function(e){console.error("FAILURE CREATING MODAL, success = %o",e)})}function getClientInstanceFromGuid(e){return thisV2Client.instance(e)}function parseURLParams(e){var i=e.replace("#","").split("&");debug_mode&&console.log("Split into individual strings: param_sub = %o",i);for(var t={},n=0;n<i.length;++n){var s=i[n].split("=");t[s[0]]=s[1]}return t}function makeAjaxCall(i,e,t,n,s){void 0!==s&&s&&(e.cors=!1),thisV2Client.request(e).then(function(e){null==t?console.warn("AJAX SUCCESS: and no successFunction was defined so no futher action can be taken to handle the response. returned data = %o",e):t.call(i,e)},function(e){null==n?console.warn("AJAX FAIL: NOT CALLING '%s(data)' AND NO failFunction WAS DEFINED so no futher action can be taken to handle the error. error response = %o",t?t.name:t,e):n.call(i,e)})}thisV2Client=ZAFClient.init();var connector={b:function(e,i){var t=!1;try{var n=JSON.parse(i.responseText);if(400===i.status&&"Member Exists"===n.title&&(e.C(i,e.O.email+" already exists in mailchimp.<br /><br/>Do you want to override his/her details?","Override","error_override_mailchimp","__createOrUpadateMailChimpListMember_Override_OnClick()"),t=!0),400===i.status&&"Invalid Resource"===n.title){var s="<p><b>On no, Mailchimp rejected one of your values</b></p><p>This is often a broken link or URL, an incorrect data type, or no value for a required field in Mailchimp. Here's what Mailchimp is saying...</p>";void 0!==n.title&&(s+="<p><b>"+n.title+"</b>",void 0!==n.detail&&(s+=": "+n.detail),s+="</p>");var r=n.errors;if(void 0!==r&&0<r.length){s+="<p>The following fields had issues:<ul>",console.log(r.lenth);for(var o=0,l=r[o];void 0!==l;)console.log("here"),s+="<li><b> Field: "+l.field+"</b> - "+l.message+"</li>",l=r[++o];s+="</ul></p>"}e.C(i,s),t=!0}404===i.status&&(e.C(i,e.O.email+" doesn't exist in mailchimp.<br /><br/>Do you want to create a new record for him/her?","Create New","error_create_new_mailchimp","__createOrUpadateMailChimpListMember_Add_New_OnClick()"),t=!0)}catch(e){console.warn("Could not JSON Parse errorResponse.responseText from get_or___createOrUpadateMailChimpListMember. errorResponse = %o\n\nparse exception: %o",i,e)}t||e.C(i)},T:function(e,i){for(var t={email_address:i.email_address,status:i.status,forename:this.U(e,i,e.S.M),surname:this.U(e,i,e.S.w),customer_type:this.U(e,i,e.s.k.mailchimp_field),extra_merge_fields:[],isSubscribed:function(){return"subscribed"===this.status||"pending"===this.status},isUnSubscribed:function(){return"unsubscribed"===this.status},isDeleted:function(){return"cleaned"!==this.status}},n=0,s=0;s<e.s.d.length;s++)t.extra_merge_fields[n]={field_def:e.s.d[s],value:this.U(e,i,e.s.d[s].mailchimp_field)},n++;for(var r=0;r<e.s.n.length;r++)t.extra_merge_fields[n]={field_def:e.s.n[r],value:this.U(e,i,e.s.n[r].mailchimp_field)},n++;for(var o=0;o<e.s.A.length;o++)t.extra_merge_fields[n]={field_def:e.s.A[o],value:this.U(e,i,e.s.A[o].mailchimp_field)},n++;return t},U:function(e,i,t){var n=i.merge_fields[t];if(void 0===n)throw new ReferenceError("The Mailchimp Merge tag '*|"+t+'|*\' which you specified in your Field Mapping settings doesnt seem to exist in Mailchimp yet.<br /><br />Please create the field in Mailchimp or for help with your field mappings use our <a target="_blank" href="'+e.m.f+'"Zenchimp App Settings Generator</a> spreadsheet.');return n},I:function(e,i,t){if(null==t)return null;if(void 0===i.customer_type||null===i.customer_type||i.isNotset())return console.warn("__getFieldSyncInfo.getFieldSyncInfo() called with invalid customer_type, zendeskUser = %o",i),null;for(var n=[{label:"Email",mc_only:!1,is_image:!1,zd_field_location:"user",zd_field_key:null,zd_value:i.email,mc_field_key:"EMAIL",mc_value:t.email_address,in_sync:i.email.toLowerCase()===t.email_address.toLowerCase()},{label:"Name",mc_only:!1,is_image:!1,zd_field_location:"user",zd_field_key:null,zd_value:i.name,mc_field_key:e.S.M+"|* and *|"+e.S.w,mc_value:"["+t.forename+"] ["+t.surname+"]",in_sync:t.forename.toLowerCase()===i.getForeName().toLowerCase()&&t.surname.toLowerCase()===i.getSurname().toLowerCase()},{label:"Customer Type",mc_only:!1,is_image:!1,zd_field_location:i.isOrganization()?"organisation":"user",zd_field_key:i.isOrganization()?e.m.R:e.m.F,zd_value:i.getMailchimpCustomerType(),mc_field_key:e.S.N,mc_value:t.customer_type,in_sync:i.getMailchimpCustomerType()===t.customer_type}],s=null,r=null,o=null,l=3,a=0;a<i.u.length;a++)s=null===(s=i.u[a].value)?"":s,r=null===(r=t.extra_merge_fields[l-3].value)?"":r,n[l]={label:i.u[a].field_def.field_label,mc_only:!1,is_image:i.u[a].field_def.type===i.e.resources.TYPE_IMAGE,zd_field_location:"user",zd_field_key:i.u[a].field_def.zendesk_field,zd_value:s,mc_field_key:i.u[a].field_def.mailchimp_field,mc_value:r,in_sync:s===r},l++;for(a=0;a<i.e.s.n.length;a++)s=null===(s=i.isDefault()?i.e.s.n[a].default_value:i.isOrganization()?i.h.t[a].o:null)?"":s,r=null===(r=t.extra_merge_fields[l-3].value)?"":r,o=i.e.s.n[a],n[l]={label:o.field_label,mc_only:!1,is_image:o.type===i.e.resources.TYPE_IMAGE,zd_field_location:"organisation",zd_field_key:o.zendesk_field,zd_value:s,mc_field_key:o.mailchimp_field,mc_value:r,in_sync:s===r},l++;for(a=0;a<i.e.s.A.length;a++)r=null===(r=t.extra_merge_fields[l-3].value)?"":r,o=i.e.s.A[a],n[l]={label:o.field_label,mc_only:!0,is_image:o.type===i.e.resources.TYPE_IMAGE,is_checkbox:o.type===i.e.resources.TYPE_CHECKBOX,is_checkbox_ticked:o.type!==i.e.resources.TYPE_CHECKBOX?null:r.toString()===o.value_if_ticked,checkbox_html_id:"MC_ONLY_"+o.mailchimp_field,zd_field_location:null,zd_field_key:null,zd_value:null,mc_field_key:o.mailchimp_field,mc_value:r,in_sync:!0},l++;return n},x:function(e,i,t){if(null==i&&(i=this.I(e,t)),null===i)return!1;for(var n=0;n<i.length;n++)if(!i[n].in_sync)return!1;return!0},L:function(e,i){i.field_def.type===e.m.Z?i.value=null!==i.value&&i.value.toString()===i.field_def.value_if_ticked?i.field_def.value_if_unticked:i.field_def.value_if_ticked:console.error("Unsupported field type '%s' (only 'checkbox' supported) on mailchimp extra merge field: %o"+i.type,i)}},__screen_events={P:function(i){i.z.location===i.m.D&&i.j.get("userFields:"+i.m.F+".isVisible").then(function(e){e["userFields:"+i.m.F+".isVisible"]&&i.j.invoke("userFields:"+i.m.F+".hide")},function(e){i.C(e,"Could not access a Zendesk User Field with a Field Key of '"+i.m.F+"' Please check your internet connection or reinstall the app. If this issue persists please raise a bug report below")})},G:function(e,i){var t=null;if(e.z.location===e.m.D){var n=i.propertyName;if(n==="user."+e.m.F)this.B(e,i.newValue);else if("user.organizations"===n)this.J(e,i.newValue);else if("user.name"===n)e.O&&(e.O.name=i.newValue,e.O.l=null),e.switchToMainTemplate();else if("user.email"===n)e.O&&(e.O.email=i.newValue),e.switchToMainTemplate();else for(var s=0;s<e.s.d.length;s++)if(n==="user."+e.s.d[s].zendesk_field){t=e.s.d[s].zendesk_field;break}}null!==t&&e.O&&(e.O.findExtraFieldByName(t,!0).value=i.newValue,e.switchToMainTemplate())},J:function(e,i){0===i.length?(e.O.a=null,e.O.h=null,e.O._(),e.V()&&e.switchToMainTemplate()):(e.O.a=i[0].id,e.O.h=null,e.O.isOrganization()?(e.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,e.H.Y(e.O.id,e.O.a),e.q,e.C)):e.switchToMainTemplate())},B:function(e,i){var t=e.O.customer_type;e.O.customer_type=i,e.X(t,i)}},pluginFactory=function(s){return{j:s,z:null,m:{$:"ticket_sidebar",D:"user_sidebar",K:"text",W:"image",Z:"checkbox",F:"mailshot_customer_type",R:"mailshot_customer_display_name",Q:null,ee:"mailshot_exclude_from_mailshot",ie:"mailshot_use_default_values",p:"mailshot_use_organisation_values",te:"./templates/main.hdbs",ne:"./templates/sync-modal.hdbs",se:"loading-screen-template",re:"./templates/show_error.hdbs",f:"https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/raw/master/extras/ZenchimpSettingsGenerator.xlsx"},H:{oe:null,le:function(e){return{url:"/api/v2/users/"+encodeURIComponent(e)+".json",type:"GET",dataType:"json"}},ae:function(e){return{url:"/api/v2/users/create_or_update.json",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({user:{id:e.id,email:e.email,user_fields:{mailshot_customer_type:e.customer_type}}})}},Y:function(e,i){return{url:null!=i?"/api/v2/organizations/"+encodeURIComponent(i)+".json":"/api/v2/users/"+encodeURIComponent(e)+".organizations.json",type:"GET",dataType:"json"}},he:function(e){if(null==e)return console.error("ERROR CONDITION: __getMailChimpListMember called with null email address");var i=md5(e.toLowerCase());return{url:"https://"+encodeURIComponent(this.oe.S.ue)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.oe.S.ce)+"/members/"+encodeURIComponent(i),type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.oe.S.de)}}},_e:function(e,i){if(null===e||null===e.email_address)return console.warn("ERROR CONDITION: __createOrUpadateMailChimpListMember called with either null user or user with no email address");var t=md5(e.email_address.toLowerCase()),n={};n[this.oe.S.M]=e.forename,n[this.oe.S.w]=e.surname,n[this.oe.S.N]=e.customer_type;for(var s=null,r=null,o=0;o<e.extra_merge_fields.length;o++)s=e.extra_merge_fields[o].field_def,r=null===(r=e.extra_merge_fields[o].value)&&s.type===this.oe.m.K?"":r,n[s.mailchimp_field]=r;var l={id:t,email_address:e.email_address,email_type:"html",status:e.fe,status_if_new:"subscribed",merge_fields:n,vip:e.customer_type===this.oe.m.p};return{url:"https://"+encodeURIComponent(this.oe.S.ue)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.oe.S.ce)+"/members/"+encodeURIComponent(i?t:""),type:i?"PUT":"POST",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.oe.S.de)},data:JSON.stringify(l)}},me:function(e){if(null===e||null===e.email_address)return console.error("ERROR CONDITION: __deleteMailChimpListMember called with either null user or user with no email address");var i=md5(e.email_address.toLowerCase());return{url:"https://"+encodeURIComponent(this.oe.S.ue)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.oe.S.ce)+"/members/"+encodeURIComponent(i),type:"DELETE",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.oe.S.de)}}}},init:function(e,i){var t=this,n=this.m;this.resources={TYPE_TEXT:n.K,TYPE_IMAGE:n.W,TYPE_CHECKBOX:n.Z,CUSTOMER_TYPE_NOT_SET:n.Q,CUSTOMER_TYPE_EXCLUDE:n.ee,CUSTOMER_TYPE_USE_DEFAULT:n.ie,CUSTOMER_TYPE_USE_ORGANIZATION:n.p},s.on("ticket.requester.id.changed",function(){t.resetAppIfPageFullyLoaded()}),s.on("*.changed",function(e){t.G(e)}),(this.H.oe=this).pe=null!=e&&e,this.zendeskObjectsModule={ZendeskOrganization:ZendeskOrganization},this.parseNamesModule=NameParse,this.ge=null,this.O=null,this.ve=!1,this.z=void 0===i?null:i,null===this.z&&this.j.context().then(function(e){t.z=e,t.P(),t.resetAppIfPageFullyLoaded()},function(e){t.C(e,"Could not get app __context, please check your internet connection and try again")}),this.ye=!1,this.S={},this.s={},this.j.metadata().then(function(e){var i=e.settings;t.S={de:i.mailchimp_api_key,ue:i.mailchimp_datacentre_prefix,ce:i.mailchimp_list_id,M:i.mailchimp_merge_field_forename,w:i.mailchimp_merge_field_surname,N:i.mailchimp_merge_field_customer_type,ke:i.mailchimp_merge_field_customer_type_default_val,be:i.mailchimp_organisation_button_label,Ce:i.mailchimp_standard_button_label},t.s={k:{zendesk_field:t.m.R,mailchimp_field:t.S.N,type:t.m.K,default_value:t.S.ke},n:t.Oe(i.mailchimp_organization_field_mappings,"Organisation Field Mapping",!1),d:t.Oe(i.mailchimp_user_field_mappings,"User Field Mapping",!1),A:t.Oe(i.mailchimp_mailshot_only_field_mappings,"Mailchimp Only Field Mapping",!0)},t.field_maps={cust_type:t.s.k,organisation:t.s.n,user:t.s.d,mc_only:t.s.A},null!==t.s.n&&null!==t.s.d&&null!==t.s.A&&(t.ye=!0,t.resetAppIfPageFullyLoaded())},function(e){t.C(e,"Could not get your app settings, please check your internet connection and try again")})},resetAppIfPageFullyLoaded:function(){var e,t=this;!this.ve&&null===this.z||!this.ve&&!this.ye||(null!==this.O?(this.ge=null,this.z.location===this.m.$?this.switchToLoadingScreen("Loading Ticket Requester..."):this.z.location===this.m.D&&this.switchToLoadingScreen("Loading Zendesk User..."),makeAjaxCall(this,this.H.le(this.O.id),this.Te,this.C),this.ve=!0):(e=this.z.location===this.m.$?"ticket.requester":"user",this.j.get(e).then(function(e){var i=t.z.location===t.m.$?"ticket.requester":"user";t.O=e[i],t.resetAppIfPageFullyLoaded()},function(e){t.C(e,"Could not get the ticket info, please check your internet connection and try again")})))},P:function(){__screen_events.P(this)},G:function(e){__screen_events.G(this,e)},syncButtonFromModalOnClick:function(){return this.syncButtonPressed=!0,this.Ue(this.O,!0),!1},mailchimpOnlyField_OnClick:function(e){for(var i=null,t=0;t<this.ge.extra_merge_fields.length;t++)void 0===(i=this.ge.extra_merge_fields[t]).field_def.zendesk_field&&"MC_ONLY_"+i.field_def.mailchimp_field===e.target.id&&connector.L(this,i);null!==i?(this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.H._e(this.ge,!0),this.Me,this.b)):console.error("Could not find merge tag on Mailchimp user whose merge field coresponds to the checkbox just clicked: '%s'. Mailchimp user this.__mailshot_sync_user = %o",e.target.id,this.ge)},excludeButtonOnClick:function(){var e=this.O.clone();return e.customer_type=this.m.ee,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.H.ae(e),this.Ee,this.C),!1},organizationButtonOnClick:function(){var e=this.O.clone();return e.customer_type=this.m.p,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.H.ae(e),this.Ee,this.C),!1},standardButtonOnClick:function(){var e=this.O.clone();return e.customer_type=this.m.ie,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.H.ae(e),this.Ee,this.C),!1},Te:function(e){this.O=this.Se(e),this.V()&&(this.O.isOrganization()&&this.O.belongsToOrganization()?(this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.H.Y(this.O.id,this.O.a),this.q,this.C)):this.we())},Se:function(e){var i=null;try{i=new ZendeskUser(this,e)}catch(e){console.warn(e),this.C(e,e.message,additionalButtonText,additionalButtonClass,additionalButtonOnclick)}return i},V:function(){var e=null!==this.O;return null!==this.O&&null!==this.O.c&&"ORG_MISSING"===this.O.c.g&&(this.C(this.O.c.v,this.O.c.v.message,"Switch Sync Type","btn-warning","standardButtonOnClick()"),e=!1),e},Ee:function(e){var i=null;try{i=new ZendeskUser(this,e)}catch(e){this.C(e,e.message)}i.h=this.O.h;var t=this.O.customer_type;this.O=i,this.O.isOrganization()&&this.O.belongsToOrganization()&&!this.O.y()?(this.O.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null===t?"NOTSET":t,this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.H.Y(this.O.id,this.O.a),this.q,this.C)):this.X(t,this.O.customer_type)},q:function(e){var i;this.O.h=this.createZendeskOrganizationFromAPIReturnData(e),void 0!==this.O.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs&&null!==this.O.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?(i="NOTSET"===this.O.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?null:this.O.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs,this.O.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null,this.X(i,this.O.customer_type)):this.we()},createZendeskOrganizationFromAPIReturnData:function(e){var i=null;if(null!=e&&void 0!==e.organization&&null!==e.organization)try{(i=new this.zendeskObjectsModule.ZendeskOrganization(this,e.organization.id,e.organization.name,e.organization.organization_fields[this.s.k.zendesk_field])).populateExtraFieldsFromOrganizationAPIData(e.organization)}catch(e){console.warn(e),this.C(e,e.message)}else console.warn("createZendeskOrganizationFromAPIReturnData called but organizationObjectFromDataAPI = null or doesnt contain a organization property - this should never happen!");return i},Ae:function(){var e=void 0!==this.user().organizations()[0]&&null!==this.user().organizations()[0]?this.user().organizations()[0]:null;this.O=new this.zendeskObjectsModule.ZendeskUser(this,this.user().id(),this.user().name(),this.user().email(),this.user().customField(this.m.F),null===e?null:e.id()),this.O.populateExtraFieldsFromFrameworkUserObject(this.user()),null!==e&&(this.O.h=new this.zendeskObjectsModule.ZendeskOrganization(this,e.id(),e.name(),e.customField(this.s.k.zendesk_field)),this.O.h.populateExtraFieldsFromFrameworkOrgObject(e)),this.we()},we:function(){this.O.isIncluded()&&null===this.ge?(this.switchToLoadingScreen("Loading user from Mailchimp..."),makeAjaxCall(this,this.H.he(this.O.email,this),this.retrievedMailchimpSubscriber,this.b)):this.switchToMainTemplate()},X:function(e,i){(this.O.customer_type=i)!==this.m.Q&&i!==this.m.ee||(e!==this.m.ie&&e!==this.m.p||this.deleteExistingUserFromMailchimp(this.ge),this.switchToMainTemplate()),i!==this.m.p&&i!==this.m.ie||(e===this.m.ee||e===this.m.Q?this.syncNewUserToMailchimp(this.O):e!==i?this.Ue(this.O,!0):this.switchToMainTemplate())},retrievedMailchimpSubscriber:function(e){try{this.ge=connector.T(this,e),this.switchToMainTemplate()}catch(e){console.warn(e),this.C(e,e.message)}},syncNewUserToMailchimp:function(e){var i=this.createNewMailchimpSyncUserObject(e);this.switchToLoadingScreen("Adding Mailchimp Member..."),makeAjaxCall(this,this.H._e(i,!1),this.Me,this.b)},Ue:function(e,i){var t=this.createNewMailchimpSyncUserObject(e);if(void 0!==i&&!0===i&&null!==this.ge&&e.email===this.ge.email_address)for(var n=0;n<this.ge.extra_merge_fields.length;n++)void 0===this.ge.extra_merge_fields[n].field_def.zendesk_field&&(t.extra_merge_fields[n].value=this.ge.extra_merge_fields[n].value);this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.H._e(t,!0),this.Me,this.b)},deleteExistingUserFromMailchimp:function(e){this.switchToLoadingScreen("Deleting Mailchimp Member..."),makeAjaxCall(this,this.H.me(e),null,null,!0)},b:function(){},Ie:function(){return this.Ue(this.O),!1},Re:function(){return this.syncNewUserToMailchimp(this.O),!1},Me:function(e){this.retrievedMailchimpSubscriber(e)},createNewMailchimpSyncUserObject:function(e){var i=e.isDefault();if(null===e)return console.warn("createNewMailchimpSyncUserObject called with null zendeskSyncUserObject"),null;if(!i&&null===e.h)return console.warn("createNewMailchimpSyncUserObject called with customer type "+e.customer_type+" and  null zendeskSyncUserObject.__orgObject"),null;for(var t={email_address:e.email,fe:"subscribed",forename:e.getForeName(),surname:e.getSurname(),customer_type:e.getMailchimpCustomerType(),extra_merge_fields:[]},n=0,s=0;s<e.u.length;s++)t.extra_merge_fields[n]={field_def:e.u[s].field_def,value:null===e.u[s].value?"":e.u[s].value},n++;for(var r=0;r<this.s.n.length;r++)t.extra_merge_fields[n]={field_def:this.s.n[r],value:i?this.s.n[r].default_value:e.h.t[r].o},n++;for(var o=0;o<this.s.A.length;o++)t.extra_merge_fields[n]={field_def:this.s.A[o],value:this.s.A[o].default_value},n++;return t},switchToLoadingScreen:function(e){switchToInlineTemplate(this.m.se,{optional_message:e})},switchToMainTemplate:function(){var e=connector.I(this,this.O,this.ge),i=connector.x(this,e),t=" "+(i||this.O.isExcluded()?"btn-primary":"btn-danger"),n={zendesk_user:this.O,mailchimp_user:this.ge,sync_fields:e,monkey_URL:this.O.isExcluded()?"./img/exclude_monkey.png":i?"./img/insync_monkey.png":"./img/outofsync_monkey.png",buttons:{exclude:{show:!0,classNameInsert:this.O.isExcluded()?" active":"",label:"Exclude",onclick:"excludeButtonOnClick()"},organization:{show:this.O.belongsToOrganization(),classNameInsert:t+(this.O.isOrganization()?" active":""),label:this.S.be,onclick:"organizationButtonOnClick()"},standard:{show:!0,classNameInsert:t+(this.O.isDefault()?" active":""),label:this.S.Ce,onclick:"standardButtonOnClick()"}},display_params:{customer_type_not_set:this.O.isNotset(),customer_type_exclude:this.O.isExcluded(),customer_type_included:this.O.isIncluded(),customer_type_organization:this.O.isOrganization(),customer_type_standard:this.O.isDefault(),user_in_sync:i,DEBUG:debug_mode}};s.main_template_form_data=n,switchToHdbsFileTemplate(this.pe?this.m.ne:this.m.te,n)},C:function(e,i,t,n,s){try{(0===e.status&&void 0===i||null===i||"error"===i)&&(i="Could not connect to API, Please check your internet connection")}catch(e){}var r={errorResponse:e,overrideMessage:void 0===i||"error"===i?null:i,mainButtonClass:void 0===i||"error"===i?"btn-danger":"btn-warning",additionalButtonText:void 0===t?null:t,additionalButtonClass:void 0===n?null:n,additionalButtonOnclick:void 0===s?null:s};switchToHdbsFileTemplate(this.m.re,r)},debugButtonOnClick:function(){return console.log("Starting debugButtonOnClick"),console.dir(this),!1},Oe:function(i,t,e){var n=null,s=null,r=null;try{n=JSON.parse(i)}catch(e){var o="unknown";o=e instanceof SyntaxError?e.name+" "+e.message:e.message,console.error("JSON Validation for settings '%s' Falied with exception e = %o ",t,e),console.error("JSON TEXT WAS: %o ",i),s=e,r="The JSON Settings text you entered for the "+t+" setting was formatted incorrectly, it must be valid JSON.<br /><br />The failure reason was: "+o+'<br /><br />For help with these settings fields use our <a target="_blank" href="'+this.m.f+'">Zenchimp App Settings Generator</a> spreadsheet'}if(null!==n){for(var l=null,a=e?["checkbox"]:["image","text","checkbox"],h=[],u=0;u<n.length;u++)if((l=n[u]).field_label||h.push("Missing Field/Value: field_label"),l.mailchimp_field||h.push("Missing Field/Value: mailchimp_field"),l.type?a.includes(l.type)||h.push("Invalid type: '"+l.type+"'. Valid types are: "+a.toString()+" (all lower case)"):h.push("Missing Field/Value: type"),e?(void 0!==l.value_if_ticked&&null!==l.value_if_ticked||h.push("Missing Field: value_if_ticked. This is required for fields of type 'checkbox'"),void 0!==l.value_if_unticked&&null!==l.value_if_unticked||h.push("Missing Field: value_if_unticked. This is required for fields of type 'checkbox'")):void 0!==l.default_value&&null!==l.default_value||h.push("Missing Field: default_value"),e&&void 0!==l.zendesk_field&&h.push("Field: zendesk_field is not allowed on mailchimp-only field lists"),e||l.zendesk_field||h.push("Missing Field/Value: zendesk_field"),0<h.length){r="Field Definition "+(u+1)+" for the '"+t+"' setting has errors:<br /><br />"+h.join("<br />");break}if(null===r)return n}this.C(s,r)}}};