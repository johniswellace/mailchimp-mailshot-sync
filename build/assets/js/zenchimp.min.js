"use strict";var md5=null;!function(){function c(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function o(e,t,i,n,s,r){return c((a=c(c(t,e),c(n,r)))<<(o=s)|a>>>32-o,i);var a,o}function d(e,t,i,n,s,r,a){return o(t&i|~t&n,e,t,s,r,a)}function _(e,t,i,n,s,r,a){return o(t&n|i&~n,e,t,s,r,a)}function m(e,t,i,n,s,r,a){return o(t^i^n,e,t,s,r,a)}function f(e,t,i,n,s,r,a){return o(i^(t|~n),e,t,s,r,a)}function l(e,t){var i,n,s,r;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var a=1732584193,o=-271733879,l=-1732584194,h=271733878,u=0;u<e.length;u+=16)a=d(i=a,n=o,s=l,r=h,e[u],7,-680876936),h=d(h,a,o,l,e[u+1],12,-389564586),l=d(l,h,a,o,e[u+2],17,606105819),o=d(o,l,h,a,e[u+3],22,-1044525330),a=d(a,o,l,h,e[u+4],7,-176418897),h=d(h,a,o,l,e[u+5],12,1200080426),l=d(l,h,a,o,e[u+6],17,-1473231341),o=d(o,l,h,a,e[u+7],22,-45705983),a=d(a,o,l,h,e[u+8],7,1770035416),h=d(h,a,o,l,e[u+9],12,-1958414417),l=d(l,h,a,o,e[u+10],17,-42063),o=d(o,l,h,a,e[u+11],22,-1990404162),a=d(a,o,l,h,e[u+12],7,1804603682),h=d(h,a,o,l,e[u+13],12,-40341101),l=d(l,h,a,o,e[u+14],17,-1502002290),a=_(a,o=d(o,l,h,a,e[u+15],22,1236535329),l,h,e[u+1],5,-165796510),h=_(h,a,o,l,e[u+6],9,-1069501632),l=_(l,h,a,o,e[u+11],14,643717713),o=_(o,l,h,a,e[u],20,-373897302),a=_(a,o,l,h,e[u+5],5,-701558691),h=_(h,a,o,l,e[u+10],9,38016083),l=_(l,h,a,o,e[u+15],14,-660478335),o=_(o,l,h,a,e[u+4],20,-405537848),a=_(a,o,l,h,e[u+9],5,568446438),h=_(h,a,o,l,e[u+14],9,-1019803690),l=_(l,h,a,o,e[u+3],14,-187363961),o=_(o,l,h,a,e[u+8],20,1163531501),a=_(a,o,l,h,e[u+13],5,-1444681467),h=_(h,a,o,l,e[u+2],9,-51403784),l=_(l,h,a,o,e[u+7],14,1735328473),a=m(a,o=_(o,l,h,a,e[u+12],20,-1926607734),l,h,e[u+5],4,-378558),h=m(h,a,o,l,e[u+8],11,-2022574463),l=m(l,h,a,o,e[u+11],16,1839030562),o=m(o,l,h,a,e[u+14],23,-35309556),a=m(a,o,l,h,e[u+1],4,-1530992060),h=m(h,a,o,l,e[u+4],11,1272893353),l=m(l,h,a,o,e[u+7],16,-155497632),o=m(o,l,h,a,e[u+10],23,-1094730640),a=m(a,o,l,h,e[u+13],4,681279174),h=m(h,a,o,l,e[u],11,-358537222),l=m(l,h,a,o,e[u+3],16,-722521979),o=m(o,l,h,a,e[u+6],23,76029189),a=m(a,o,l,h,e[u+9],4,-640364487),h=m(h,a,o,l,e[u+12],11,-421815835),l=m(l,h,a,o,e[u+15],16,530742520),a=f(a,o=m(o,l,h,a,e[u+2],23,-995338651),l,h,e[u],6,-198630844),h=f(h,a,o,l,e[u+7],10,1126891415),l=f(l,h,a,o,e[u+14],15,-1416354905),o=f(o,l,h,a,e[u+5],21,-57434055),a=f(a,o,l,h,e[u+12],6,1700485571),h=f(h,a,o,l,e[u+3],10,-1894986606),l=f(l,h,a,o,e[u+10],15,-1051523),o=f(o,l,h,a,e[u+1],21,-2054922799),a=f(a,o,l,h,e[u+8],6,1873313359),h=f(h,a,o,l,e[u+15],10,-30611744),l=f(l,h,a,o,e[u+6],15,-1560198380),o=f(o,l,h,a,e[u+13],21,1309151649),a=f(a,o,l,h,e[u+4],6,-145523070),h=f(h,a,o,l,e[u+11],10,-1120210379),l=f(l,h,a,o,e[u+2],15,718787259),o=f(o,l,h,a,e[u+9],21,-343485551),a=c(a,i),o=c(o,n),l=c(l,s),h=c(h,r);return[a,o,l,h]}function h(e){for(var t="",i=0;i<32*e.length;i+=8)t+=String.fromCharCode(e[i>>5]>>>i%32&255);return t}function u(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;for(t=0;t<8*e.length;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function n(e){for(var t,i="0123456789abcdef",n="",s=0;s<e.length;s+=1)t=e.charCodeAt(s),n+=i.charAt(t>>>4&15)+i.charAt(15&t);return n}function i(e){return unescape(encodeURIComponent(e))}function s(e){return h(l(u(t=i(e)),8*t.length));var t}function r(e,t){return function(e,t){var i,n,s=u(e),r=[],a=[];for(r[15]=a[15]=void 0,16<s.length&&(s=l(s,8*e.length)),i=0;i<16;i+=1)r[i]=909522486^s[i],a[i]=1549556828^s[i];return n=l(r.concat(u(t)),512+8*t.length),h(l(a.concat(n),640))}(i(e),i(t))}md5=function(e,t,i){return t?i?r(t,e):n(r(t,e)):i?s(e):n(s(e))}}();var NameParse=function(){function e(){return e}return e.parse=function(e){var t,i="",n="",s="",r=null,a=0,o=0,l=(t=(e=e.trim()).split(" ").filter(function(e){return-1===e.indexOf("(")})).length,h=this.is_salutation(t[0]),u=this.is_suffix(t[l-1]),c=h?1:0,d=u?l-1:l,r=t[c];for(this.is_initial(r)?this.is_initial(t[1+c])?n+=" "+r.toUpperCase():s+=" "+r.toUpperCase():n+=" "+this.fix_case(r),o=1+c;o<d-1&&(r=t[o],!this.is_compound_lastName(r));o++)this.is_initial(r)?s+=" "+r.toUpperCase():n+=" "+this.fix_case(r);if(1<d-c)for(a=o;a<d;a++)i+=" "+this.fix_case(t[a]);return{salutation:h||"",firstName:n.trim(),initials:s.trim(),lastName:i.trim(),suffix:u||""}},e.removeIgnoredChars=function(e){return e.replace(".","")},e.is_salutation=function(e){return"mr"===(e=this.removeIgnoredChars(e).toLowerCase())||"master"===e||"mister"===e?"Mr.":"mrs"===e?"Mrs.":"miss"===e||"ms"===e?"Ms.":"dr"===e?"Dr.":"rev"===e?"Rev.":"fr"===e&&"Fr."},e.is_suffix=function(e){e=this.removeIgnoredChars(e).toLowerCase();var t=["I","II","III","IV","V","Senior","Junior","Jr","Sr","PhD","APR","RPh","PE","MD","MA","DMD","CME","BVM","CFRE","CLU","CPA","CSC","CSJ","DC","DD","DDS","DO","DVM","EdD","Esq","JD","LLD","OD","OSB","PC","Ret","RGS","RN","RNC","SHCJ","SJ","SNJM","SSMO","USA","USAF","USAFR","USAR","USCG","USMC","USMCR","USN","USNR"],i=t.map(function(e){return e.toLowerCase()}).indexOf(e);return 0<=i&&t[i]},e.is_compound_lastName=function(e){e=e.toLowerCase();return 0<=["vere","von","van","de","del","della","di","da","pietro","vanden","du","st.","st","la","lo","ter"].indexOf(e)},e.is_initial=function(e){return 1===(e=this.removeIgnoredChars(e)).length},e.is_camel_case=function(e){return/[A-Z]+/.exec(e)&&/[a-z]+/.exec(e)},e.fix_case=function(e){return e=this.safe_ucfirst("-",e),e=this.safe_ucfirst(".",e)},e.safe_ucfirst=function(e,t){return t.split(e).map(function(e){return this.is_camel_case(e)?e:e.substr(0,1).toUpperCase()+e.substr(1).toLowerCase()},this).join(e)},e}();function ZendeskOrganization(e,t,i,n){this.app=e,this.id=t,this.name=i,this.customer_type=n,this.extra_org_fields=[];for(var s=0;s<e.field_maps.organisation.length;s++)this.extra_org_fields[s]={field_def:e.field_maps.organisation[s],value:null}}function ZendeskUser(e,t,i,n,s,r){this.app=e,this.id=t,this.name=i,this.name_parts=null,this.email=n,this.customer_type=s,this.organization_id=void 0===r?null:r,this.orgObject=null,this.extra_user_fields=[];for(var a=0;a<e.field_maps.user.length;a++)this.extra_user_fields[a]={field_def:e.field_maps.user[a],value:null}}ZendeskOrganization.prototype.populateExtraFieldsFromOrganizationAPIData=function(e){for(var t=0;t<this.extra_org_fields.length;t++)this.extra_org_fields[t].value=e.organization_fields[this.extra_org_fields[t].field_def.zendesk_field]},ZendeskOrganization.prototype.populateExtraFieldsFromFrameworkOrgObject=function(e){for(var t=0;t<this.extra_org_fields.length;t++)this.extra_org_fields[t].value=e.customField(this.extra_org_fields[t].field_def.zendesk_field)},ZendeskOrganization.prototype.clone=function(){for(var e=new ZendeskOrganization(this.app,this.id,this.name,this.customer_type),t=0;t<this.extra_org_fields.length;t++)e.extra_org_fields[t]={field_def:this.extra_org_fields[t].field_def,value:this.extra_org_fields[t].value};return e},ZendeskUser.prototype.getSalutation=function(){return this.populateNamePartsIfNecessary(),null===this.name_parts.salutation?"":this.name_parts.salutation.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.getForeName=function(){return this.populateNamePartsIfNecessary(),null===this.name_parts.firstName?"":this.name_parts.firstName.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.getSurname=function(){return this.populateNamePartsIfNecessary(),null===this.name_parts.lastName?"":this.name_parts.lastName.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.populateNamePartsIfNecessary=function(){null===this.name_parts&&null!==this.name&&(this.name_parts=this.app.parseNamesModule.parse(this.name.replace("/"," ").replace("."," ").split(",").reverse().map(Function.prototype.call,String.prototype.trim).join(" ")))},ZendeskUser.prototype.populateExtraFieldsFromUserAPIData=function(e){for(var t=0;t<this.extra_user_fields.length;t++)this.extra_user_fields[t].value=e.user_fields[this.extra_user_fields[t].field_def.zendesk_field]},ZendeskUser.prototype.populateExtraFieldsFromFrameworkUserObject=function(e){for(var t=0;t<this.extra_user_fields.length;t++)this.extra_user_fields[t].value=e.customField(this.extra_user_fields[t].field_def.zendesk_field)},ZendeskUser.prototype.clone=function(){var e=new ZendeskUser(this.app,this.id,this.name,this.email,this.customer_type,this.organization_id);e.orgObject=null===this.orgObject?null:this.orgObject.clone();for(var t=0;t<this.extra_user_fields.length;t++)e.extra_user_fields[t]={field_def:this.extra_user_fields[t].field_def,value:this.extra_user_fields[t].value};return e},ZendeskUser.prototype.isNotset=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_NOT_SET},ZendeskUser.prototype.isExcluded=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_EXCLUDE},ZendeskUser.prototype.isIncluded=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_ORGANIZATION||this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.isOrganization=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_ORGANIZATION},ZendeskUser.prototype.isDefault=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.belongsToOrganization=function(){return null!==this.organization_id},ZendeskUser.prototype.orgObjectIsPopulated=function(){return null!==this.orgObject},ZendeskUser.prototype.getMailchimpCustomerType=function(){return void 0===this.customer_type||null===this.customer_type?(console.warn("ZendeskUser.getMailchimpCustomerType() called with invalid customer_type, this = "),console.dir(this),null):this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_ORGANIZATION?this.orgObject.customer_type:this.app.field_maps.cust_type.default_value},ZendeskUser.prototype.findExtraFieldByName=function(e,t){for(var i=0;i<this.extra_user_fields.length;i++)if(t&&this.extra_user_fields[i].field_def.zendesk_field===e||!t&&this.extra_user_fields[i].field_def.mailchimp_field===e)return this.extra_user_fields[i]},ZendeskUser.prototype.getFieldSyncInfo=function(e){if(null==e)return null;if(void 0===this.customer_type||null===this.customer_type||this.isNotset())return console.warn("ZendeskUser.getFieldSyncInfo() called with invalid customer_type, this = "),console.dir(this),null;for(var t=[{label:"Email",mc_only:!1,zd_field_location:"user",is_image:!1,zd_value:this.email,mc_value:e.email_address,in_sync:this.email.toLowerCase()===e.email_address.toLowerCase()},{label:"Name",mc_only:!1,zd_field_location:"user",is_image:!1,zd_value:this.name,mc_value:"["+e.forename+"] ["+e.surname+"]",in_sync:e.forename.toLowerCase()===this.getForeName().toLowerCase()&&e.surname.toLowerCase()===this.getSurname().toLowerCase()},{label:"Customer Type",mc_only:!1,zd_field_location:"user",is_image:!1,zd_value:this.getMailchimpCustomerType(),mc_value:e.customer_type,in_sync:this.getMailchimpCustomerType()===e.customer_type}],i=null,n=null,s=0,r=0;r<this.extra_user_fields.length;r++)i=null===(i=this.extra_user_fields[r].value)?"":i,n=null===(n=e.extra_merge_fields[s].value)?"":n,t[s+3]={label:this.extra_user_fields[r].field_def.field_label,zd_field_location:"user",is_image:this.extra_user_fields[r].field_def.type===this.app.resources.TYPE_IMAGE,zd_value:i,mc_value:n,in_sync:i===n},s++;for(r=0;r<this.app.field_maps.organisation.length;r++)i=null===(i=this.isDefault()?this.app.field_maps.organisation[r].default_value:this.isOrganization()?this.orgObject.extra_org_fields[r].value:null)?"":i,n=null===(n=e.extra_merge_fields[s].value)?"":n,t[s+3]={label:this.app.field_maps.organisation[r].field_label,zd_field_location:"organisation",is_image:this.app.field_maps.organisation[r].type===this.app.resources.TYPE_IMAGE,zd_value:i,mc_value:n,in_sync:i===n},s++;for(r=0;r<this.app.field_maps.mc_only.length;r++)n=null===(n=e.extra_merge_fields[s].value)?"":n,t[s+3]={label:this.app.field_maps.mc_only[r].field_label,zd_field_location:null,is_image:this.app.field_maps.mc_only[r].type===this.app.resources.TYPE_IMAGE,is_checkbox:this.app.field_maps.mc_only[r].type===this.app.resources.TYPE_CHECKBOX,is_checkbox_ticked:this.app.field_maps.mc_only[r].type!==this.app.resources.TYPE_CHECKBOX?null:"1"===n||1===n,zd_value:null,mc_value:n,in_sync:!0},s++;return t},ZendeskUser.prototype.isInSync=function(e,t){if(null==e&&(e=this.getFieldSyncInfo(t)),null===e)return!1;for(var i=0;i<e.length;i++)if(!e[i].in_sync)return!1;return!0};var debug_mode=!0,thisV2Client=ZAFClient.init();function switchToHdbsFileTemplate(e,i){var n=$("#page_content");$(n).empty().html('<div class="alert alert-info">Loading...</div><div class="text-center"><div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div></div>'),$.ajax(e).done(function(e){var t=Handlebars.compile(e)(i);$(n).empty().html(t)})}function switchToInlineTemplate(e,t){var i=$("#"+e).html(),n=Handlebars.compile(i)(t),s=$("#page_content");$(s).empty().html(n)}function modal_createChildFromParent(e){var t={location:"modal",size:{width:"700px",height:"450px"},url:"assets/modal-iframe.html#parent_guid="+encodeURIComponent(e.instanceGuid)+"&parent_location="+encodeURIComponent(e.location)};thisV2Client.invoke("instances.create",t).then(function(e){console.log("SUCCESS CREATING MODAL, success = %o",e)},function(e){console.error("FAILURE CREATING MODAL, success = %o",e)})}function getClientInstanceFromGuid(e){return thisV2Client.instance(e)}function parseURLParams(e){var t=e.replace("#","").split("&");debug_mode&&console.log("Split into individual strings: param_sub = %o",t);for(var i={},n=0;n<t.length;++n){var s=t[n].split("=");i[s[0]]=s[1]}return i}function makeAjaxCall(t,e,i,n,s){void 0!==s&&s&&(e.cors=!1),thisV2Client.request(e).then(function(e){null==i?console.warn("AJAX SUCCESS: and no successFunction was defined so no futher action can be taken to handle the response. returned data = %o",e):i.call(t,e)},function(e){null==n?console.warn("AJAX FAIL: and no failFunction was defined so no futher action can be taken to handle the error. error response = %o",e):n.call(t,e)})}function __3rdParty_get_or_createOrUpadate3rdPartyMember_OnFail(e,t){var i=!1;try{var n=JSON.parse(t.responseText);if(400===t.status&&"Member Exists"===n.title&&(e.e(t,e.t.email+" already exists in mailchimp.<br /><br/>Do you want to override his/her details?","Override","error_override_mailchimp","__createOrUpadateMailChimpListMember_Override_OnClick()"),i=!0),400===t.status&&"Invalid Resource"===n.title){var s="<p><b>On no, Mailchimp rejected one of your values</b></p><p>This is often a broken link or URL, an incorrect data type, or no value for a required field in Mailchimp. Here's what Mailchimp is saying...</p>";void 0!==n.title&&(s+="<p><b>"+n.title+"</b>",void 0!==n.detail&&(s+=": "+n.detail),s+="</p>");var r=n.errors;if(void 0!==r&&0<r.length){s+="<p>The following fields had issues:<ul>",console.log(r.lenth);for(var a=0,o=r[a];void 0!==o;)console.log("here"),s+="<li><b> Field: "+o.field+"</b> - "+o.message+"</li>",o=r[++a];s+="</ul></p>"}e.e(t,s),i=!0}404===t.status&&(e.e(t,e.t.email+" doesn't exist in mailchimp.<br /><br/>Do you want to create a new record for him/her?","Create New","error_create_new_mailchimp","__createOrUpadateMailChimpListMember_Add_New_OnClick()"),i=!0)}catch(e){console.warn("Could not JSON Parse errorResponse.responseText from get_or___createOrUpadateMailChimpListMember. errorResponse = %o\n\nparse exception: %o",t,e)}i||e.e(t)}var pluginFactory=function(s){return{i:s,n:null,s:{r:"ticket_sidebar",a:"user_sidebar",o:"text",l:"image",h:"checkbox",u:"mailshot_customer_type",c:"mailshot_customer_display_name",d:null,_:"mailshot_exclude_from_mailshot",m:"mailshot_use_default_values",f:"mailshot_use_organisation_values",p:"./templates/main.hdbs",v:"./templates/sync-modal.hdbs",g:"loading-screen-template",C:"./templates/show_error.hdbs",T:"https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/raw/master/extras/ZenchimpSettingsGenerator.xlsx"},O:{"user.id.changed":"resetAppIfPageFullyLoaded","user.mailshot_customer_type.changed":"__userScreenCustomerTypeFieldChanged","*.changed":"__formFieldChanged"},U:{k:null,b:function(e){return{url:"https://upnrunning.zendesk.com/api/v2/users/"+encodeURIComponent(e)+".json",type:"GET",dataType:"json"}},y:function(e){return{url:"/api/v2/users/create_or_update.json",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({user:{id:e.id,email:e.email,user_fields:{mailshot_customer_type:e.customer_type}}})}},M:function(e,t){return{url:null!=t?"/api/v2/organizations/"+encodeURIComponent(t)+".json":"/api/v2/users/"+encodeURIComponent(e)+".organizations.json",type:"GET",dataType:"json"}},S:function(e){if(null==e)return console.error("ERROR CONDITION: __getMailChimpListMember called with null email address");var t=md5(e.toLowerCase());return{url:"https://"+encodeURIComponent(this.k.R.A)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.k.R.I)+"/members/"+encodeURIComponent(t),type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.k.R.F)}}},N:function(e,t){if(null===e||null===e.email_address)return console.warn("ERROR CONDITION: __createOrUpadateMailChimpListMember called with either null user or user with no email address");var i=md5(e.email_address.toLowerCase()),n={};n[this.k.R.L]=e.forename,n[this.k.R.w]=e.surname,n[this.k.R.D]=e.customer_type;for(var s=0;s<e.extra_merge_fields.length;s++)n[e.extra_merge_fields[s].field_def.mailchimp_field]=e.extra_merge_fields[s].value;var r={id:i,email_address:e.email_address,email_type:"html",status:e.P,status_if_new:"subscribed",merge_fields:n,vip:e.customer_type===this.k.s.f};return{url:"https://"+encodeURIComponent(this.k.R.A)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.k.R.I)+"/members/"+encodeURIComponent(t?i:""),type:t?"PUT":"POST",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.k.R.F)},data:JSON.stringify(r)}},Z:function(e){if(null===e||null===e.email_address)return console.error("ERROR CONDITION: __deleteMailChimpListMember called with either null user or user with no email address");var t=md5(e.email_address.toLowerCase());return{url:"https://"+encodeURIComponent(this.k.R.A)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.k.R.I)+"/members/"+encodeURIComponent(t),type:"DELETE",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.k.R.F)}}}},init:function(e,t){var i=this,n=this.s;this.resources={TYPE_TEXT:n.o,TYPE_IMAGE:n.l,TYPE_CHECKBOX:n.h,CUSTOMER_TYPE_NOT_SET:n.d,CUSTOMER_TYPE_EXCLUDE:n._,CUSTOMER_TYPE_USE_DEFAULT:n.m,CUSTOMER_TYPE_USE_ORGANIZATION:n.f},s.on("ticket.requester.id.changed",function(){i.resetAppIfPageFullyLoaded()}),s.on("user.email.changed",function(){i.resetAppIfPageFullyLoaded()}),s.on("user.name.changed",function(){i.resetAppIfPageFullyLoaded()}),s.on("user.organizations.changed",function(){i.resetAppIfPageFullyLoaded()}),s.on("*.changed",function(e){i.x(e)}),(this.U.k=this).z=null!=e&&e,this.zendeskObjectsModule={ZendeskOrganization:ZendeskOrganization,ZendeskUser:ZendeskUser},this.parseNamesModule=NameParse,this.j=null,this.t=null,this.B=!1,this.n=void 0===t?null:t,null===this.n&&this.i.context().then(function(e){i.n=e,i.H(),i.resetAppIfPageFullyLoaded()},function(e){i.e(e,"Could not get app __context, please check your internet connection and try again")}),this.J=!1,this.R={},this.G={},this.i.metadata().then(function(e){var t=e.settings;i.R={F:t.mailchimp_api_key,A:t.mailchimp_datacentre_prefix,I:t.mailchimp_list_id,L:t.mailchimp_merge_field_forename,w:t.mailchimp_merge_field_surname,D:t.mailchimp_merge_field_customer_type,Y:t.mailchimp_merge_field_customer_type_default_val,V:t.mailchimp_organisation_button_label,X:t.mailchimp_standard_button_label},i.G={q:{zendesk_field:i.s.c,mailchimp_field:i.R.D,type:i.s.$,default_value:i.R.Y},K:i.W(t.mailchimp_organization_field_mappings,"Organisation Field Mapping",!1),Q:i.W(t.mailchimp_user_field_mappings,"User Field Mapping",!1),ee:i.W(t.mailchimp_mailshot_only_field_mappings,"Mailchimp Only Field Mapping",!0)},i.field_maps={cust_type:i.G.q,organisation:i.G.K,user:i.G.Q,mc_only:i.G.ee},null!==i.G.K&&null!==i.G.Q&&null!==i.G.ee&&(i.J=!0,i.resetAppIfPageFullyLoaded())},function(e){i.e(e,"Could not get your app settings, please check your internet connection and try again")})},resetAppIfPageFullyLoaded:function(){var e,i=this;!this.B&&null===this.n||!this.B&&!this.J||(this.B||null!==this.t?(this.j=null,this.n.location===this.s.r?this.switchToLoadingScreen("Loading Ticket Requester..."):this.n.location===this.s.a&&(this.switchToLoadingScreen("Loading Zendesk User..."),console.warn("MAYBE NEED TO REPLACE THIS CODE WITH A CALL TO this.getUserFromFrameworkInUserSidebarLocation(); IN WHICH WE MIGHT BE ABLE TO CREATE THE ZENDESK USER OJBECT FROM THE EXISTING TEMP ZENDESK USER OBJECT (this.__zendesk_user) RETURNED FROM ResetAppIfNotFullyLoaded()")),makeAjaxCall(this,this.U.b(this.t.id),this.te,this.e),this.B=!0):(e=this.n.location===this.s.r?"ticket.requester":"user",this.i.get(e).then(function(e){var t=i.n.location===i.s.r?"ticket.requester":"user";i.t=e[t],i.resetAppIfPageFullyLoaded()},function(e){i.e(e,"Could not get the ticket info, please check your internet connection and try again")})))},H:function(){var t=this;this.n.location===this.s.a&&this.i.get("userFields:"+this.s.u+".isVisible").then(function(e){e["userFields:"+t.s.u+".isVisible"]&&t.i.invoke("userFields:"+t.s.u+".hide")},function(e){t.e(e,"Could access a Zendesk User Field with a Field Key of '"+t.s.u+"' Please check your internet connection or reinstall the app if this issue persists;")})},x:function(e){var t=null;if(this.n.location===this.s.a){var i=e.propertyName;if(i==="user."+this.s.u)this.ie(e.newValue);else for(var n=0;n<this.G.Q.length;n++)if(i==="user."+this.G.Q[n].zendesk_field){t=this.G.Q[n].zendesk_field;break}}null!==t&&void 0!==this.t&&null!==this.t&&(this.t.findExtraFieldByName(t,!0).value=e.newValue,this.switchToMainTemplate())},ie:function(e){var t=this.t.customer_type;this.t.customer_type=e,this.ne(t,e)},syncButtonFromModalOnClick:function(){return this.syncButtonPressed=!0,this.se(this.t,!0),!1},mailchimpOnlyField_OnClick:function(e){for(var t=null,i=0;i<this.j.extra_merge_fields.length;i++)void 0===(t=this.j.extra_merge_fields[i]).field_def.zendesk_field&&"MC_ONLY_"+t.field_def.mailchimp_field===e.target.id&&(t.field_def.type===this.s.h?t.value=null===t.value||!1===t.value||"0"===t.value||0===t.value||""===t.value||"NO"===t.value.toString().toUpperCase()||"FALSE"===t.value.toString().toUpperCase()?"1":"0":console.error("Unsupported field type '%s' (only 'checkbox' supported) on mailchimp extra merge field: %o"+t.type,t));this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.U.N(this.j,!0),this.re,this.ae)},excludeButtonOnClick:function(){var e=this.t.clone();return e.customer_type=this.s._,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.U.y(e),this.oe,this.e),!1},organizationButtonOnClick:function(){var e=this.t.clone();return e.customer_type=this.s.f,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.U.y(e),this.oe,this.e),!1},standardButtonOnClick:function(){var e=this.t.clone();return e.customer_type=this.s.m,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.U.y(e),this.oe,this.e),!1},te:function(e){this.t=this.le(e),this.t.isOrganization()&&this.t.belongsToOrganization()?(this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.U.M(this.t.id,this.t.organization_id),this.he,this.e)):this.ue(),this.t=this.le(e)},le:function(e){var t=null;return null!==e?(t=new this.zendeskObjectsModule.ZendeskUser(this,e.user.id,e.user.name,e.user.email,e.user.user_fields.mailshot_customer_type,void 0!==e.user.organization_id&&null!==e.user.organization_id?e.user.organization_id:null)).populateExtraFieldsFromUserAPIData(e.user):console.error("__createZendeskUserFromAPIReturnData called but userObjectFromDataAPI = null - this should never happen!"),t},oe:function(e){var t=this.le(e);t.orgObject=this.t.orgObject;var i=this.t.customer_type;this.t=t,this.t.isOrganization()&&this.t.belongsToOrganization()&&!this.t.orgObjectIsPopulated()?(this.t.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null===i?"NOTSET":i,this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.U.M(this.t.id,this.t.organization_id),this.he,this.e)):this.ne(i,this.t.customer_type)},he:function(e){var t;this.t.orgObject=this.createZendeskOrganizationFromAPIReturnData(e),void 0!==this.t.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs&&null!==this.t.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?(t="NOTSET"===this.t.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?null:this.t.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs,this.t.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null,this.ne(t,this.t.customer_type)):this.ue()},createZendeskOrganizationFromAPIReturnData:function(e){var t=null;return null!=e&&void 0!==e.organization&&null!==e.organization?(t=new this.zendeskObjectsModule.ZendeskOrganization(this,e.organization.id,e.organization.name,e.organization.organization_fields[this.G.q.zendesk_field])).populateExtraFieldsFromOrganizationAPIData(e.organization):console.warn("createZendeskOrganizationFromAPIReturnData called but organizationObjectFromDataAPI = null or doesnt contain a organization property - this should never happen!"),t},ce:function(){var e=void 0!==this.user().organizations()[0]&&null!==this.user().organizations()[0]?this.user().organizations()[0]:null;this.t=new this.zendeskObjectsModule.ZendeskUser(this,this.user().id(),this.user().name(),this.user().email(),this.user().customField(this.s.u),null===e?null:e.id()),this.t.populateExtraFieldsFromFrameworkUserObject(this.user()),null!==e&&(this.t.orgObject=new this.zendeskObjectsModule.ZendeskOrganization(this,e.id(),e.name(),e.customField(this.G.q.zendesk_field)),this.t.orgObject.populateExtraFieldsFromFrameworkOrgObject(e)),this.ue()},ue:function(){this.t.isIncluded()&&null===this.j?(this.switchToLoadingScreen("Loading user from Mailchimp..."),makeAjaxCall(this,this.U.S(this.t.email,this),this.retrievedMailchimpSubscriber,this.ae)):this.switchToMainTemplate()},ne:function(e,t){(this.t.customer_type=t)!==this.s.d&&t!==this.s._||(e!==this.s.m&&e!==this.s.f||this.deleteExistingUserFromMailchimp(this.j),this.switchToMainTemplate()),t!==this.s.f&&t!==this.s.m||(e===this.s._||e===this.s.d?this.syncNewUserToMailchimp(this.t):e!==t?this.se(this.t,!0):this.switchToMainTemplate())},retrievedMailchimpSubscriber:function(e){this.j={email_address:e.email_address,status:"subscribed",forename:e.merge_fields[this.R.L],surname:e.merge_fields[this.R.w],customer_type:e.merge_fields[this.G.q.mailchimp_field],extra_merge_fields:[]};for(var t=0,i=0;i<this.G.Q.length;i++)this.j.extra_merge_fields[t]={field_def:this.G.Q[i],value:e.merge_fields[this.G.Q[i].mailchimp_field]},t++;for(var n=0;n<this.G.K.length;n++)this.j.extra_merge_fields[t]={field_def:this.G.K[n],value:e.merge_fields[this.G.K[n].mailchimp_field]},t++;for(var s=0;s<this.G.ee.length;s++)this.j.extra_merge_fields[t]={field_def:this.G.ee[s],value:e.merge_fields[this.G.ee[s].mailchimp_field]},t++;this.switchToMainTemplate()},syncNewUserToMailchimp:function(e){var t=this.createNewMailchimpSyncUserObject(e);this.switchToLoadingScreen("Adding Mailchimp Member..."),makeAjaxCall(this,this.U.N(t,!1),this.re,this.ae)},se:function(e,t){var i=this.createNewMailchimpSyncUserObject(e);if(void 0!==t&&!0===t&&null!==this.j&&e.email===this.j.email_address)for(var n=0;n<this.j.extra_merge_fields.length;n++)void 0===this.j.extra_merge_fields[n].field_def.zendesk_field&&(i.extra_merge_fields[n].value=this.j.extra_merge_fields[n].value);this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.U.N(i,!0),this.re,this.ae)},deleteExistingUserFromMailchimp:function(e){this.switchToLoadingScreen("Deleting Mailchimp Member..."),makeAjaxCall(this,this.U.Z(e),null,null,!0)},ae:function(){},de:function(){return this.se(this.t),!1},_e:function(){return this.syncNewUserToMailchimp(this.t),!1},re:function(e){this.retrievedMailchimpSubscriber(e)},createNewMailchimpSyncUserObject:function(e){var t=e.isDefault();if(null===e)return console.warn("createNewMailchimpSyncUserObject called with null zendeskSyncUserObject"),null;if(!t&&null===e.orgObject)return console.warn("createNewMailchimpSyncUserObject called with customer type "+e.customer_type+" and  null zendeskSyncUserObject.orgObject"),null;for(var i={email_address:e.email,P:"subscribed",forename:e.getForeName(),surname:e.getSurname(),customer_type:e.getMailchimpCustomerType(),extra_merge_fields:[]},n=0,s=0;s<e.extra_user_fields.length;s++)i.extra_merge_fields[n]={field_def:e.extra_user_fields[s].field_def,value:null===e.extra_user_fields[s].value?"":e.extra_user_fields[s].value},n++;for(var r=0;r<this.G.K.length;r++)i.extra_merge_fields[n]={field_def:this.G.K[r],value:t?this.G.K[r].default_value:e.orgObject.extra_org_fields[r].value},n++;for(var a=0;a<this.G.ee.length;a++)i.extra_merge_fields[n]={field_def:this.G.ee[a],value:this.G.ee[a].default_value},n++;return i},switchToLoadingScreen:function(e){switchToInlineTemplate(this.s.g,{optional_message:e})},switchToMainTemplate:function(){var e=this.t.getFieldSyncInfo(this.j),t=this.t.isInSync(e),i=" "+(t||this.t.isExcluded()?"btn-primary":"btn-danger"),n={zendesk_user:this.t,mailchimp_user:this.j,sync_fields:e,monkey_URL:this.t.isExcluded()?"./img/exclude_monkey.png":t?"./img/insync_monkey.png":"./img/outofsync_monkey.png",buttons:{exclude:{show:!0,classNameInsert:this.t.isExcluded()?" active":"",label:"Exclude",onclick:"excludeButtonOnClick()"},organization:{show:this.t.belongsToOrganization(),classNameInsert:i+(this.t.isOrganization()?" active":""),label:this.R.V,onclick:"organizationButtonOnClick()"},standard:{show:!0,classNameInsert:i+(this.t.isDefault()?" active":""),label:this.R.X,onclick:"standardButtonOnClick()"}},display_params:{customer_type_not_set:this.t.isNotset(),customer_type_exclude:this.t.isExcluded(),customer_type_included:this.t.isIncluded(),customer_type_organization:this.t.isOrganization(),customer_type_standard:this.t.isDefault(),user_in_sync:t,DEBUG:debug_mode}};s.main_template_form_data=n,switchToHdbsFileTemplate(this.z?this.s.v:this.s.p,n)},e:function(e,t,i,n,s){try{(0===e.status&&void 0===t||null===t||"error"===t)&&(t="Could not connect to API, Please check your internet connection")}catch(e){}var r={errorResponse:e,overrideMessage:void 0===t||"error"===t?null:t,mainButtonClass:void 0===t||"error"===t?"btn-danger":"btn-warning",additionalButtonText:void 0===i?null:i,additionalButtonClass:void 0===n?null:n,additionalButtonOnclick:void 0===s?null:s};switchToHdbsFileTemplate(this.s.C,r)},debugButtonOnClick:function(){return console.log("Starting debugButtonOnClick"),console.dir(this),!1},W:function(t,i,e){var n=null,s=null,r=null;try{n=JSON.parse(t)}catch(e){var a="unknown";a=e instanceof SyntaxError?e.name+" "+e.message:e.message,console.error("JSON Validation for settings '%s' Falied with exception e = %o ",i,e),console.error("JSON TEXT WAS: %o ",t),s=e,r="The JSON Settings text you entered for the "+i+" setting was formatted incorrectly, it must be valid JSON.<br /><br />The failure reason was: "+a+'<br /><br />For help with these settings fields use our <a target="_blank" href="'+this.s.T+'">Zenchimp App Settings Generator</a> in Microsoft Excel'}if(null!==n){for(var o=null,l=e?["checkbox"]:["image","text","checkbox"],h=[],u=0;u<n.length;u++)if((o=n[u]).field_label||h.push("Missing Field/Value: field_label"),o.mailchimp_field||h.push("Missing Field/Value: mailchimp_field"),o.type?l.includes(o.type)||h.push("Invalid type: '"+o.type+"'. Valid types are: "+l.toString()+" (all lower case)"):h.push("Missing Field/Value: type"),void 0!==o.default_value&&null!==o.default_value||h.push("Missing Field: default_value"),e&&void 0!==o.zendesk_field&&h.push("Field: zendesk_field is not allowed on mailchimp-only field lists"),e||o.zendesk_field||h.push("Missing Field/Value: zendesk_field"),0<h.length){r="Field Definition "+(u+1)+" for the '"+i+"' setting has errors:<br /><br />"+h.join("<br />");break}if(null===r)return n}this.e(s,r)}}};