"use strict";var md5=null;!function(){function c(t,i){var e=(65535&t)+(65535&i);return(t>>16)+(i>>16)+(e>>16)<<16|65535&e}function l(t,i,e,n,s,r){return c((a=c(c(i,t),c(n,r)))<<(l=s)|a>>>32-l,e);var a,l}function d(t,i,e,n,s,r,a){return l(i&e|~i&n,t,i,s,r,a)}function _(t,i,e,n,s,r,a){return l(i&n|e&~n,t,i,s,r,a)}function m(t,i,e,n,s,r,a){return l(i^e^n,t,i,s,r,a)}function f(t,i,e,n,s,r,a){return l(e^(i|~n),t,i,s,r,a)}function o(t,i){var e,n,s,r;t[i>>5]|=128<<i%32,t[14+(i+64>>>9<<4)]=i;for(var a=1732584193,l=-271733879,o=-1732584194,h=271733878,u=0;u<t.length;u+=16)a=d(e=a,n=l,s=o,r=h,t[u],7,-680876936),h=d(h,a,l,o,t[u+1],12,-389564586),o=d(o,h,a,l,t[u+2],17,606105819),l=d(l,o,h,a,t[u+3],22,-1044525330),a=d(a,l,o,h,t[u+4],7,-176418897),h=d(h,a,l,o,t[u+5],12,1200080426),o=d(o,h,a,l,t[u+6],17,-1473231341),l=d(l,o,h,a,t[u+7],22,-45705983),a=d(a,l,o,h,t[u+8],7,1770035416),h=d(h,a,l,o,t[u+9],12,-1958414417),o=d(o,h,a,l,t[u+10],17,-42063),l=d(l,o,h,a,t[u+11],22,-1990404162),a=d(a,l,o,h,t[u+12],7,1804603682),h=d(h,a,l,o,t[u+13],12,-40341101),o=d(o,h,a,l,t[u+14],17,-1502002290),a=_(a,l=d(l,o,h,a,t[u+15],22,1236535329),o,h,t[u+1],5,-165796510),h=_(h,a,l,o,t[u+6],9,-1069501632),o=_(o,h,a,l,t[u+11],14,643717713),l=_(l,o,h,a,t[u],20,-373897302),a=_(a,l,o,h,t[u+5],5,-701558691),h=_(h,a,l,o,t[u+10],9,38016083),o=_(o,h,a,l,t[u+15],14,-660478335),l=_(l,o,h,a,t[u+4],20,-405537848),a=_(a,l,o,h,t[u+9],5,568446438),h=_(h,a,l,o,t[u+14],9,-1019803690),o=_(o,h,a,l,t[u+3],14,-187363961),l=_(l,o,h,a,t[u+8],20,1163531501),a=_(a,l,o,h,t[u+13],5,-1444681467),h=_(h,a,l,o,t[u+2],9,-51403784),o=_(o,h,a,l,t[u+7],14,1735328473),a=m(a,l=_(l,o,h,a,t[u+12],20,-1926607734),o,h,t[u+5],4,-378558),h=m(h,a,l,o,t[u+8],11,-2022574463),o=m(o,h,a,l,t[u+11],16,1839030562),l=m(l,o,h,a,t[u+14],23,-35309556),a=m(a,l,o,h,t[u+1],4,-1530992060),h=m(h,a,l,o,t[u+4],11,1272893353),o=m(o,h,a,l,t[u+7],16,-155497632),l=m(l,o,h,a,t[u+10],23,-1094730640),a=m(a,l,o,h,t[u+13],4,681279174),h=m(h,a,l,o,t[u],11,-358537222),o=m(o,h,a,l,t[u+3],16,-722521979),l=m(l,o,h,a,t[u+6],23,76029189),a=m(a,l,o,h,t[u+9],4,-640364487),h=m(h,a,l,o,t[u+12],11,-421815835),o=m(o,h,a,l,t[u+15],16,530742520),a=f(a,l=m(l,o,h,a,t[u+2],23,-995338651),o,h,t[u],6,-198630844),h=f(h,a,l,o,t[u+7],10,1126891415),o=f(o,h,a,l,t[u+14],15,-1416354905),l=f(l,o,h,a,t[u+5],21,-57434055),a=f(a,l,o,h,t[u+12],6,1700485571),h=f(h,a,l,o,t[u+3],10,-1894986606),o=f(o,h,a,l,t[u+10],15,-1051523),l=f(l,o,h,a,t[u+1],21,-2054922799),a=f(a,l,o,h,t[u+8],6,1873313359),h=f(h,a,l,o,t[u+15],10,-30611744),o=f(o,h,a,l,t[u+6],15,-1560198380),l=f(l,o,h,a,t[u+13],21,1309151649),a=f(a,l,o,h,t[u+4],6,-145523070),h=f(h,a,l,o,t[u+11],10,-1120210379),o=f(o,h,a,l,t[u+2],15,718787259),l=f(l,o,h,a,t[u+9],21,-343485551),a=c(a,e),l=c(l,n),o=c(o,s),h=c(h,r);return[a,l,o,h]}function h(t){for(var i="",e=0;e<32*t.length;e+=8)i+=String.fromCharCode(t[e>>5]>>>e%32&255);return i}function u(t){var i,e=[];for(e[(t.length>>2)-1]=void 0,i=0;i<e.length;i+=1)e[i]=0;for(i=0;i<8*t.length;i+=8)e[i>>5]|=(255&t.charCodeAt(i/8))<<i%32;return e}function n(t){for(var i,e="0123456789abcdef",n="",s=0;s<t.length;s+=1)i=t.charCodeAt(s),n+=e.charAt(i>>>4&15)+e.charAt(15&i);return n}function e(t){return unescape(encodeURIComponent(t))}function s(t){return h(o(u(i=e(t)),8*i.length));var i}function r(t,i){return function(t,i){var e,n,s=u(t),r=[],a=[];for(r[15]=a[15]=void 0,16<s.length&&(s=o(s,8*t.length)),e=0;e<16;e+=1)r[e]=909522486^s[e],a[e]=1549556828^s[e];return n=o(r.concat(u(i)),512+8*i.length),h(o(a.concat(n),640))}(e(t),e(i))}md5=function(t,i,e){return i?e?r(i,t):n(r(i,t)):e?s(t):n(s(t))}}();var NameParse=function(){function t(){return t}return t.parse=function(t){var i,e="",n="",s="",r=null,a=0,l=0,o=(i=(t=t.trim()).split(" ").filter(function(t){return-1===t.indexOf("(")})).length,h=this.is_salutation(i[0]),u=this.is_suffix(i[o-1]),c=h?1:0,d=u?o-1:o,r=i[c];for(this.is_initial(r)?this.is_initial(i[1+c])?n+=" "+r.toUpperCase():s+=" "+r.toUpperCase():n+=" "+this.fix_case(r),l=1+c;l<d-1&&(r=i[l],!this.is_compound_lastName(r));l++)this.is_initial(r)?s+=" "+r.toUpperCase():n+=" "+this.fix_case(r);if(1<d-c)for(a=l;a<d;a++)e+=" "+this.fix_case(i[a]);return{salutation:h||"",firstName:n.trim(),initials:s.trim(),lastName:e.trim(),suffix:u||""}},t.removeIgnoredChars=function(t){return t.replace(".","")},t.is_salutation=function(t){return"mr"===(t=this.removeIgnoredChars(t).toLowerCase())||"master"===t||"mister"===t?"Mr.":"mrs"===t?"Mrs.":"miss"===t||"ms"===t?"Ms.":"dr"===t?"Dr.":"rev"===t?"Rev.":"fr"===t&&"Fr."},t.is_suffix=function(t){t=this.removeIgnoredChars(t).toLowerCase();var i=["I","II","III","IV","V","Senior","Junior","Jr","Sr","PhD","APR","RPh","PE","MD","MA","DMD","CME","BVM","CFRE","CLU","CPA","CSC","CSJ","DC","DD","DDS","DO","DVM","EdD","Esq","JD","LLD","OD","OSB","PC","Ret","RGS","RN","RNC","SHCJ","SJ","SNJM","SSMO","USA","USAF","USAFR","USAR","USCG","USMC","USMCR","USN","USNR"],e=i.map(function(t){return t.toLowerCase()}).indexOf(t);return 0<=e&&i[e]},t.is_compound_lastName=function(t){t=t.toLowerCase();return 0<=["vere","von","van","de","del","della","di","da","pietro","vanden","du","st.","st","la","lo","ter"].indexOf(t)},t.is_initial=function(t){return 1===(t=this.removeIgnoredChars(t)).length},t.is_camel_case=function(t){return/[A-Z]+/.exec(t)&&/[a-z]+/.exec(t)},t.fix_case=function(t){return t=this.safe_ucfirst("-",t),t=this.safe_ucfirst(".",t)},t.safe_ucfirst=function(t,i){return i.split(t).map(function(t){return this.is_camel_case(t)?t:t.substr(0,1).toUpperCase()+t.substr(1).toLowerCase()},this).join(t)},t}();function ZendeskOrganization(t,i,e,n){this.app=t,this.id=i,this.name=e,this.customer_type=n,this.extra_org_fields=[];for(var s=0;s<t.field_maps.organisation.length;s++)this.extra_org_fields[s]={field_def:t.field_maps.organisation[s],value:null}}function ZendeskUser(t,i,e,n,s,r){this.app=t,this.id=i,this.name=e,this.name_parts=null,this.email=n,this.customer_type=s,this.organization_id=void 0===r?null:r,this.orgObject=null,this.extra_user_fields=[];for(var a=0;a<t.field_maps.user.length;a++)this.extra_user_fields[a]={field_def:t.field_maps.user[a],value:null}}ZendeskOrganization.prototype.populateExtraFieldsFromOrganizationAPIData=function(t){for(var i=0;i<this.extra_org_fields.length;i++)this.extra_org_fields[i].value=t.organization_fields[this.extra_org_fields[i].field_def.zendesk_field]},ZendeskOrganization.prototype.populateExtraFieldsFromFrameworkOrgObject=function(t){for(var i=0;i<this.extra_org_fields.length;i++)this.extra_org_fields[i].value=t.customField(this.extra_org_fields[i].field_def.zendesk_field)},ZendeskOrganization.prototype.clone=function(){for(var t=new ZendeskOrganization(this.app,this.id,this.name,this.customer_type),i=0;i<this.extra_org_fields.length;i++)t.extra_org_fields[i]={field_def:this.extra_org_fields[i].field_def,value:this.extra_org_fields[i].value};return t},ZendeskUser.prototype.getSalutation=function(){return this.populateNamePartsIfNecessary(),null===this.name_parts.salutation?"":this.name_parts.salutation.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},ZendeskUser.prototype.getForeName=function(){return this.populateNamePartsIfNecessary(),null===this.name_parts.firstName?"":this.name_parts.firstName.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},ZendeskUser.prototype.getSurname=function(){return this.populateNamePartsIfNecessary(),null===this.name_parts.lastName?"":this.name_parts.lastName.replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()})},ZendeskUser.prototype.populateNamePartsIfNecessary=function(){null===this.name_parts&&null!==this.name&&(this.name_parts=this.app.parseNamesModule.parse(this.name.replace("/"," ").replace("."," ").split(",").reverse().map(Function.prototype.call,String.prototype.trim).join(" ")))},ZendeskUser.prototype.populateExtraFieldsFromUserAPIData=function(t){for(var i=0;i<this.extra_user_fields.length;i++)this.extra_user_fields[i].value=t.user_fields[this.extra_user_fields[i].field_def.zendesk_field]},ZendeskUser.prototype.populateExtraFieldsFromFrameworkUserObject=function(t){for(var i=0;i<this.extra_user_fields.length;i++)this.extra_user_fields[i].value=t.customField(this.extra_user_fields[i].field_def.zendesk_field)},ZendeskUser.prototype.clone=function(){var t=new ZendeskUser(this.app,this.id,this.name,this.email,this.customer_type,this.organization_id);t.orgObject=null===this.orgObject?null:this.orgObject.clone();for(var i=0;i<this.extra_user_fields.length;i++)t.extra_user_fields[i]={field_def:this.extra_user_fields[i].field_def,value:this.extra_user_fields[i].value};return t},ZendeskUser.prototype.isNotset=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_NOT_SET},ZendeskUser.prototype.isExcluded=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_EXCLUDE},ZendeskUser.prototype.isIncluded=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_ORGANIZATION||this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.isOrganization=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_ORGANIZATION},ZendeskUser.prototype.isDefault=function(){return this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.belongsToOrganization=function(){return null!==this.organization_id},ZendeskUser.prototype.orgObjectIsPopulated=function(){return null!==this.orgObject},ZendeskUser.prototype.getMailchimpCustomerType=function(){return void 0===this.customer_type||null===this.customer_type?(console.warn("ZendeskUser.getMailchimpCustomerType() called with invalid customer_type, this = "),console.dir(this),null):this.customer_type===this.app.resources.CUSTOMER_TYPE_USE_ORGANIZATION?this.orgObject.customer_type:this.app.field_maps.cust_type.default_value},ZendeskUser.prototype.findExtraFieldByName=function(t,i){for(var e=0;e<this.extra_user_fields.length;e++)if(i&&this.extra_user_fields[e].field_def.zendesk_field===t||!i&&this.extra_user_fields[e].field_def.mailchimp_field===t)return this.extra_user_fields[e]},ZendeskUser.prototype.getFieldSyncInfo=function(t){if(null==t)return null;if(void 0===this.customer_type||null===this.customer_type||this.isNotset())return console.warn("ZendeskUser.getFieldSyncInfo() called with invalid customer_type, this = "),console.dir(this),null;for(var i=[{label:"Email",mc_only:!1,zd_field_location:"user",is_image:!1,zd_value:this.email,mc_value:t.email_address,in_sync:this.email.toLowerCase()===t.email_address.toLowerCase()},{label:"Name",mc_only:!1,zd_field_location:"user",is_image:!1,zd_value:this.name,mc_value:"["+t.forename+"] ["+t.surname+"]",in_sync:t.forename.toLowerCase()===this.getForeName().toLowerCase()&&t.surname.toLowerCase()===this.getSurname().toLowerCase()},{label:"Customer Type",mc_only:!1,zd_field_location:"user",is_image:!1,zd_value:this.getMailchimpCustomerType(),mc_value:t.customer_type,in_sync:this.getMailchimpCustomerType()===t.customer_type}],e=null,n=null,s=0,r=0;r<this.extra_user_fields.length;r++)e=null===(e=this.extra_user_fields[r].value)?"":e,n=null===(n=t.extra_merge_fields[s].value)?"":n,i[s+3]={label:this.extra_user_fields[r].field_def.field_label,zd_field_location:"user",is_image:this.extra_user_fields[r].field_def.type===this.app.resources.TYPE_IMAGE,zd_value:e,mc_value:n,in_sync:e===n},s++;for(r=0;r<this.app.field_maps.organisation.length;r++)e=null===(e=this.isDefault()?this.app.field_maps.organisation[r].default_value:this.isOrganization()?this.orgObject.extra_org_fields[r].value:null)?"":e,n=null===(n=t.extra_merge_fields[s].value)?"":n,i[s+3]={label:this.app.field_maps.organisation[r].field_label,zd_field_location:"organisation",is_image:this.app.field_maps.organisation[r].type===this.app.resources.TYPE_IMAGE,zd_value:e,mc_value:n,in_sync:e===n},s++;for(r=0;r<this.app.field_maps.mc_only.length;r++)n=null===(n=t.extra_merge_fields[s].value)?"":n,i[s+3]={label:this.app.field_maps.mc_only[r].field_label,zd_field_location:null,is_image:this.app.field_maps.mc_only[r].type===this.app.resources.TYPE_IMAGE,is_checkbox:this.app.field_maps.mc_only[r].type===this.app.resources.TYPE_CHECKBOX,is_checkbox_ticked:this.app.field_maps.mc_only[r].type!==this.app.resources.TYPE_CHECKBOX?null:"1"===n||1===n,zd_value:null,mc_value:n,in_sync:!0},s++;return i},ZendeskUser.prototype.isInSync=function(t,i){if(null==t&&(t=this.getFieldSyncInfo(i)),null===t)return!1;for(var e=0;e<t.length;e++)if(!t[e].in_sync)return!1;return!0};var debug_mode=!0,thisV2Client=ZAFClient.init();function switchToHdbsFileTemplate(t,e){var n=$("#page_content");$(n).empty().html('<div class="alert alert-info">Loading...</div><div class="text-center"><div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div></div>'),$.ajax(t).done(function(t){var i=Handlebars.compile(t)(e);$(n).empty().html(i)})}function switchToInlineTemplate(t,i){var e=$("#"+t).html(),n=Handlebars.compile(e)(i),s=$("#page_content");$(s).empty().html(n)}function modal_createChildFromParent(t){var i={location:"modal",size:{width:"700px",height:"450px"},url:"assets/modal-iframe.html#parent_guid="+encodeURIComponent(t.instanceGuid)+"&parent_location="+encodeURIComponent(t.location)};thisV2Client.invoke("instances.create",i)}function getClientInstanceFromGuid(t){return thisV2Client.instance(t)}function parseURLParams(t){var i=t.replace("#","").split("&");debug_mode&&console.log("Split into individual strings: param_sub = %o",i);for(var e={},n=0;n<i.length;++n){var s=i[n].split("=");e[s[0]]=s[1]}return e}function makeAjaxCall(i,t,e,n,s){void 0!==s&&s&&(t.cors=!1),thisV2Client.request(t).then(function(t){null==e?console.warn("AJAX SUCCESS: and no successFunction was defined so no futher action can be taken to handle the response. returned data = %o",t):e.call(i,t)},function(t){null==n?console.warn("AJAX FAIL: and no failFunction was defined so no futher action can be taken to handle the error. error response = %o",t):n.call(i,t)})}var pluginFactory=function(s){return{t:s,i:null,e:{n:"ticket_sidebar",s:"user_sidebar",r:"text",a:"image",l:"checkbox",o:"mailshot_customer_type",h:"mailshot_customer_display_name",u:null,c:"mailshot_exclude_from_mailshot",d:"mailshot_use_default_values",_:"mailshot_use_organisation_values",m:"./templates/main.hdbs",f:"./templates/sync-modal.hdbs",p:"loading-screen-template",v:"./templates/show_error.hdbs",g:"https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/raw/master/extras/ZenchimpSettingsGenerator.xlsx"},U:{"ticket.requester.id.changed":"resetAppIfPageFullyLoaded","user.email.changed":"resetAppIfPageFullyLoaded","user.id.changed":"resetAppIfPageFullyLoaded","user.name.changed":"resetAppIfPageFullyLoaded","user.organizations.changed":"resetAppIfPageFullyLoaded","user.mailshot_customer_type.changed":"__userScreenCustomerTypeFieldChanged","*.changed":"__formFieldChanged"},C:{k:null,O:function(t){return{url:"https://upnrunning.zendesk.com/api/v2/users/"+encodeURIComponent(t)+".json",type:"GET",dataType:"json"}},y:function(t){return{url:"/api/v2/users/create_or_update.json",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({user:{id:t.id,email:t.email,user_fields:{mailshot_customer_type:t.customer_type}}})}},T:function(t,i){return{url:null!=i?"/api/v2/organizations/"+encodeURIComponent(i)+".json":"/api/v2/users/"+encodeURIComponent(t)+".organizations.json",type:"GET",dataType:"json"}},b:function(t){if(null==t)return console.error("ERROR CONDITION: __getMailChimpListMember called with null email address");var i=md5(t.toLowerCase());return{url:"https://"+encodeURIComponent(this.k.S.M)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.k.S.A)+"/members/"+encodeURIComponent(i),type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.k.S.I)}}},R:function(t,i){if(null===t||null===t.email_address)return console.warn("ERROR CONDITION: __createOrUpadateMailChimpListMember called with either null user or user with no email address");var e=md5(t.email_address.toLowerCase()),n={};n[this.k.S.F]=t.forename,n[this.k.S.N]=t.surname,n[this.k.S.L]=t.customer_type;for(var s=0;s<t.extra_merge_fields.length;s++)n[t.extra_merge_fields[s].field_def.mailchimp_field]=t.extra_merge_fields[s].value;var r={id:e,email_address:t.email_address,email_type:"html",status:t.Z,status_if_new:"subscribed",merge_fields:n,vip:t.customer_type===this.k.e._};return{url:"https://"+encodeURIComponent(this.k.S.M)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.k.S.A)+"/members/"+encodeURIComponent(i?e:""),type:i?"PUT":"POST",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.k.S.I)},data:JSON.stringify(r)}},w:function(t){if(null===t||null===t.email_address)return console.error("ERROR CONDITION: __deleteMailChimpListMember called with either null user or user with no email address");var i=md5(t.email_address.toLowerCase());return{url:"https://"+encodeURIComponent(this.k.S.M)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(this.k.S.A)+"/members/"+encodeURIComponent(i),type:"DELETE",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+this.k.S.I)}}}},init:function(t,i){var e=this,n=this.e;this.resources={TYPE_TEXT:n.r,TYPE_IMAGE:n.a,TYPE_CHECKBOX:n.l,CUSTOMER_TYPE_NOT_SET:n.u,CUSTOMER_TYPE_EXCLUDE:n.c,CUSTOMER_TYPE_USE_DEFAULT:n.d,CUSTOMER_TYPE_USE_ORGANIZATION:n._},(this.C.k=this).P=null!=t&&t,this.zendeskObjectsModule={ZendeskOrganization:ZendeskOrganization,ZendeskUser:ZendeskUser},this.parseNamesModule=NameParse,this.x=null,this.D=null,this.z=!1,this.i=void 0===i?null:i,null===this.i&&this.t.context().then(function(t){e.i=t,e.j(),e.resetAppIfPageFullyLoaded()},function(t){e.B(t,"Could not get app __context, please check your internet connection and try again")}),this.J=!1,this.S={},this.Y={},this.t.metadata().then(function(t){var i=t.settings;e.S={I:i.mailchimp_api_key,M:i.mailchimp_datacentre_prefix,A:i.mailchimp_list_id,F:i.mailchimp_merge_field_forename,N:i.mailchimp_merge_field_surname,L:i.mailchimp_merge_field_customer_type,G:i.mailchimp_merge_field_customer_type_default_val,H:i.mailchimp_organisation_button_label,V:i.mailchimp_standard_button_label},e.Y={X:{zendesk_field:e.e.h,mailchimp_field:e.S.L,type:e.e.$,default_value:e.S.G},q:e.K(i.mailchimp_organization_field_mappings,"Organisation Field Mapping",!1),W:e.K(i.mailchimp_user_field_mappings,"User Field Mapping",!1),Q:e.K(i.mailchimp_mailshot_only_field_mappings,"Mailchimp Only Field Mapping",!0)},e.field_maps={cust_type:e.Y.X,organisation:e.Y.q,user:e.Y.W,mc_only:e.Y.Q},null!==e.Y.q&&null!==e.Y.W&&null!==e.Y.Q&&(e.J=!0,e.resetAppIfPageFullyLoaded())},function(t){e.B(t,"Could not get your app settings, please check your internet connection and try again")})},resetAppIfPageFullyLoaded:function(){var i=this;!this.z&&null===this.i||!this.z&&!this.J||(this.z||this.i.location!==this.e.n||null!==this.D?(this.z||this.i.location!==this.e.s||null!==this.user().id()&&null!==this.user().email()&&null!==this.user().name())&&(this.x=null,this.i.location===this.e.n?(this.switchToLoadingScreen("Loading Ticket Requester..."),makeAjaxCall(this,this.C.O(this.D.id),this.tt,this.B)):this.i.location===this.e.s&&(this.switchToLoadingScreen("Loading Zendesk User..."),this.getUserFromFrameworkInUserSidebarLocation()),this.z=!0):this.t.get("ticket.requester").then(function(t){i.D=t["ticket.requester"],i.resetAppIfPageFullyLoaded()},function(t){i.B(t,"Could not get the ticket info, please check your internet connection and try again")}))},j:function(){this.i.location===this.e.s&&_.each([this.e.o],function(t){var i=this.userFields(t);i&&i.isVisible()&&i.hide()},this)},it:function(t){var i=null;if(this.i.location===this.e.s)for(var e=t.propertyName,n=0;n<this.Y.W.length;n++)if(e==="user."+this.Y.W[n].zendesk_field){i=this.Y.W[n].zendesk_field;break}null!==i&&void 0!==this.D&&null!==this.D&&(this.D.findExtraFieldByName(i,!0).value=t.newValue,this.switchToMainTemplate())},et:function(){var t=this.D.customer_type,i=this.user().customField(this.e.o);this.nt(t,i)},syncButtonFromModalOnClick:function(){return this.st(this.D,!0),!1},mailchimpOnlyField_OnClick:function(t){for(var i=null,e=0;e<this.x.extra_merge_fields.length;e++)void 0===(i=this.x.extra_merge_fields[e]).field_def.zendesk_field&&"MC_ONLY_"+i.field_def.mailchimp_field===t.target.id&&(i.field_def.type===this.e.l?i.value=null===i.value||!1===i.value||"0"===i.value||0===i.value||""===i.value||"NO"===i.value.toString().toUpperCase()||"FALSE"===i.value.toString().toUpperCase()?"1":"0":console.error("Unsupported field type '%s' (only 'checkbox' supported) on mailchimp extra merge field: %o"+i.type,i));this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.C.R(this.x,!0),this.rt,this.at)},excludeButtonOnClick:function(){var t;return this.i.location===this.e.s?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.e.o,this.e.c)):((t=this.D.clone()).customer_type=this.e.c,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.C.y(t),this.lt,this.B)),!1},organizationButtonOnClick:function(){var t;return this.i.location===this.e.s?(this.switchToLoadingScreen("Updating Zendesk User"),this.user().customField(this.e.o,this.e._)):((t=this.D.clone()).customer_type=this.e._,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.C.y(t),this.lt,this.B)),!1},standardButtonOnClick:function(){var t;return this.i.location===this.e.s?(this.switchToLoadingScreen("Updating Zendesk User..."),this.user().customField(this.e.o,this.e.d)):((t=this.D.clone()).customer_type=this.e.d,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.C.y(t),this.lt,this.B)),!1},tt:function(t){this.D=this.ot(t),this.D.isOrganization()&&this.D.belongsToOrganization()?(this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.C.T(this.D.id,this.D.organization_id),this.ht,this.B)):this.fetchMailchimpObjectIfNecessary(),this.D=this.ot(t)},ot:function(t){var i=null;return null!==t?(i=new this.zendeskObjectsModule.ZendeskUser(this,t.user.id,t.user.name,t.user.email,t.user.user_fields.mailshot_customer_type,void 0!==t.user.organization_id&&null!==t.user.organization_id?t.user.organization_id:null)).populateExtraFieldsFromUserAPIData(t.user):console.error("__createZendeskUserFromAPIReturnData called but userObjectFromDataAPI = null - this should never happen!"),i},lt:function(t){var i=this.ot(t);i.orgObject=this.D.orgObject;var e=this.D.customer_type;this.D=i,this.D.isOrganization()&&this.D.belongsToOrganization()&&!this.D.orgObjectIsPopulated()?(this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null===e?"NOTSET":e,this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.C.T(this.D.id,this.D.organization_id),this.ht,this.B)):this.nt(e,this.D.customer_type)},ht:function(t){var i;this.D.orgObject=this.createZendeskOrganizationFromAPIReturnData(t),void 0!==this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs&&null!==this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?(i="NOTSET"===this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?null:this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs,this.D.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null,this.nt(i,this.D.customer_type)):this.fetchMailchimpObjectIfNecessary()},createZendeskOrganizationFromAPIReturnData:function(t){var i=null;return null!=t&&void 0!==t.organization&&null!==t.organization?(i=new this.zendeskObjectsModule.ZendeskOrganization(this,t.organization.id,t.organization.name,t.organization.organization_fields[this.Y.X.zendesk_field])).populateExtraFieldsFromOrganizationAPIData(t.organization):console.warn("createZendeskOrganizationFromAPIReturnData called but organizationObjectFromDataAPI = null or doesnt contain a organization property - this should never happen!"),i},getUserFromFrameworkInUserSidebarLocation:function(){var t=void 0!==this.user().organizations()[0]&&null!==this.user().organizations()[0]?this.user().organizations()[0]:null;this.D=new this.zendeskObjectsModule.ZendeskUser(this,this.user().id(),this.user().name(),this.user().email(),this.user().customField(this.e.o),null===t?null:t.id()),this.D.populateExtraFieldsFromFrameworkUserObject(this.user()),null!==t&&(this.D.orgObject=new this.zendeskObjectsModule.ZendeskOrganization(this,t.id(),t.name(),t.customField(this.Y.X.zendesk_field)),this.D.orgObject.populateExtraFieldsFromFrameworkOrgObject(t)),this.fetchMailchimpObjectIfNecessary()},fetchMailchimpObjectIfNecessary:function(){this.D.isIncluded()&&null===this.x?(this.switchToLoadingScreen("Loading user from Mailchimp..."),makeAjaxCall(this,this.C.b(this.D.email,this),this.retrievedMailchimpSubscriber,this.at)):this.switchToMainTemplate()},nt:function(t,i){(this.D.customer_type=i)!==this.e.u&&i!==this.e.c||(t!==this.e.d&&t!==this.e._||this.deleteExistingUserFromMailchimp(this.x),this.switchToMainTemplate()),i!==this.e._&&i!==this.e.d||(t===this.e.c||t===this.e.u?this.syncNewUserToMailchimp(this.D):t!==i?this.st(this.D,!0):this.switchToMainTemplate())},retrievedMailchimpSubscriber:function(t){this.x={email_address:t.email_address,status:"subscribed",forename:t.merge_fields[this.S.F],surname:t.merge_fields[this.S.N],customer_type:t.merge_fields[this.Y.X.mailchimp_field],extra_merge_fields:[]};for(var i=0,e=0;e<this.Y.W.length;e++)this.x.extra_merge_fields[i]={field_def:this.Y.W[e],value:t.merge_fields[this.Y.W[e].mailchimp_field]},i++;for(var n=0;n<this.Y.q.length;n++)this.x.extra_merge_fields[i]={field_def:this.Y.q[n],value:t.merge_fields[this.Y.q[n].mailchimp_field]},i++;for(var s=0;s<this.Y.Q.length;s++)this.x.extra_merge_fields[i]={field_def:this.Y.Q[s],value:t.merge_fields[this.Y.Q[s].mailchimp_field]},i++;this.switchToMainTemplate()},syncNewUserToMailchimp:function(t){var i=this.createNewMailchimpSyncUserObject(t);this.switchToLoadingScreen("Adding Mailchimp Member..."),makeAjaxCall(this,this.C.R(i,!1),this.rt,this.at)},st:function(t,i){var e=this.createNewMailchimpSyncUserObject(t);if(void 0!==i&&!0===i&&null!==this.x&&t.email===this.x.email_address)for(var n=0;n<this.x.extra_merge_fields.length;n++)void 0===this.x.extra_merge_fields[n].field_def.zendesk_field&&(e.extra_merge_fields[n].value=this.x.extra_merge_fields[n].value);this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,this.C.R(e,!0),this.rt,this.at)},deleteExistingUserFromMailchimp:function(t){this.switchToLoadingScreen("Deleting Mailchimp Member..."),makeAjaxCall(this,this.C.w(t),null,null,!0)},at:function(i){var t=!1;try{var e=JSON.parse(i.responseText);400===i.status&&"Member Exists"===e.title&&(this.B(i,this.D.email+" already exists in mailchimp.<br /><br/>Do you want to override his/her details?","Override","error_override_mailchimp","__createOrUpadateMailChimpListMember_Override_OnClick()"),t=!0),404===i.status&&(this.B(i,this.D.email+" doesn't exist in mailchimp.<br /><br/>Do you want to create a new record for him/her?","Create New","error_create_new_mailchimp","__createOrUpadateMailChimpListMember_Add_New_OnClick()"),t=!0)}catch(t){console.warn("Could not JSON Parse errorResponse.responseText from get_or___createOrUpadateMailChimpListMember. errorResponse = %o\n\nparse exception: %o",i,t)}t||this.B(i)},ut:function(){return this.st(this.D),!1},ct:function(){return this.syncNewUserToMailchimp(this.D),!1},rt:function(t){this.retrievedMailchimpSubscriber(t)},createNewMailchimpSyncUserObject:function(t){var i=t.isDefault();if(null===t)return console.warn("createNewMailchimpSyncUserObject called with null zendeskSyncUserObject"),null;if(!i&&null===t.orgObject)return console.warn("createNewMailchimpSyncUserObject called with customer type "+t.customer_type+" and  null zendeskSyncUserObject.orgObject"),null;for(var e={email_address:t.email,Z:"subscribed",forename:t.getForeName(),surname:t.getSurname(),customer_type:t.getMailchimpCustomerType(),extra_merge_fields:[]},n=0,s=0;s<t.extra_user_fields.length;s++)e.extra_merge_fields[n]={field_def:t.extra_user_fields[s].field_def,value:null===t.extra_user_fields[s].value?"":t.extra_user_fields[s].value},n++;for(var r=0;r<this.Y.q.length;r++)e.extra_merge_fields[n]={field_def:this.Y.q[r],value:i?this.Y.q[r].default_value:t.orgObject.extra_org_fields[r].value},n++;for(var a=0;a<this.Y.Q.length;a++)e.extra_merge_fields[n]={field_def:this.Y.Q[a],value:this.Y.Q[a].default_value},n++;return e},switchToLoadingScreen:function(t){switchToInlineTemplate(this.e.p,{optional_message:t})},switchToMainTemplate:function(){var t=this.D.getFieldSyncInfo(this.x),i=this.D.isInSync(t),e=" "+(i||this.D.isExcluded()?"btn-primary":"btn-danger"),n={zendesk_user:this.D,mailchimp_user:this.x,sync_fields:t,monkey_URL:this.D.isExcluded()?"./img/exclude_monkey.png":i?"./img/insync_monkey.png":"./img/outofsync_monkey.png",buttons:{exclude:{show:!0,classNameInsert:this.D.isExcluded()?" active":"",label:"Exclude",onclick:"excludeButtonOnClick()"},organization:{show:this.D.belongsToOrganization(),classNameInsert:e+(this.D.isOrganization()?" active":""),label:this.S.H,onclick:"organizationButtonOnClick()"},standard:{show:!0,classNameInsert:e+(this.D.isDefault()?" active":""),label:this.S.V,onclick:"standardButtonOnClick()"}},display_params:{customer_type_not_set:this.D.isNotset(),customer_type_exclude:this.D.isExcluded(),customer_type_included:this.D.isIncluded(),customer_type_organization:this.D.isOrganization(),customer_type_standard:this.D.isDefault(),user_in_sync:i,DEBUG:debug_mode}};s.main_template_form_data=n,switchToHdbsFileTemplate(this.P?this.e.f:this.e.m,n)},B:function(t,i,e,n,s){try{(0===t.status&&void 0===i||null===i||"error"===i)&&(i="Could not connect to API, Please check your internet connection")}catch(t){}var r={errorResponse:t,overrideMessage:void 0===i||"error"===i?null:i,additionalButtonText:void 0===e?null:e,additionalButtonHandle:void 0===n?null:n,additionalButtonOnclick:void 0===s?null:s};switchToHdbsFileTemplate(this.e.v,r)},debugButtonOnClick:function(){return console.log("Starting debugButtonOnClick"),console.dir(this),!1},K:function(i,e,t){var n=null,s=null,r=null;try{n=JSON.parse(i)}catch(t){var a="unknown";a=t instanceof SyntaxError?t.name+" "+t.message:t.message,console.error("JSON Validation for settings '%s' Falied with exception e = %o ",e,t),console.error("JSON TEXT WAS: %o ",i),s=t,r="The JSON Settings text you entered for the "+e+" setting was formatted incorrectly, it must be valid JSON.<br /><br />The failure reason was: "+a+'<br /><br />For help with these settings fields use our <a target="_blank" href="'+this.e.g+'">Zenchimp App Settings Generator</a> in Microsoft Excel'}if(null!==n){for(var l=null,o=t?["checkbox"]:["image","text","checkbox"],h=[],u=0;u<n.length;u++)if((l=n[u]).field_label||h.push("Missing Field/Value: field_label"),l.mailchimp_field||h.push("Missing Field/Value: mailchimp_field"),l.type?o.includes(l.type)||h.push("Invalid type: '"+l.type+"'. Valid types are: "+o.toString()+" (all lower case)"):h.push("Missing Field/Value: type"),void 0!==l.default_value&&null!==l.default_value||h.push("Missing Field: default_value"),t&&void 0!==l.zendesk_field&&h.push("Field: zendesk_field is not allowed on mailchimp-only field lists"),t||l.zendesk_field||h.push("Missing Field/Value: zendesk_field"),0<h.length){r="Field Definition "+(u+1)+" for the '"+e+"' setting has errors:<br /><br />"+h.join("<br />");break}if(null===r)return n}this.B(s,r)}}};