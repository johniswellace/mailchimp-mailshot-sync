"use strict";var md5=null;!function(){function c(e,i){var t=(65535&e)+(65535&i);return(e>>16)+(i>>16)+(t>>16)<<16|65535&t}function a(e,i,t,n,s,r){return c((o=c(c(i,e),c(n,r)))<<(a=s)|o>>>32-a,t);var o,a}function d(e,i,t,n,s,r,o){return a(i&t|~i&n,e,i,s,r,o)}function _(e,i,t,n,s,r,o){return a(i&n|t&~n,e,i,s,r,o)}function f(e,i,t,n,s,r,o){return a(i^t^n,e,i,s,r,o)}function m(e,i,t,n,s,r,o){return a(t^(i|~n),e,i,s,r,o)}function l(e,i){var t,n,s,r;e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;for(var o=1732584193,a=-271733879,l=-1732584194,u=271733878,h=0;h<e.length;h+=16)o=d(t=o,n=a,s=l,r=u,e[h],7,-680876936),u=d(u,o,a,l,e[h+1],12,-389564586),l=d(l,u,o,a,e[h+2],17,606105819),a=d(a,l,u,o,e[h+3],22,-1044525330),o=d(o,a,l,u,e[h+4],7,-176418897),u=d(u,o,a,l,e[h+5],12,1200080426),l=d(l,u,o,a,e[h+6],17,-1473231341),a=d(a,l,u,o,e[h+7],22,-45705983),o=d(o,a,l,u,e[h+8],7,1770035416),u=d(u,o,a,l,e[h+9],12,-1958414417),l=d(l,u,o,a,e[h+10],17,-42063),a=d(a,l,u,o,e[h+11],22,-1990404162),o=d(o,a,l,u,e[h+12],7,1804603682),u=d(u,o,a,l,e[h+13],12,-40341101),l=d(l,u,o,a,e[h+14],17,-1502002290),o=_(o,a=d(a,l,u,o,e[h+15],22,1236535329),l,u,e[h+1],5,-165796510),u=_(u,o,a,l,e[h+6],9,-1069501632),l=_(l,u,o,a,e[h+11],14,643717713),a=_(a,l,u,o,e[h],20,-373897302),o=_(o,a,l,u,e[h+5],5,-701558691),u=_(u,o,a,l,e[h+10],9,38016083),l=_(l,u,o,a,e[h+15],14,-660478335),a=_(a,l,u,o,e[h+4],20,-405537848),o=_(o,a,l,u,e[h+9],5,568446438),u=_(u,o,a,l,e[h+14],9,-1019803690),l=_(l,u,o,a,e[h+3],14,-187363961),a=_(a,l,u,o,e[h+8],20,1163531501),o=_(o,a,l,u,e[h+13],5,-1444681467),u=_(u,o,a,l,e[h+2],9,-51403784),l=_(l,u,o,a,e[h+7],14,1735328473),o=f(o,a=_(a,l,u,o,e[h+12],20,-1926607734),l,u,e[h+5],4,-378558),u=f(u,o,a,l,e[h+8],11,-2022574463),l=f(l,u,o,a,e[h+11],16,1839030562),a=f(a,l,u,o,e[h+14],23,-35309556),o=f(o,a,l,u,e[h+1],4,-1530992060),u=f(u,o,a,l,e[h+4],11,1272893353),l=f(l,u,o,a,e[h+7],16,-155497632),a=f(a,l,u,o,e[h+10],23,-1094730640),o=f(o,a,l,u,e[h+13],4,681279174),u=f(u,o,a,l,e[h],11,-358537222),l=f(l,u,o,a,e[h+3],16,-722521979),a=f(a,l,u,o,e[h+6],23,76029189),o=f(o,a,l,u,e[h+9],4,-640364487),u=f(u,o,a,l,e[h+12],11,-421815835),l=f(l,u,o,a,e[h+15],16,530742520),o=m(o,a=f(a,l,u,o,e[h+2],23,-995338651),l,u,e[h],6,-198630844),u=m(u,o,a,l,e[h+7],10,1126891415),l=m(l,u,o,a,e[h+14],15,-1416354905),a=m(a,l,u,o,e[h+5],21,-57434055),o=m(o,a,l,u,e[h+12],6,1700485571),u=m(u,o,a,l,e[h+3],10,-1894986606),l=m(l,u,o,a,e[h+10],15,-1051523),a=m(a,l,u,o,e[h+1],21,-2054922799),o=m(o,a,l,u,e[h+8],6,1873313359),u=m(u,o,a,l,e[h+15],10,-30611744),l=m(l,u,o,a,e[h+6],15,-1560198380),a=m(a,l,u,o,e[h+13],21,1309151649),o=m(o,a,l,u,e[h+4],6,-145523070),u=m(u,o,a,l,e[h+11],10,-1120210379),l=m(l,u,o,a,e[h+2],15,718787259),a=m(a,l,u,o,e[h+9],21,-343485551),o=c(o,t),a=c(a,n),l=c(l,s),u=c(u,r);return[o,a,l,u]}function u(e){for(var i="",t=0;t<32*e.length;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function h(e){var i,t=[];for(t[(e.length>>2)-1]=void 0,i=0;i<t.length;i+=1)t[i]=0;for(i=0;i<8*e.length;i+=8)t[i>>5]|=(255&e.charCodeAt(i/8))<<i%32;return t}function n(e){for(var i,t="0123456789abcdef",n="",s=0;s<e.length;s+=1)i=e.charCodeAt(s),n+=t.charAt(i>>>4&15)+t.charAt(15&i);return n}function t(e){return unescape(encodeURIComponent(e))}function s(e){return u(l(h(i=t(e)),8*i.length));var i}function r(e,i){return function(e,i){var t,n,s=h(e),r=[],o=[];for(r[15]=o[15]=void 0,16<s.length&&(s=l(s,8*e.length)),t=0;t<16;t+=1)r[t]=909522486^s[t],o[t]=1549556828^s[t];return n=l(r.concat(h(i)),512+8*i.length),u(l(o.concat(n),640))}(t(e),t(i))}md5=function(e,i,t){return i?t?r(i,e):n(r(i,e)):t?s(e):n(s(e))}}();var NameParse=function(){function e(){return e}return e.parse=function(e){var i,t="",n="",s="",r=null,o=0,a=0,l=(i=(e=e.trim()).split(" ").filter(function(e){return-1===e.indexOf("(")})).length,u=this.is_salutation(i[0]),h=this.is_suffix(i[l-1]),c=u?1:0,d=h?l-1:l,r=i[c];for(this.is_initial(r)?this.is_initial(i[1+c])?n+=" "+r.toUpperCase():s+=" "+r.toUpperCase():n+=" "+this.fix_case(r),a=1+c;a<d-1&&(r=i[a],!this.is_compound_lastName(r));a++)this.is_initial(r)?s+=" "+r.toUpperCase():n+=" "+this.fix_case(r);if(1<d-c)for(o=a;o<d;o++)t+=" "+this.fix_case(i[o]);return{salutation:u||"",firstName:n.trim(),initials:s.trim(),lastName:t.trim(),suffix:h||""}},e.removeIgnoredChars=function(e){return e.replace(".","")},e.is_salutation=function(e){return"mr"===(e=this.removeIgnoredChars(e).toLowerCase())||"master"===e||"mister"===e?"Mr.":"mrs"===e?"Mrs.":"miss"===e||"ms"===e?"Ms.":"dr"===e?"Dr.":"rev"===e?"Rev.":"fr"===e&&"Fr."},e.is_suffix=function(e){e=this.removeIgnoredChars(e).toLowerCase();var i=["I","II","III","IV","V","Senior","Junior","Jr","Sr","PhD","APR","RPh","PE","MD","MA","DMD","CME","BVM","CFRE","CLU","CPA","CSC","CSJ","DC","DD","DDS","DO","DVM","EdD","Esq","JD","LLD","OD","OSB","PC","Ret","RGS","RN","RNC","SHCJ","SJ","SNJM","SSMO","USA","USAF","USAFR","USAR","USCG","USMC","USMCR","USN","USNR"],t=i.map(function(e){return e.toLowerCase()}).indexOf(e);return 0<=t&&i[t]},e.is_compound_lastName=function(e){e=e.toLowerCase();return 0<=["vere","von","van","de","del","della","di","da","pietro","vanden","du","st.","st","la","lo","ter"].indexOf(e)},e.is_initial=function(e){return 1===(e=this.removeIgnoredChars(e)).length},e.is_camel_case=function(e){return/[A-Z]+/.exec(e)&&/[a-z]+/.exec(e)},e.fix_case=function(e){return e=this.safe_ucfirst("-",e),e=this.safe_ucfirst(".",e)},e.safe_ucfirst=function(e,i){return i.split(e).map(function(e){return this.is_camel_case(e)?e:e.substr(0,1).toUpperCase()+e.substr(1).toLowerCase()},this).join(e)},e}();function ZendeskOrganization(e,i,t,n){this.e=e,this.id=i,this.name=t,this.i=n,this.t=[];for(var s=0;s<e.s.n.length;s++)this.t[s]={r:e.s.n[s],o:null}}function ZendeskUser(e,i,t){if(null===i&&t){this.e=e,this.id=t.id,this.name=t.name,this.a=null,this.email=t.email,this.customer_type=t.customer_type,this.l=t.l,this.u=null===t.u?null:t.u.clone(),this.h=[];for(var n=0;n<t.h.length;n++)this.h[n]={field_def:t.h[n].field_def,value:t.h[n].value}}else{if(!i||!i.user)throw new TypeError("The Zendesk API used to get the user details returned no user information.");if(void 0===i.user.user_fields.mailshot_customer_type)throw new ReferenceError("The required Zendesk field with key mailshot_customer_type is missing. This should have been created during installation. Please reinstall or raise a bug using the link below");this.e=e,this.id=i.user.id,this.name=i.user.name,this.a=null,this.email=i.user.email,this.customer_type=i.user.user_fields.mailshot_customer_type,this.l=void 0!==i.user.organization_id&&null!==i.user.organization_id?i.user.organization_id:null,this.u=null,this.h=[],this.c=null;for(n=0;n<e.s.d.length;n++)this.h[n]={field_def:e.s.d[n],value:null};this.populateExtraFieldsFromUserAPIData(i.user),this._()}}ZendeskOrganization.prototype.populateExtraFieldsFromOrganizationAPIData=function(e){for(var i=0;i<this.t.length;i++){if(void 0===e.organization_fields[this.t[i].r.zendesk_field])throw new ReferenceError("The Zendesk 'Organisation Field' with key '"+this.t[i].r.zendesk_field+'\' which you specified in your Field Mapping settings doesnt seem to exist in Zendesk yet.<br /><br />For help with your field mappings use our <a target="_blank" href="'+this.e.m.f+'">Zenchimp App Settings Generator</a> spreadsheet.');this.t[i].o=e.organization_fields[this.t[i].r.zendesk_field]}},ZendeskOrganization.prototype.populateExtraFieldsFromFrameworkOrgObject=function(e){for(var i=0;i<this.t.length;i++)this.t[i].o=e.customField(this.t[i].r.zendesk_field)},ZendeskOrganization.prototype.clone=function(){for(var e=new ZendeskOrganization(this.e,this.id,this.name,this.i),i=0;i<this.t.length;i++)e.t[i]={r:this.t[i].r,o:this.t[i].o};return e},ZendeskUser.prototype.populateExtraFieldsFromUserAPIData=function(e){for(var i=0;i<this.h.length;i++){if(void 0===e.user_fields[this.h[i].field_def.zendesk_field])throw new ReferenceError("The Zendesk 'User Field' with key '"+this.h[i].field_def.zendesk_field+'\' which you specified in your Field Mapping settings doesnt seem to exist in Zendesk yet.<br /><br />For help with your field mappings use our <a target="_blank" href="'+this.e.m.f+'">Zenchimp App Settings Generator</a> spreadsheet.');this.h[i].value=e.user_fields[this.h[i].field_def.zendesk_field]}},ZendeskUser.prototype._=function(){this.customer_type===this.e.m.p&&null===this.l&&(this.c={g:"ORG_MISSING",v:new ReferenceError(this.name+" is set to sync his/her organisation fields, however they no longer belong to an organisation, do you want to switch customer type so that only thier user fields are synced?")})},ZendeskUser.prototype.getSalutation=function(){return this.populateNamePartsIfNecessary(),null===this.a.salutation?"":this.a.salutation.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.getForeName=function(){return this.populateNamePartsIfNecessary(),null===this.a.firstName?"":this.a.firstName.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.getSurname=function(){return this.populateNamePartsIfNecessary(),null===this.a.lastName?"":this.a.lastName.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})},ZendeskUser.prototype.populateNamePartsIfNecessary=function(){null===this.a&&null!==this.name&&(this.a=this.e.parseNamesModule.parse(this.name.replace("/"," ").replace("."," ").split(",").reverse().map(Function.prototype.call,String.prototype.trim).join(" ")))},ZendeskUser.prototype.populateExtraFieldsFromFrameworkUserObject=function(e){for(var i=0;i<this.h.length;i++)this.h[i].value=e.customField(this.h[i].field_def.zendesk_field)},ZendeskUser.prototype.clone=function(){return new ZendeskUser(this.e,null,this)},ZendeskUser.prototype.isNotset=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_NOT_SET},ZendeskUser.prototype.isExcluded=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_EXCLUDE},ZendeskUser.prototype.isIncluded=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_ORGANIZATION||this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.isOrganization=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_ORGANIZATION},ZendeskUser.prototype.isDefault=function(){return this.customer_type===this.e.resources.CUSTOMER_TYPE_USE_DEFAULT},ZendeskUser.prototype.belongsToOrganization=function(){return null!==this.l},ZendeskUser.prototype.y=function(){return null!==this.u},ZendeskUser.prototype.getMailchimpCustomerType=function(){return void 0===this.customer_type||null===this.customer_type?(console.warn("ZendeskUser.getMailchimpCustomerType() called with invalid customer_type, this = "),console.dir(this),null):this.customer_type===this.e.m.p?this.u.i:this.e.s.k.default_value};var debug_mode=!(ZendeskUser.prototype.findExtraFieldByName=function(e,i){for(var t=0;t<this.h.length;t++)if(i&&this.h[t].field_def.zendesk_field===e||!i&&this.h[t].field_def.mailchimp_field===e)return this.h[t]}),thisV2Client=null,thisV2ClientRegistered=!1;function switchToHdbsFileTemplate(e,t){var n=$("#page_content");$(n).empty().html('<div class="alert alert-info">Loading...</div><div class="text-center"><div class="spinner-grow text-primary" role="status"><span class="sr-only">Loading...</span></div></div>'),$.ajax(e).done(function(e){var i=Handlebars.compile(e)(t);$(n).empty().html(i)})}function switchToInlineTemplate(e,i){var t=$("#"+e).html(),n=Handlebars.compile(t)(i),s=$("#page_content");$(s).empty().html(n)}function modal_createChildFromParent(e){var i={location:"modal",size:{width:"700px",height:"450px"},url:"assets/modal-iframe.html#parent_guid="+encodeURIComponent(e.instanceGuid)+"&parent_location="+encodeURIComponent(e.location)};thisV2Client.invoke("instances.create",i).then(function(e){console.log("SUCCESS CREATING MODAL, success = %o",e)},function(e){console.error("FAILURE CREATING MODAL, success = %o",e)})}function getClientInstanceFromGuid(e){return thisV2Client.instance(e)}function parseURLParams(e){var i=e.replace("#","").split("&");debug_mode&&console.log("Split into individual strings: param_sub = %o",i);for(var t={},n=0;n<i.length;++n){var s=i[n].split("=");t[s[0]]=s[1]}return t}function makeAjaxCall(i,e,t,n,s){void 0!==s&&s&&(e.cors=!1),thisV2Client.request(e).then(function(e){null==t?console.warn("AJAX SUCCESS: and no successFunction was defined so no futher action can be taken to handle the response. returned data = %o",e):t.call(i,e)},function(e){null==n?console.warn("AJAX FAIL: NOT CALLING '%s(data)' AND NO failFunction WAS DEFINED so no futher action can be taken to handle the error. error response = %o",t?t.name:t,e):n.call(i,e)})}(thisV2Client=ZAFClient.init()).on("app.registered",function(){thisV2ClientRegistered=!0});var connector={m:{b:'<a target="_blank" href="https://login.mailchimp.com/">Login to Mailchimp?</a>'},C:{O:function(e,i){if(null==i)return console.error("ERROR CONDITION: __getMailChimpListMember called with null email address");var t=md5(i.toLowerCase());return{url:"https://"+encodeURIComponent(e.T.M)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(e.T.U)+"/members/"+encodeURIComponent(t),type:"GET",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+e.T.S)}}},I:function(e,i,t){if(null===i||null===i.email_address)return console.warn("ERROR CONDITION: __createOrUpadateMailChimpListMember called with either null user or user with no email address");var n=md5(i.email_address.toLowerCase()),s={};s[e.T.w]=i.forename,s[e.T.A]=i.surname,s[e.T.R]=i.customer_type;for(var r=null,o=null,a=0;a<i.extra_merge_fields.length;a++)r=i.extra_merge_fields[a].field_def,o=null===(o=i.extra_merge_fields[a].value)&&r.type===e.m.F?"":o,s[r.mailchimp_field]=o;var l={id:n,email_address:i.email_address,email_type:"html",status:i.N,status_if_new:"subscribed",merge_fields:s,vip:i.customer_type===e.m.p};return{url:"https://"+encodeURIComponent(e.T.M)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(e.T.U)+"/members/"+encodeURIComponent(t?n:""),type:t?"PUT":"POST",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+e.T.S)},data:JSON.stringify(l)}},x:function(e,i){if(null===i||null===i.email_address)return console.error("ERROR CONDITION: __deleteMailChimpListMember called with either null user or user with no email address");var t=md5(i.email_address.toLowerCase());return{url:"https://"+encodeURIComponent(e.T.M)+".api.mailchimp.com/3.0/lists/"+encodeURIComponent(e.T.U)+"/members/"+encodeURIComponent(t),type:"DELETE",dataType:"json",contentType:"application/json; charset=UTF-8",headers:{Authorization:"Basic "+btoa("api:"+e.T.S)}}}},L:function(e,i){var t=!1;try{var n=JSON.parse(i.responseText);if(400===i.status&&"Member Exists"===n.title&&(e.Z(i,e.P.email+" already exists in mailchimp.<br /><br/>Do you want to override his/her details?","Override","error_override_mailchimp","__createOrUpadateMailChimpListMember_Override_OnClick()"),t=!0),400===i.status&&("Invalid Resource"===n.title||"Member In Compliance State"===n.title)){var s=null;"Invalid Resource"===n.title?s="<p><b>On no, Mailchimp rejected one of your values</b></p><p>This is often a broken link or URL, an incorrect data type, or no value for a required field in Mailchimp. Here's what Mailchimp is saying...</p>":"Member In Compliance State"===n.title&&(s="<p><b>I'm sorry, Mailchimp wont include this user</b></p><p>This is normally because the user has manually unsubscribed from one of your emails. Here's what Mailchimp is saying...</p>"),void 0!==n.title&&(s+="<p><b>"+n.title+"</b>",void 0!==n.detail&&(s+=": "+n.detail),s+="</p>");var r=n.errors;if(void 0!==r&&0<r.length){s+="<p>The following fields had issues:<ul>",console.log(r.lenth);for(var o=0,a=r[o];void 0!==a;)console.log("here"),s+="<li><b> Field: "+a.field+"</b> - "+a.message+"</li>",a=r[++o];s+="</ul></p>"}e.Z(i,s),t=!0}404===i.status&&(e.Z(i,e.P.email+" doesn't exist in mailchimp.<br /><br/>Do you want to create a new record for him/her?","Create New","error_create_new_mailchimp","__createOrUpadateMailChimpListMember_Add_New_OnClick()"),t=!0)}catch(e){console.warn("Could not JSON Parse errorResponse.responseText from get_or___createOrUpadateMailChimpListMember. errorResponse = %o\n\nparse exception: %o",i,e)}t||e.Z(i)},z:function(e,i){for(var t={email_address:i.email_address,status:i.status,forename:this.D(e,i,e.T.w),surname:this.D(e,i,e.T.A),customer_type:this.D(e,i,e.s.k.mailchimp_field),extra_merge_fields:[],isSubscribed:function(){return"subscribed"===this.status||"pending"===this.status},hasUnSubscribed:function(){return"unsubscribed"===this.status},isDeleted:function(){return"cleaned"!==this.status}},n=0,s=0;s<e.s.d.length;s++)t.extra_merge_fields[n]={field_def:e.s.d[s],value:this.D(e,i,e.s.d[s].mailchimp_field)},n++;for(var r=0;r<e.s.n.length;r++)t.extra_merge_fields[n]={field_def:e.s.n[r],value:this.D(e,i,e.s.n[r].mailchimp_field)},n++;for(var o=0;o<e.s.j.length;o++)t.extra_merge_fields[n]={field_def:e.s.j[o],value:this.D(e,i,e.s.j[o].mailchimp_field)},n++;return t},D:function(e,i,t){var n=i.merge_fields[t];if(void 0===n)throw new ReferenceError("The Mailchimp Merge tag '*|"+t+'|*\' which you specified in your Field Mapping settings doesnt seem to exist in Mailchimp yet.<br /><br />Please create the field in Mailchimp or for help with your field mappings use our <a target="_blank" href="'+e.m.f+'"Zenchimp App Settings Generator</a> spreadsheet.');return n},B:function(e,i,t){var n=!0;return"archived"===t.status&&i.isIncluded()&&(e.Z({},"Sorry but the mailchimp member is archived, which means they have been deactivated in Mailchimp. Would you like to try to Reactivate or would you like to mark this user as excluded?","Attempt Reactivation","btn-warning",i.isOrganization()?"organizationButtonOnClick()":"standardButtonOnClick()","Exclude","excludeButtonOnClick()"),n=!1,i.customer_type=e.resources.CUSTOMER_TYPE_EXCLUDE),n},G:function(e,i,t){if(null==t)return null;if(void 0===i.customer_type||null===i.customer_type||i.isNotset())return console.warn("__getFieldSyncInfo.getFieldSyncInfo() called with invalid customer_type, zendeskUser = %o",i),null;for(var n=[{label:"Email",mc_only:!1,is_image:!1,zd_field_location:"user",zd_field_key:null,zd_value:i.email,mc_field_key:"EMAIL",mc_value:t.email_address,in_sync:i.email.toLowerCase()===t.email_address.toLowerCase()},{label:"Name",mc_only:!1,is_image:!1,zd_field_location:"user",zd_field_key:null,zd_value:i.name,mc_field_key:e.T.w+"|* and *|"+e.T.A,mc_value:"["+t.forename+"] ["+t.surname+"]",in_sync:t.forename.toLowerCase()===i.getForeName().toLowerCase()&&t.surname.toLowerCase()===i.getSurname().toLowerCase()},{label:"Customer Type",mc_only:!1,is_image:!1,zd_field_location:i.isOrganization()?"organisation":"user",zd_field_key:i.isOrganization()?e.m.V:e.m.J,zd_value:i.getMailchimpCustomerType(),mc_field_key:e.T.R,mc_value:t.customer_type,in_sync:i.getMailchimpCustomerType()===t.customer_type}],s=null,r=null,o=null,a=3,l=0;l<i.h.length;l++)s=null===(s=i.h[l].value)?"":s,r=null===(r=t.extra_merge_fields[a-3].value)?"":r,n[a]={label:i.h[l].field_def.field_label,mc_only:!1,is_image:i.h[l].field_def.type===i.e.resources.TYPE_IMAGE,zd_field_location:"user",zd_field_key:i.h[l].field_def.zendesk_field,zd_value:s,mc_field_key:i.h[l].field_def.mailchimp_field,mc_value:r,in_sync:s===r},a++;for(l=0;l<i.e.s.n.length;l++)s=null===(s=i.isDefault()?i.e.s.n[l].default_value:i.isOrganization()?i.u.t[l].o:null)?"":s,r=null===(r=t.extra_merge_fields[a-3].value)?"":r,o=i.e.s.n[l],n[a]={label:o.field_label,mc_only:!1,is_image:o.type===i.e.resources.TYPE_IMAGE,zd_field_location:"organisation",zd_field_key:o.zendesk_field,zd_value:s,mc_field_key:o.mailchimp_field,mc_value:r,in_sync:s===r},a++;for(l=0;l<i.e.s.j.length;l++)r=null===(r=t.extra_merge_fields[a-3].value)?"":r,o=i.e.s.j[l],n[a]={label:o.field_label,mc_only:!0,is_image:o.type===i.e.resources.TYPE_IMAGE,is_checkbox:o.type===i.e.resources.TYPE_CHECKBOX,is_checkbox_ticked:o.type!==i.e.resources.TYPE_CHECKBOX?null:r.toString()===o.value_if_ticked,checkbox_html_id:"MC_ONLY_"+o.mailchimp_field,zd_field_location:null,zd_field_key:null,zd_value:null,mc_field_key:o.mailchimp_field,mc_value:r,in_sync:!0},a++;return n},Y:function(e,i,t){if(null==i&&(i=this.G(e,t)),null===i)return!1;for(var n=0;n<i.length;n++)if(!i[n].in_sync)return!1;return!0},H:function(e,i){i.field_def.type===e.m.q?i.value=null!==i.value&&i.value.toString()===i.field_def.value_if_ticked?i.field_def.value_if_unticked:i.field_def.value_if_ticked:console.error("Unsupported field type '%s' (only 'checkbox' supported) on mailchimp extra merge field: %o"+i.type,i)}},__screen_events={X:function(i){i.$.location===i.m.K&&i.W.get("userFields:"+i.m.J+".isVisible").then(function(e){e["userFields:"+i.m.J+".isVisible"]&&i.W.invoke("userFields:"+i.m.J+".hide")},function(e){i.Z(e,"Could not access a Zendesk User Field with a Field Key of '"+i.m.J+"' Please check your internet connection or reinstall the app. If this issue persists please raise a bug report below")})},Q:function(e,i){var t=null;if(e.$.location===e.m.K){var n=i.propertyName;if(n==="user."+e.m.J)this.ee(e,i.newValue);else if("user.organizations"===n)this.ie(e,i.newValue);else if("user.name"===n)e.P&&(e.P.name=i.newValue,e.P.a=null),e.switchToMainTemplate();else if("user.email"===n)e.P&&(e.P.email=i.newValue),e.switchToMainTemplate();else for(var s=0;s<e.s.d.length;s++)if(n==="user."+e.s.d[s].zendesk_field){t=e.s.d[s].zendesk_field;break}}null!==t&&e.P&&(e.P.findExtraFieldByName(t,!0).value=i.newValue,e.switchToMainTemplate())},ie:function(e,i){0===i.length?(e.P.l=null,e.P.u=null,e.P._(),e.te()&&e.switchToMainTemplate()):(e.P.l=i[0].id,e.P.u=null,e.P.isOrganization()?(e.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,e.C.ne(e.P.id,e.P.l),e.se,e.Z)):e.switchToMainTemplate())},ee:function(e,i){var t=e.P.customer_type;e.P.customer_type=i,e.re(t,i)}},pluginFactory=function(r){return{W:r,$:null,m:{oe:"ticket_sidebar",K:"user_sidebar",F:"text",ae:"image",q:"checkbox",J:"mailshot_customer_type",V:"mailshot_customer_display_name",le:null,ue:"mailshot_exclude_from_mailshot",he:"mailshot_use_default_values",p:"mailshot_use_organisation_values",ce:"./templates/main.hdbs",de:"./templates/sync-modal.hdbs",_e:"loading-screen-template",fe:"./templates/show_error.hdbs",f:"https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/raw/master/extras/ZenchimpSettingsGenerator.xlsx"},C:{me:null,pe:function(e){return{url:"/api/v2/users/"+encodeURIComponent(e)+".json",type:"GET",dataType:"json"}},ge:function(e){return{url:"/api/v2/users/create_or_update.json",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify({user:{id:e.id,email:e.email,user_fields:{mailshot_customer_type:e.customer_type}}})}},ne:function(e,i){return{url:null!=i?"/api/v2/organizations/"+encodeURIComponent(i)+".json":"/api/v2/users/"+encodeURIComponent(e)+".organizations.json",type:"GET",dataType:"json"}}},init:function(e,i){var t=this,n=this.m;this.resources={TYPE_TEXT:n.F,TYPE_IMAGE:n.ae,TYPE_CHECKBOX:n.q,CUSTOMER_TYPE_NOT_SET:n.le,CUSTOMER_TYPE_EXCLUDE:n.ue,CUSTOMER_TYPE_USE_DEFAULT:n.he,CUSTOMER_TYPE_USE_ORGANIZATION:n.p},r.on("ticket.requester.id.changed",function(){t.resetAppIfPageFullyLoaded()}),r.on("*.changed",function(e){t.Q(e)}),(this.C.me=this).ve=null!=e&&e,this.zendeskObjectsModule={ZendeskOrganization:ZendeskOrganization},this.parseNamesModule=NameParse,this.ye=null,this.P=null,this.ke=!1,this.$=void 0===i?null:i,null===this.$&&this.W.context().then(function(e){t.$=e,t.X(),t.resetAppIfPageFullyLoaded()},function(e){t.Z(e,"Could not get app __context, please check your internet connection and try again")}),this.be=!1,this.T={},this.s={},this.W.metadata().then(function(e){var i=e.settings;t.T={S:i.mailchimp_api_key,M:i.mailchimp_datacentre_prefix,U:i.mailchimp_list_id,w:i.mailchimp_merge_field_forename,A:i.mailchimp_merge_field_surname,R:i.mailchimp_merge_field_customer_type,Ce:i.mailchimp_merge_field_customer_type_default_val,Oe:i.mailchimp_organisation_button_label,Me:i.mailchimp_standard_button_label},t.s={k:{zendesk_field:t.m.V,mailchimp_field:t.T.R,type:t.m.F,default_value:t.T.Ce},n:t.Te(i.mailchimp_organization_field_mappings,"Organisation Field Mapping",!1),d:t.Te(i.mailchimp_user_field_mappings,"User Field Mapping",!1),j:t.Te(i.mailchimp_mailshot_only_field_mappings,"Mailchimp Only Field Mapping",!0)},t.field_maps={cust_type:t.s.k,organisation:t.s.n,user:t.s.d,mc_only:t.s.j},null!==t.s.n&&null!==t.s.d&&null!==t.s.j&&(t.be=!0,t.resetAppIfPageFullyLoaded())},function(e){t.Z(e,"Could not get your app settings, please check your internet connection and try again")})},resetAppIfPageFullyLoaded:function(){var e,t=this;!this.ke&&null===this.$||!this.ke&&!this.be||(null!==this.P?(this.ye=null,this.$.location===this.m.oe?this.switchToLoadingScreen("Loading Ticket Requester..."):this.$.location===this.m.K&&this.switchToLoadingScreen("Loading Zendesk User..."),makeAjaxCall(this,this.C.pe(this.P.id),this.Ue,this.Z),this.ke=!0):(e=this.$.location===this.m.oe?"ticket.requester":"user",this.W.get(e).then(function(e){var i=t.$.location===t.m.oe?"ticket.requester":"user";t.P=e[i],t.resetAppIfPageFullyLoaded()},function(e){t.Z(e,"Could not get the ticket info, please check your internet connection and try again")})))},X:function(){__screen_events.X(this)},Q:function(e){__screen_events.Q(this,e)},syncButtonFromModalOnClick:function(){return this.Ee(this.P,!0),!1},mailchimpOnlyField_OnClick:function(e){for(var i=null,t=0;t<this.ye.extra_merge_fields.length;t++)void 0===(i=this.ye.extra_merge_fields[t]).field_def.zendesk_field&&"MC_ONLY_"+i.field_def.mailchimp_field===e.target.id&&connector.H(this,i);null!==i?(this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,connector.C.I(this,this.ye,!0),this.Se,this.L)):console.error("Could not find merge tag on Mailchimp user whose merge field coresponds to the checkbox just clicked: '%s'. Mailchimp user this.__mailshot_sync_user = %o",e.target.id,this.ye)},excludeButtonOnClick:function(){var e=this.P.clone();return e.customer_type=this.m.ue,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.C.ge(e),this.Ie,this.Z),!1},organizationButtonOnClick:function(){var e=this.P.clone();return e.customer_type=this.m.p,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.C.ge(e),this.Ie,this.Z),!1},standardButtonOnClick:function(){var e=this.P.clone();return e.customer_type=this.m.he,this.switchToLoadingScreen("Updating Zendesk User..."),makeAjaxCall(this,this.C.ge(e),this.Ie,this.Z),!1},Ue:function(e){this.P=this.we(e),this.te()&&(this.P.isOrganization()&&this.P.belongsToOrganization()?(this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.C.ne(this.P.id,this.P.l),this.se,this.Z)):this.Ae())},we:function(e){var i=null;try{i=new ZendeskUser(this,e)}catch(e){console.warn(e),this.Z(e,e.message,additionalButtonText,additionalButtonClass,additionalButtonOnclick)}return i},te:function(){var e=null!==this.P;return null!==this.P&&null!==this.P.c&&"ORG_MISSING"===this.P.c.g&&(this.Z(this.P.c.v,this.P.c.v.message,"Switch Sync Type","btn-warning","standardButtonOnClick()"),e=!1),e},Ie:function(e){var i=null;try{i=new ZendeskUser(this,e)}catch(e){this.Z(e,e.message)}i.u=this.P.u;var t=this.P.customer_type;this.P=i,this.P.isOrganization()&&this.P.belongsToOrganization()&&!this.P.y()?(this.P.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null===t?"NOTSET":t,this.switchToLoadingScreen("Loading Organization..."),makeAjaxCall(this,this.C.ne(this.P.id,this.P.l),this.se,this.Z)):this.re(t,this.P.customer_type)},se:function(e){var i;this.P.u=this.createZendeskOrganizationFromAPIReturnData(e),void 0!==this.P.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs&&null!==this.P.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?(i="NOTSET"===this.P.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs?null:this.P.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs,this.P.callChangeCustomerTypeAfterFullyLoaded_OldCustTypeIs=null,this.re(i,this.P.customer_type)):this.Ae()},createZendeskOrganizationFromAPIReturnData:function(e){var i=null;if(null!=e&&void 0!==e.organization&&null!==e.organization)try{(i=new this.zendeskObjectsModule.ZendeskOrganization(this,e.organization.id,e.organization.name,e.organization.organization_fields[this.s.k.zendesk_field])).populateExtraFieldsFromOrganizationAPIData(e.organization)}catch(e){console.warn(e),this.Z(e,e.message)}else console.warn("createZendeskOrganizationFromAPIReturnData called but organizationObjectFromDataAPI = null or doesnt contain a organization property - this should never happen!");return i},Ae:function(){this.P.isIncluded()&&null===this.ye?(this.switchToLoadingScreen("Loading user from Mailchimp..."),makeAjaxCall(this,connector.C.O(this,this.P.email),this.retrievedMailchimpSubscriber,this.L)):this.switchToMainTemplate()},re:function(e,i){(this.P.customer_type=i)!==this.m.le&&i!==this.m.ue||(e!==this.m.he&&e!==this.m.p||this.deleteExistingUserFromMailchimp(this.ye),this.switchToMainTemplate()),i!==this.m.p&&i!==this.m.he||(e===this.m.ue||e===this.m.le?this.syncNewUserToMailchimp(this.P):e!==i?this.Ee(this.P,!0):this.switchToMainTemplate())},retrievedMailchimpSubscriber:function(e){try{this.ye=connector.z(this,e),connector.B(this,this.P,this.ye)&&this.switchToMainTemplate()}catch(e){console.warn(e),this.Z(e,e.message)}},syncNewUserToMailchimp:function(e){var i=this.createNewMailchimpSyncUserObject(e);this.switchToLoadingScreen("Adding Mailchimp Member..."),makeAjaxCall(this,connector.C.I(this,i,!1),this.Se,this.L)},Ee:function(e,i){var t=this.createNewMailchimpSyncUserObject(e);if(void 0!==i&&!0===i&&null!==this.ye&&e.email===this.ye.email_address)for(var n=0;n<this.ye.extra_merge_fields.length;n++)void 0===this.ye.extra_merge_fields[n].field_def.zendesk_field&&(t.extra_merge_fields[n].value=this.ye.extra_merge_fields[n].value);this.switchToLoadingScreen("Updating Mailchimp Member..."),makeAjaxCall(this,connector.C.I(this,t,!0),this.Se,this.L)},deleteExistingUserFromMailchimp:function(e){this.switchToLoadingScreen("Deleting Mailchimp Member..."),makeAjaxCall(this,connector.C.x(this,e),null,null,!0)},L:function(e){connector.L(this,e)},Re:function(){return this.Ee(this.P),!1},Fe:function(){return this.syncNewUserToMailchimp(this.P),!1},Se:function(e){this.retrievedMailchimpSubscriber(e)},createNewMailchimpSyncUserObject:function(e){var i=e.isDefault();if(null===e)return console.warn("createNewMailchimpSyncUserObject called with null zendeskSyncUserObject"),null;if(!i&&null===e.u)return console.warn("createNewMailchimpSyncUserObject called with customer type "+e.customer_type+" and  null zendeskSyncUserObject.__orgObject"),null;for(var t={email_address:e.email,N:"subscribed",forename:e.getForeName(),surname:e.getSurname(),customer_type:e.getMailchimpCustomerType(),extra_merge_fields:[]},n=0,s=0;s<e.h.length;s++)t.extra_merge_fields[n]={field_def:e.h[s].field_def,value:null===e.h[s].value?"":e.h[s].value},n++;for(var r=0;r<this.s.n.length;r++)t.extra_merge_fields[n]={field_def:this.s.n[r],value:i?this.s.n[r].default_value:e.u.t[r].o},n++;for(var o=0;o<this.s.j.length;o++)t.extra_merge_fields[n]={field_def:this.s.j[o],value:this.s.j[o].default_value},n++;return t},switchToLoadingScreen:function(e){switchToInlineTemplate(this.m._e,{optional_message:e})},switchToMainTemplate:function(){var e=connector.G(this,this.P,this.ye),i=connector.Y(this,e),t=null!==this.ye&&this.ye.isSubscribed(),n=" "+(i||this.P.isExcluded()?"btn-primary":"btn-danger"),s={zendesk_user:this.P,mailchimp_user:this.ye,sync_fields:e,monkey_URL:!t||this.P.isExcluded()?"./img/exclude_monkey.png":i?"./img/insync_monkey.png":"./img/outofsync_monkey.png",buttons:{exclude:{show:!0,classNameInsert:this.P.isExcluded()?" active":"",label:"Exclude",onclick:"excludeButtonOnClick()"},organization:{show:this.P.belongsToOrganization(),classNameInsert:n+(this.P.isOrganization()?" active":""),label:this.T.Oe,onclick:"organizationButtonOnClick()"},standard:{show:!0,classNameInsert:n+(this.P.isDefault()?" active":""),label:this.T.Me,onclick:"standardButtonOnClick()"}},display_params:{customer_type_not_set:this.P.isNotset(),customer_unsubscribed:null!==this.ye&&this.ye.hasUnSubscribed(),customer_type_exclude:this.P.isExcluded(),customer_type_included:t&&this.P.isIncluded(),customer_type_organization:t&&this.P.isOrganization(),customer_type_standard:t&&this.P.isDefault(),user_in_sync:i,DEBUG:debug_mode,login_link_HTML:connector.m.b}};r.main_template_form_data=s,switchToHdbsFileTemplate(this.ve?this.m.de:this.m.ce,s)},Z:function(e,i,t,n,s,r,o){try{(0===e.status&&void 0===i||null===i||"error"===i)&&(i="Could not connect to API, Please check your internet connection")}catch(e){}var a={errorResponse:e,overrideMessage:void 0===i||"error"===i?null:i,mainButtonText:void 0===r?"Go Back":r,mainButtonClass:void 0===i||"error"===i?"btn-danger":"btn-warning",mainButtonOnClick:void 0===o?"resetAppIfPageFullyLoaded()":o,additionalButtonText:void 0===t?null:t,additionalButtonClass:void 0===n?null:n,additionalButtonOnclick:void 0===s?null:s};switchToHdbsFileTemplate(this.m.fe,a)},debugButtonOnClick:function(){return console.log("Starting debugButtonOnClick"),console.dir(this),!1},Te:function(i,t,e){var n=null,s=null,r=null;try{n=JSON.parse(i)}catch(e){var o="unknown";o=e instanceof SyntaxError?e.name+" "+e.message:e.message,console.error("JSON Validation for settings '%s' Falied with exception e = %o ",t,e),console.error("JSON TEXT WAS: %o ",i),s=e,r="The JSON Settings text you entered for the "+t+" setting was formatted incorrectly, it must be valid JSON.<br /><br />The failure reason was: "+o+'<br /><br />For help with these settings fields use our <a target="_blank" href="'+this.m.f+'">Zenchimp App Settings Generator</a> spreadsheet'}if(null!==n){for(var a=null,l=e?["checkbox"]:["image","text","checkbox"],u=[],h=0;h<n.length;h++)if((a=n[h]).field_label||u.push("Missing Field/Value: field_label"),a.mailchimp_field||u.push("Missing Field/Value: mailchimp_field"),a.type?l.includes(a.type)||u.push("Invalid type: '"+a.type+"'. Valid types are: "+l.toString()+" (all lower case)"):u.push("Missing Field/Value: type"),e?(void 0!==a.value_if_ticked&&null!==a.value_if_ticked||u.push("Missing Field: value_if_ticked. This is required for fields of type 'checkbox'"),void 0!==a.value_if_unticked&&null!==a.value_if_unticked||u.push("Missing Field: value_if_unticked. This is required for fields of type 'checkbox'")):void 0!==a.default_value&&null!==a.default_value||u.push("Missing Field: default_value"),e&&void 0!==a.zendesk_field&&u.push("Field: zendesk_field is not allowed on mailchimp-only field lists"),e||a.zendesk_field||u.push("Missing Field/Value: zendesk_field"),0<u.length){r="Field Definition "+(h+1)+" for the '"+t+"' setting has errors:<br /><br />"+u.join("<br />");break}if(null===r)return n}this.Z(s,r)}}};