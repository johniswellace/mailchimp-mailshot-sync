<html>
<head>
  <meta charset="utf-8">
  <!-- http://garden.zendesk.com -->
  <!-- <link rel="stylesheet" href="https://assets.zendesk.com/apps/sdk-assets/css/0/zendesk_garden.css" type="text/css"> -->
  <link href="./css/main.css" rel="stylesheet">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" crossorigin="anonymous">
</head>
<body>
    <div class="user_sync_page">
        <div id="page_content"></div>
    </div>

    <footer class="user_sync_footer">
      <a href="https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/issues?q=is%3Aopen+is%3Aissue" target="_blank">Report bug</a> | 
      <a href="https://github.com/up-n-running/ZenChimp-Zendesk-App-Mailchimp-Sync/releases" target="_blank">New Release?</a>
    </footer>
    <!-- https://github.com/zendesk/zendesk_app_framework_sdk -->
    <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>
    
    <script src="./js/lib/handlebars-v4.7.6.min.js"></script>
    <script src="./js/lib/jquery-3.5.1.min.js"></script>
    

    <script src="./js/lib/parse-names.js"></script>
    <script src="./js/lib/md5.js"></script>

    <script src="./js/ZendeskObjects.js"></script>

    <script src="./js/common-utils.js"></script>
    <script src="./js/plugin.js"></script>
    
    <script>
        var parentClient = null;
        var zenChimpPlugin = null;
        var urlParams = 
        
        //thisV2Client.invoke('resize', { width: '100%', height: '400px' });
        thisV2Client.on('app.registered', init);
        
        function init() 
        {
            /* DebugOnlyCode - START */
            if( debug_mode ) 
            { 
                console.group( "POPUP:: init() called" );
                console.log( "init called because of thisV2Client.on('app.registered', init);" );
                console.log( "Parsing URL Params to get context from patent plugin in sidebar;" );
            }
            /* DebugOnlyCode - END */ 
            
            urlParams = parseURLParams(window.location.hash);
             /* DebugOnlyCode - START */
            if( debug_mode ) { console.log( "urlParams = %o\n\nnow fetiching parent client instance with guid urlParams.parent_guid = %o", urlParams.parent_guid ); } 
            /* DebugOnlyCode - END */
            parentClient = getClientInstanceFromGuid(urlParams.parent_guid); //Hopefully this includes the parent_guid we want to send when creating modals

             /* DebugOnlyCode - START */
            if( debug_mode ) { console.log( "Creating plugin instance from PARENT CLIENT: zenChimpPlugin = pluginFactory( parentClient );" ); } 
            /* DebugOnlyCode - END */
            zenChimpPlugin = pluginFactory( parentClient );

            let viewData = { optional_message: 'Loading App...' };
            switchToInlineTemplate(zenChimpPlugin.resources.TEMPLATE_ID_LOADING, viewData);

            /* DebugOnlyCode - START */
            if( debug_mode ) { console.log( "Creating and Initialising plugin.js object:\nzenChimpPlugin.init();" ); } 
            /* DebugOnlyCode - END */

            zenChimpPlugin.init( true, { location: urlParams.parent_location, instanceGuid: urlParams.parent_guid } ); //here we're saying it's modal popup mode and pass in spoofed context object as we cant get it from parent client from modal annoyingly!

            /* DebugOnlyCode - START */  
            if( debug_mode ) 
            { 
                console.log( "Finished init2" );
                console.groupEnd();
            }
            /* DebugOnlyCode - END */ 
        }
        
        function closeButtonOnClick() {
            thisV2Client.invoke('destroy');
            return false;
        }
    </script>
    
    <script id="loading-screen-template" type="text/x-handlebars-template">
        {{#if optional_message}}
        <div class="alert alert-info">
            {{{optional_message}}}
        </div>
        {{/if}}
        <div class="text-center">
            <div class="spinner-grow text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </script>        
</body>
</html>